<!DOCTYPE html>
<!--[if (gt IE 9)|!(IE)]> <!--> <html lang="en" class="no-js hide-messaging hide-ribbon page-interactive section-us  limit-xsmall layout-xlarge"  itemscope xmlns:og="//opengraphprotocol.org/schema/"> <!--<![endif]-->
<!--[if IE 9]> <html lang="en" class="no-js hide-messaging hide-ribbon ie9 lt-ie10 page-interactive section-us  limit-xsmall layout-xlarge" xmlns:og="//opengraphprotocol.org/schema/"> <![endif]-->
<!--[if IE 8]> <html lang="en" class="no-js hide-messaging hide-ribbon ie8 lt-ie10 lt-ie9 page-interactive section-us  limit-xsmall layout-xlarge" xmlns:og="//opengraphprotocol.org/schema/"> <![endif]-->
<!--[if (lt IE 8)]> <html lang="en" class="no-js hide-messaging hide-ribbon lt-ie10 lt-ie9 lt-ie8 page-interactive section-us  limit-xsmall layout-xlarge" xmlns:og="//opengraphprotocol.org/schema/"> <![endif]-->
<head>
    <title>Oklahoma Primary Runoff Election Results 2014 - NYTimes.com</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="robots" content="noarchive" />
    <link rel="shortcut icon" href="https://static01.nyt.com/favicon.ico" />
    <meta name="sourceApp" content="nyt-v5" />
    <meta id="foundation-build-id" name="foundation-build-id" content="20140224-095050" />
    <link rel="canonical" href="oklahoma-runoff" />
    <meta name="hdl" content="Oklahoma Primary Runoff Election Results" />
    <meta name="slug" content="" />
    <meta itemprop="description" name="description" content="Election results for the 2014 Oklahoma runoff primaries." />
    <meta itemprop="inLanguage" content="en-US" />
    <meta property="article:collection" content="https://static01.nyt.com/services/json/sectionfronts/us/index.jsonp" />
    <meta property="article:section" itemprop="articleSection" content="U.S." />
    <meta name="PT" content="Multimedia" />
    <meta name="PST" content="Interactive" />
    <meta name="CG" content="us" />
    <meta name="SCG" content="" />
    <meta name="tom" content="interactive_feature" />
    <meta name="pdate" content="20140506" />
    <meta name="byl" content="" />
    <meta property="og:url" content="//www.nytimes.com/elections/2014/results/primaries/oklahoma-runoff" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Oklahoma Primary Runoff Election Results" />
    <meta property="og:description" content="Election results for the 2014 Oklahoma runoff primaries." />
    <meta property="fb:app_id" content="9869919170" />
    <meta name="twitter:card" value="summary" />
    <meta name="twitter:site" value="@nytimes" />
    <meta property="twitter:url" content="//www.nytimes.com/elections/2014/results/primaries/oklahoma-runoff" />
    <meta property="twitter:title" content="Oklahoma Primary Runoff Election Results" />
    <meta property="twitter:description" content="Election results for the 2014 Oklahoma runoff primaries." />
    <meta name="author" content="" />
    <meta name="og:image" content="https://static01.nyt.com/images/icons/t_logo_291_black.png" />
    <meta name="twitter:image" content="https://static01.nyt.com/images/icons/t_logo_291_black.png" />
    <meta name="des" content="Primaries and Caucuses" />

    <meta name="adxPage" content="elections.nytimes.com/yr/results" />

    
    <link rel="stylesheet" type="text/css" media="screen" href="https://static01.nyt.com/newsgraphics/2014/elections/5952c9a6ff417f4bac9b523052009ff2933e8ee3/page.css" />
    

    <script id="display_overrides">["HIDE_MESSAGING","HIDE_RIBBON"]</script>
    <script>
    var require = {
        baseUrl: 'https://int.nyt.com/assets/',
        waitSeconds: 20,
        paths: {
            'foundation': 'foundation/latest/js/foundation',
            'shared': 'interactive/latest/js/shared',
            'interactive': 'interactive/latest/js/interactive',
            'videoFactory': 'https://static01.nyt.com/js2/build/video/2.0/videofactoryrequire',
            'auth/mtr': 'https://static01.nyt.com/js/mtr',
            'auth/growl': 'https://static01.nyt.com/js/auth/growl/default'
        }
    };
    </script>

    <!--[if (gte IE 9)|!(IE)]> <!-->
    <!-- <script data-main="foundation/main" src="https://int.nyt.com/assets/foundation/latest/js/foundation/lib/framework.js"></script> -->
    <script src="https://static01.nyt.com/newsgraphics/2014/elections/5952c9a6ff417f4bac9b523052009ff2933e8ee3/framework.js"></script>
    <!--<![endif]-->
<!--[if lt IE 9]>
<script>
require.map = { '*': { 'foundation/main': 'foundation/legacy_main' } };
</script>
<script data-main="foundation/legacy_main" src="https://int.nyt.com/assets/foundation/latest/js/foundation/lib/framework.js"></script>
<![endif]-->
<script>
require(['foundation/main'], function () {
    require(['auth/mtr']);
});
</script>
</head>
<body>
    <div id="shell" class="shell">
        <header id="masthead" class="masthead" role="banner">
            <div class="container">
                <div class="quick-navigation button-group">
                    <button class="button sections-button"><i class="icon"></i><span class="button-text">Sections</span></button>
                    <button class="button home-button" data-href="//www.nytimes.com/"><i class="icon"></i><span class="button-text">Home</span></button>
                    <button class="button search-button"><i class="icon"></i><span class="button-text">Search</span></button>
                    <a class="button skip-button skip-to-content visually-hidden focusable" href="#main">Skip to content</a>
                    <a class="button skip-button skip-to-navigation visually-hidden focusable" href="#site-index-navigation">Skip to navigation</a>
                </div><!-- close button-group -->


                <div class="branding">
                    <h2 class="branding-heading">
                        <a href="//www.nytimes.com/">
                            <span class="eln-sprite eln-icon-nyt"></span>
                        </a>
                    </h2>
                </div><!-- close branding -->

                <div class="story-meta">
                    <h6 class="kicker"><span class="kicker-label"><a href="//www.nytimes.com/pages/us/index.html">U.S.</a></span><span class="pipe">|</span>Oklahoma Primary Runoff Election Results</h6>
                </div><!-- close story-meta -->
                <div id="TopNavAd" class="ad top-nav-ad"></div>

                <div class="user-tools">
                    <div id="sharetools-masthead" aria-label="tools" role="group" class="sharetools theme-classic  sharetools-masthead  "
                    data-shares="show-all|Share"
                    data-url="oklahoma-runoff"
                    data-title="Oklahoma Primary Runoff Election Results"
                    data-description="Election results for the 2014 Oklahoma runoff primaries."
                    >
                    <div class="ad sharetools-inline-article-ad hidden">
                    </div>
                </div><!-- close shareTools -->            <div id="Bar1" class="ad user-subscriptions"></div>
                <div class="user-tools-button-group button-group">
                    <button class="button login-button login-modal-trigger hidden">Log In</button>
                    <!-- <button class="button notifications-button hidden"><span class="button-text">0</span></button> -->
                    <button class="button user-settings-button"><i class="icon"></i><span class="button-text">Settings</span></button>
                </div><!-- close user-tools-button-group -->
            </div><!-- close user-tools -->

        </div><!-- close container -->

        <div class="search-flyout-panel flyout-panel">
            <button class="button close-button" type="button"><i class="icon"></i><span class="visually-hidden">Close search</span></button>
            <div class="ad">
                <small class="ad-sponsor">search sponsored by</small>
                <div id="SponsorAd" class="sponsor-ad"></div>
            </div>
            <nav class="search-form-control form-control layout-horizontal">
                <form class="search-form" role="search">
                    <div class="control">
                        <div class="label-container visually-hidden">
                            <label for="search-input">Search NYTimes.com</label>
                        </div>
                        <div class="field-container">
                            <input id="search-input" name="search-input" type="text" class="search-input text" autocomplete="off" placeholder="Search NYTimes.com" />

                            <button type="button" class="button clear-button"><i class="icon"></i><span class="visually-hidden">Clear this text input</span></button>
                            <div class="auto-suggest" style="display: none;">
                                <ol></ol>
                            </div>
                            <button class="button submit-button" type="submit">Go</button>
                        </div>
                    </div><!-- close control -->
                </form>
            </nav>


        </div><!-- close flyout-panel -->

        <div id="notification-modals" class="notification-modals"></div>
        <span class="story-short-url"><a href="//nyti.ms/1gRqAUM">//nyti.ms/1gRqAUM</a></span></header>
        <nav id="ribbon" class="ribbon ribbon-start nocontent robots-nocontent" aria-hidden="true">
            <ol class="ribbon-menu">
                <li class="collection ribbon-loader">
                    <div class="loader"><span class="visually-hidden">Loading...</span></div>
                </li>
            </ol>
            <div class="ribbon-navigation-container">
                <nav class="ribbon-navigation next">
                    <span class="visually-hidden">See next articles</span>
                    <div class="arrow arrow-right">
                        <div class="arrow-conceal"></div>
                    </div>
                </nav>
                <nav class="ribbon-navigation previous">
                    <span class="visually-hidden">See previous articles</span>
                    <div class="arrow arrow-left">
                        <div class="arrow-conceal"></div>
                    </div>
                </nav>
            </div>
        </nav>
        <nav id="navigation" class="navigation"></nav>
        <nav id="navigation-modal" class="navigation-modal"></nav>
        <div id="navigation-edge" class="navigation-edge"></div>
        <main id="main" class="main" role="main">
            <!-- <div id="TopAd" class="ad top-ad"></div> -->
            <article id="story" class="story theme-main theme-interactive">
                <header class="story-header interactive-header">
                    <div class="story-meta">
                        <div class="kicker-container">

                         <div id="sharetools-interactive" aria-label="tools" role="group" class="sharetools theme-classic  sharetools-interactive"
                            data-shares="show-all|Share"
                            data-url="oklahoma-runoff"
                            data-title="Oklahoma Primary Runoff Election Results"
                            data-description="Election results for the 2014 Oklahoma runoff primaries."
                            >
                            <div class="ad sharetools-inline-article-ad hidden"></div>
                        </div><!-- close shareTools -->

                        <div class="eln-navigation clearfix">
	<a href="../../calendar">
		<div class="eln-navigation-logo">
			<div class="eln-sprite eln-icon-ballot"></div>
			<div class="eln-sprite eln-icon-election-2014 hidden-phone"></div>
		</div>
	</a>
	<div class="eln-navigation-menu">
		<a class="eln-navigation-link" href="arizona">Arizona</a>
		<a class="eln-navigation-link" href="florida">Florida</a>
		<a class="eln-navigation-link" href="vermont">Vermont</a>
		<a class="eln-navigation-link" href="oklahoma-runoff">Oklahoma runoff</a>
	</div>
</div>


                        </div>

                    <h1 class="story-heading interactive-headline" itemprop="headline">
                        Oklahoma Primary Runoff Election Results
                    </h1>
                    
                        <div class="eln-datetime">
                        <span class="eln-timestamp"></span>
                        </div>

                    



                    </div><!-- close story-meta -->
                </header>
            <div id="" class="interactive-graphic">


	

	<div id="eln-primary-page" data-url="//int.nyt.com/data/elections/2014/primaries/ok-runoff/races.json" class="eln-base eln-primary-page eln-style-show-others-rollup  ">

	  
			<div class="g-stub">
				<em>Loading results...</em>
			</div>
	  
	</div>

	<script>
	  var data = {"dictionary":{"what-to-watch":"What to Watch","featured-races":"Notable Races","statewide-races":"Statewide Races","other-statewide-races":"Other Statewide Races","senate":"U.S. Senate","senate-special":"Special U.S. Senate Election","governor":"Governor","lieutenant-governor":"Lt. Governor","lt-governor":"Lieutenant Governor","attorney-general":"Attorney General","sec-state":"Secretary of State","secretary-of-state":"Secretary of State","auditor":"Auditor","comptroller":"Comptroller","treasurer":"Treasurer","agriculture-commissioner":"Agriculture Commissioner","corporation-commissioner":"Corporation Commissioner","insurance-commissioner":"Insurance Commissioner","labor-commissioner":"Labor Commissioner","land-commissioner":"Land Commissioner","land-commisioner":"Land Commissioner","railroad-commissioner":"Railroad Commissioner","school-superintendent":"School Superintendent","agriculture-secretary":"Secretary of Agriculture","superintendent":"Superintendent of Public Instruction","state-board-of-education":"State Board of Education","supreme-court":"State Supreme Court","superintendent-public-instruction":"Superintendent of Public Instruction","tax-commissioner":"Tax Commissioner","mine-inspector":"Mine Inspector","initiative":"Ballot Initiatives","ballot-initiative":"Ballot Initiatives","house":"U.S. House","house_special":"Special U.S. House Elections","house-special":"Special U.S. House Elections"},"branches":{"what-to-watch":{"category":"","race_title":"What to Watch","state_slug":"*","race_slug":"what-to-watch","index":20},"featured-races":{"category":"","race_title":"Notable Races","state_slug":"*","race_slug":"featured-races","index":21},"statewide-races":{"category":"","race_title":"Statewide Races","state_slug":"*","race_slug":"statewide-races","index":22},"other-statewide-races":{"category":"","race_title":"Other Statewide Races","state_slug":"*","race_slug":"other-statewide-races","index":23},"senate":{"category":"statewide-races","race_title":"U.S. Senate","state_slug":"*","race_slug":"senate","index":24},"senate-special":{"category":"statewide-races","race_title":"Special U.S. Senate Election","state_slug":"*","race_slug":"senate-special","index":25},"governor":{"category":"statewide-races","race_title":"Governor","state_slug":"*","race_slug":"governor","index":26},"lieutenant-governor":{"category":"statewide-races","race_title":"Lt. Governor","state_slug":"*","race_slug":"lieutenant-governor","index":27},"lt-governor":{"category":"statewide-races","race_title":"Lieutenant Governor","state_slug":"*","race_slug":"lt-governor","index":28},"attorney-general":{"category":"statewide-races","race_title":"Attorney General","state_slug":"*","race_slug":"attorney-general","index":29},"sec-state":{"category":"statewide-races","race_title":"Secretary of State","state_slug":"*","race_slug":"sec-state","index":30},"secretary-of-state":{"category":"statewide-races","race_title":"Secretary of State","state_slug":"*","race_slug":"secretary-of-state","index":31},"auditor":{"category":"statewide-races","race_title":"Auditor","state_slug":"*","race_slug":"auditor","index":32},"comptroller":{"category":"statewide-races","race_title":"Comptroller","state_slug":"*","race_slug":"comptroller","index":33},"treasurer":{"category":"statewide-races","race_title":"Treasurer","state_slug":"*","race_slug":"treasurer","index":34},"agriculture-commissioner":{"category":"statewide-races","race_title":"Agriculture Commissioner","state_slug":"*","race_slug":"agriculture-commissioner","index":35},"corporation-commissioner":{"category":"statewide-races","race_title":"Corporation Commissioner","state_slug":"*","race_slug":"corporation-commissioner","index":36},"insurance-commissioner":{"category":"statewide-races","race_title":"Insurance Commissioner","state_slug":"*","race_slug":"insurance-commissioner","index":37},"labor-commissioner":{"category":"statewide-races","race_title":"Labor Commissioner","state_slug":"*","race_slug":"labor-commissioner","index":38},"land-commissioner":{"category":"statewide-races","race_title":"Land Commissioner","state_slug":"*","race_slug":"land-commissioner","index":39},"land-commisioner":{"category":"statewide-races","race_title":"Land Commissioner","state_slug":"*","race_slug":"land-commisioner","index":40},"railroad-commissioner":{"category":"statewide-races","race_title":"Railroad Commissioner","state_slug":"*","race_slug":"railroad-commissioner","index":41},"school-superintendent":{"category":"statewide-races","race_title":"School Superintendent","state_slug":"*","race_slug":"school-superintendent","index":42},"agriculture-secretary":{"category":"statewide-races","race_title":"Secretary of Agriculture","state_slug":"*","race_slug":"agriculture-secretary","index":43},"superintendent":{"category":"statewide-races","race_title":"Superintendent of Public Instruction","state_slug":"*","race_slug":"superintendent","index":44},"state-board-of-education":{"category":"statewide-races","race_title":"State Board of Education","state_slug":"*","race_slug":"state-board-of-education","index":45},"supreme-court":{"category":"statewide-races","race_title":"State Supreme Court","state_slug":"*","race_slug":"supreme-court","index":46},"superintendent-public-instruction":{"category":"statewide-races","race_title":"Superintendent of Public Instruction","state_slug":"*","race_slug":"superintendent-public-instruction","index":47},"tax-commissioner":{"category":"statewide-races","race_title":"Tax Commissioner","state_slug":"*","race_slug":"tax-commissioner","index":48},"mine-inspector":{"category":"statewide-races","race_title":"Mine Inspector","state_slug":"*","race_slug":"mine-inspector","index":49},"initiative":{"category":"initiative","race_title":"Ballot Initiatives","state_slug":"*","race_slug":"initiative","index":50},"ballot-initiative":{"category":"initiative","race_title":"Ballot Initiatives","state_slug":"*","race_slug":"ballot-initiative","index":51},"house":{"category":"","race_title":"U.S. House","state_slug":"*","race_slug":"house","index":52},"house_special":{"category":"","race_title":"Special U.S. House Elections","state_slug":"*","race_slug":"house_special","index":53},"house-special":{"category":"","race_title":"Special U.S. House Elections","state_slug":"*","race_slug":"house-special","index":54}},"race_settings":{"ok-senate-class-iii-2014-primary":{"category":"what-to-watch","title":"","race_id":"ok-senate-class-iii-2014-primary","map_url":"","map":"REP","description":"","map_colors":"lankford, shannon, brogdon, mccray, crow, weger, craig","parties":"REP","colors":{"REP":{"lankford":"#F7C265","shannon":"#9FD18F","brogdon":"#D67185","mccray":"#8E83B8","crow":"#FEF6A7","weger":"#FED8AE","craig":"#CDACD1"}},"index":14}},"race":{"abbr":"OK","map_url":"//int.nyt.com/data/elections/2014/primaries/ok-runoff/map/{{race_id}}.json","map_width":"","map_height":"","parties":"","election_date":"20140826","state_abbr":"OK","ic_url":"https://int.nyt.com/data/ic/","ic_state_url":"/interactive/projects/ic/state.json","enable_websockets":true,"environment":"production","state_slug":"oklahoma-runoff"}};
	  var NYTG_ASSETS = "https://static01.nyt.com/newsgraphics/2014/elections/5952c9a6ff417f4bac9b523052009ff2933e8ee3/";
	  var NYTG_BIG_ASSETS = "https://static01.nyt.com/newsgraphics/2014/elections/assets/";
	  _gaq = [['_setAccount', 'UA-9262032-1']];
	</script>

	<!-- basic results -->
	<script>
		
define('build/templates',[],function(){

  this["templates"] = this["templates"] || {};

  this["templates"]["jst/hub_content"] = function(obj) {obj || (obj = {});var __t, __p = '', __e = _.escape, __j = Array.prototype.join;function print() { __p += __j.call(arguments, '') }with (obj) { _.each(data.races, function(race) { ;__p += '\t<div class="eln-hub-race clearfix"> <h2 class="eln-hub-race-title">' +((__t = ( race.race_title )) == null ? '' : __t) +'</h2> <div class="eln-hub-table"> ' +((__t = ( templates['jst/results_table']({ race: race.results, templates: templates, options: { small_checkmark: true, short_names: true, max_candidates: 3, hide_party_label: true } }) )) == null ? '' : __t) +' </div> <div class="eln-hub-map"> <div class="eln-state-map" data-map-width="' +((__t = ( race.map_width )) == null ? '' : __t) +'" data-map-height="' +((__t = ( race.map_height )) == null ? '' : __t) +'" data-map-state="' +((__t = ( race.state_abbr.toUpperCase() )) == null ? '' : __t) +'" '; if (race.map_colors) { ;__p += ' data-map-party="' +((__t = ( race.party_id )) == null ? '' : __t) +'" data-map-colors=' +((__t = ( JSON.stringify(race.map_colors) )) == null ? '' : __t) +' '; } ;__p += ' data-map-data-url="' +((__t = ( race.map_url.replace('{{race_id}}', race.race_id) )) == null ? '' : __t) +'"></div> </div>\t</div>'; }) ;}return __p};

  this["templates"]["jst/page_content"] = function(obj) {obj || (obj = {});var __t, __p = '', __e = _.escape, __j = Array.prototype.join;function print() { __p += __j.call(arguments, '') }with (obj) { _.each(data.result_groups, function(group, group_key) { ;__p += ' <div class="eln-group"> '; if (!group.whatToWatch) { ;__p += ' <h2 class="eln-group-title">' +((__t = ( group.title )) == null ? '' : __t) +'</h2> '; } ;__p += ' '; _.each(group.races, function(race, race_index) { ;__p += ' '; var context = { last: race_index + 1 == group.races.length } ;__p += ' '; var sample_race = race["DEM"] || race["REP"] || race["OTH"]; ;__p += ' <div class="eln-primary-row clearfix ' +((__t = ( context.last ? 'eln-primary-row-last' : '' )) == null ? '' : __t) +' category-' +((__t = ( group.category )) == null ? '' : __t) +' "> '; if (!group.whatToWatch) { ;__p += ' <div class="eln-primary-row-meta"> <h3 class="eln-primary-row-title"> ' +((__t = ( race.settings.title )) == null ? '' : __t) +'</h3> <div class="eln-primary-row-description">' +((__t = ( race.settings.description )) == null ? '' : __t) +'</div> </div> '; } ;__p += ' <div class="eln-primary-cols"> '; var parties = (race.settings.parties || data.race.parties || "DEM|REP").split("|"); ;__p += ' '; _.each(parties, function(party, party_index) { ;__p += ' '; var race_data = race[party] ;__p += ' <div class="eln-primary-col eln-primary-col-' +((__t = ( party.toLowerCase() )) == null ? '' : __t) +'"> '; if (group.whatToWatch) { ;__p += ' <div class="eln-what-to-watch-meta"> '; if (party_index == 0) { ;__p += ' <h3 class="eln-primary-row-title">' +((__t = ( race.settings.title )) == null ? '' : __t) +' </h3> '; } ;__p += ' <div class="eln-what-to-watch-description"> ' +((__t = ( race.settings.description.split("|")[party_index] )) == null ? '' : __t) +' </div> </div> '; } ;__p += ' '; if (race_data) { ;__p += ' <div class="eln-race-column"> ' +((__t = ( templates["jst/results_table"]({ race: race_data, options: { results_expander: true, force_zeroes: options.force_zeroes, show_bars: group.whatToWatch || group.show_bars }, templates: templates }) )) == null ? '' : __t) +' '; if (race.settings.map) { ;__p += ' <div '; if (race_data.id == 'va-house-district-7-2014-primary-rep') { ;__p += 'id="va-house-7-results"'; } ;__p += 'class="eln-state-map" data-map-width="' +((__t = ( data.race.map_width )) == null ? '' : __t) +'" data-map-height="' +((__t = ( data.race.map_height )) == null ? '' : __t) +'" data-map-state="' +((__t = ( data.race.abbr.toUpperCase() )) == null ? '' : __t) +'" '; if (race.settings.colors) { ;__p += ' data-map-party="' +((__t = ( party )) == null ? '' : __t) +'" data-map-colors=' +((__t = ( JSON.stringify(race.settings.colors[party]) )) == null ? '' : __t) +' '; } ;__p += ' '; if (race_data.id == 'va-house-district-7-2014-primary-rep') { ;__p += ' data-topojson-file="' +((__t = ( NYTG_BIG_ASSETS + 'house-va-7.json' )) == null ? '' : __t) +'" '; } ;__p += ' data-map-data-url="' +((__t = ( data.race.map_url.replace('{{race_id}}', race_data.id) )) == null ? '' : __t) +'"></div> '; } ;__p += ' '; if (race_data.id == 'va-house-district-7-2014-primary-rep') { ;__p += ' <div id="va-house-7-outline" class="eln-state-map" data-map-width="' +((__t = ( data.race.map_width )) == null ? '' : __t) +'" data-map-height="' +((__t = ( data.race.map_height )) == null ? '' : __t) +'" data-map-state="' +((__t = ( data.race.abbr.toUpperCase() )) == null ? '' : __t) +'" data-map-colors=\'{"cantor":"#e2e2e2","brat":"#e2e2e2"}\' data-moveme=\'yes\' data-map-data-url="' +((__t = ( data.race.map_url.replace('{{race_id}}', race_data.id) )) == null ? '' : __t) +'"></div> '; } ;__p += ' </div> '; } else { ;__p += ' '; if (data.race.state_slug.indexOf('runoff') > -1) { ;__p += ' '; if (party == "DEM") { ;__p += ' <div class="eln-note eln-note-uncontested">No Democratic runoff for this seat.</div> '; } else if (party == "REP") { ;__p += ' <div class="eln-note eln-note-uncontested">No Republican runoff for this seat.</div> '; } ;__p += ' '; } else { ;__p += ' '; if (party == "DEM") { ;__p += ' <div class="eln-note eln-note-uncontested">No Democratic primary for this seat.</div> '; } else if (party == "REP") { ;__p += ' <div class="eln-note eln-note-uncontested">No Republican primary for this seat.</div> '; } ;__p += ' '; } ;__p += ' '; } ;__p += ' </div> '; }) ;__p += ' </div>  </div>  '; }); ;__p += ' </div>  '; }); ;}return __p};

  this["templates"]["jst/results_table"] = function(obj) {obj || (obj = {});var __t, __p = '', __e = _.escape, __j = Array.prototype.join;function print() { __p += __j.call(arguments, '') }with (obj) { candidates = race.results ; has_incumbent = _.find(candidates, function(candidate) { return candidate.incumbent }) ;__p += '<div class="eln-base eln-race-container ' +((__t = ( race.contest_type != "Primary" ? 'eln-phase-primary' : '' )) == null ? '' : __t) +' '; /* race.id */ ;__p += ' ' +((__t = ( race.uncontested ? 'eln-uncontested' : '' )) == null ? '' : __t) +' '; /* context.first ? 'eln-first' : '' */ ;__p += ' '; /* context.index ? 'eln-second' : '' */ ;__p += ' '; /* context.last ? 'eln-last' : '' */ ;__p += ' ' +((__t = ( (race.report_votes && race.loading) ? 'eln-votes-live' : '' )) == null ? '' : __t) +' ' +((__t = ( (race.report_votes && !race.loading) ? 'eln-votes-complete' : '' )) == null ? '' : __t) +'" '; if (options.fullbody_link) { ;__p += ' data-eln-url="' +((__t = ( options.link )) == null ? '' : __t) +'" '; } ;__p += ' > '; if (options.title) { ;__p += ' <h2 class="eln-widget-title"> '; if (options.link) { ;__p += ' <a href="' +((__t = ( options.link )) == null ? '' : __t) +'"> '; } ;__p += ' <span>' +((__t = ( options.title )) == null ? '' : __t) +'</span> '; if (options.link) { ;__p += ' </a> '; } ;__p += ' </h2> '; } ;__p += ' <div class="eln-update-container clearfix ' +((__t = ( !race.report_votes ? 'eln-polls-open' : '' )) == null ? '' : __t) +' ' +((__t = ( race.called && !options.force_zeroes ? 'eln-race-called' : '' )) == null ? '' : __t) +' ' +((__t = ( race.runoff_declared ? 'eln-runoff-declared' : '' )) == null ? '' : __t) +' "> '; /* if (options.titles) { ;__p += ' <div class="eln-race-title"> <a href="' +((__t = ( options.race_links[race['id']] || '#' )) == null ? '' : __t) +'"> ' +((__t = ( options.titles[race["id"]] )) == null ? '' : __t) +' &raquo; </a> </div> '; } */ ;__p += ' '; /* if (options.touch) { ;__p += ' <a href="' +((__t = ( options.race_links[race['id']] || '#' )) == null ? '' : __t) +'"> '; } */ ;__p += ' <table class="eln-results-table" cellspacing="0"> <thead> <tr> <th class="eln-th eln-cell eln-col-name"> '; if (race.branch == 'initiative' || race.branch == 'supreme-court') { ;__p += ' Answer '; } else if (race.party_id == "DEM") { ;__p += ' '; if (options.show_party_plural) { ;__p += ' Democrats '; } else { ;__p += ' ' +((__t = ( (options.hide_party_label) ? '' : 'Democratic' )) == null ? '' : __t) +' candidate '; } ;__p += ' '; } else if (race.party_id == "REP") { ;__p += ' '; if (options.show_party_plural) { ;__p += ' Republicans '; } else { ;__p += ' ' +((__t = ( (options.hide_party_label) ? '' : 'Republican' )) == null ? '' : __t) +' candidate '; } ;__p += ' '; } else { ;__p += ' candidate '; } ;__p += ' </th> '; if (race.contest_type != "Primary" && race.branch != 'initiative' && race.branch != "supreme-court") { ;__p += ' <th class="eln-th eln-cell eln-col-party"> Party </th> '; } ;__p += ' '; if (!race.uncontested) { ;__p += ' <th class="eln-th eln-cell eln-col-votes"> Votes </th> <th class="eln-th eln-cell eln-col-pct"> Pct.<span class="eln-symbol">%</span> </th> '; } ;__p += ' </tr> </thead> '; if (!options.dynamic) { ;__p += ' ' +((__t = ( templates["jst/results_table_body"]({ race: race, candidates: candidates, options: options }) )) == null ? '' : __t) +' '; } else { ;__p += ' <tbody></tbody> '; } ;__p += ' </table> '; /* if (options.touch) { ;__p += ' </a> '; } */ ;__p += ' <div class="eln-update-notes"> '; if (!race.uncontested) { ;__p += ' <span class="eln-note eln-note-reporting"> '; if (race["report_votes"]) { ;__p += ' ' +((__t = ( race['precincts_reporting_display'] )) == null ? '' : __t) +'% reporting '; } else { ;__p += ' '; } ;__p += ' </span> '; } ;__p += ' '; if (options.live_url) { ;__p += ' <span class="eln-view-details"> <a href="' +((__t = ( options.live_url )) == null ? '' : __t) +'">Full Results &raquo;</a> </span> '; } ;__p += ' '; if (has_incumbent) { ;__p += ' <div class="eln-note eln-note-incumbent">*Incumbent</div> '; } ;__p += ' '; if (race.runoff_declared && !options.force_zeroes) { ;__p += ' <div class="eln-note eln-note-runoff"> <div class="eln-swatch-small eln-swatch-neutral"> <span class="eln-sprite eln-icon-checkmark-small"></span> </div>Will advance <span class=\'eln-note-runoff-extended\'>to runoff</span> </div> '; } ;__p += ' </div> </div> <!-- } eln-update-container --></div>';}return __p};

  this["templates"]["jst/results_table_body"] = function(obj) {obj || (obj = {});var __t, __p = '', __e = _.escape, __j = Array.prototype.join;function print() { __p += __j.call(arguments, '') }with (obj) {__p += '<tbody>'; var context = {} ; _.each(candidates, function(c, index) { ;__p += ' '; context.index = index + 1; context.first = (index == 0); context.last = (index + 1 == candidates.length); if (options.max_candidates) { if (index >= options.max_candidates) { return; } } if (options.results_expander && context.index > 4 && !options.max_candidates) { var hide_candidate = true; } var colspan = (options.show_bars && race.state_id == "CA") ? 5 : 3; if (options.show_bars && colspan == 3) colspan = 4; ;__p += ' <tr class="eln-candidate ' +((__t = ( (c.nyt_winner && !options.force_zeroes) ? 'eln-candidate-winner' : '' )) == null ? '' : __t) +' '; /* (context.first && !c.nyt_winner && c.vote_count > 0 && race.contest_type != "Primary") ? 'eln-candidate-leader' : '' */;__p += ' ' +((__t = ( c.advanced_to_runoff && !options.force_zeroes ? 'eln-candidate-runoff' : '' )) == null ? '' : __t) +' '; /* c.incumbent ? 'eln-candidate-incumbent' : '' */;__p += ' ' +((__t = ( c.party_id == 'REP' ? 'eln-candidate-rep' : '' )) == null ? '' : __t) +' ' +((__t = ( c.party_id == 'DEM' ? 'eln-candidate-dem' : '' )) == null ? '' : __t) +' ' +((__t = ( c.party_id == 'Grn' ? 'eln-candidate-green' : '' )) == null ? '' : __t) +' '; /* (context.index > 4) ? 'eln-candidate-secondary' : '' */ ;__p += ' ' +((__t = ( context.first ? 'eln-first-row' : '' )) == null ? '' : __t) +' ' +((__t = ( context.last ? 'eln-last-row' : '' )) == null ? '' : __t) +' '; /* 'eln-results-row' */;__p += ' '; /* 'eln-results-row-' + context.index */;__p += ' '; /* c.ap_candidate_id == "special_other" ? 'eln-others-row' : '' */ ;__p += ' ' +((__t = ( hide_candidate ? 'eln-candidate-secondary' : '' )) == null ? '' : __t) +' "> <td class="eln-cell eln-col-name eln-name '; if (c.party_id == 'REP') { ;__p += ' eln-name-rep '; } else if (c.party_id == 'DEM') { ;__p += ' eln-name-dem '; } else if (c.last_name == 'Yes') { ;__p += 'eln-name-yes '; } else if (c.last_name == 'No') { ;__p += ' eln-name-no '; } else { ;__p += 'eln-name-ind '; } ;__p += ' "> '; if ((race.contest_type != "Open Primary" && race.contest_type != "Primary" && race.contest_type != "General Election" && race.branch != "initiative" && race.branch != "supreme-court") || (c.nyt_winner && !options.force_zeroes) || (c.advanced_to_runoff && !options.force_zeroes) || (race.report_votes && c._swatch_color) ) { ;__p += ' <span class=" eln-swatch '; if (c._swatch_color) { ;__p += ' '; } else if (c.party_id == 'REP') { ;__p += ' eln-swatch-rep '; } else if (c.party_id == 'DEM') { ;__p += ' eln-swatch-dem '; } else if (c.last_name == 'Yes') { ;__p += 'eln-swatch-yes '; } else if (c.last_name == 'No') { ;__p += ' eln-swatch-no '; } else { ;__p += 'eln-swatch-ind '; } ;__p += '" ' +((__t = ( c._swatch_color ? 'style="background-color:'+ c._swatch_color + '"' : '' )) == null ? '' : __t) +' > '; if (c.nyt_winner || c.advanced_to_runoff) { ;__p += ' '; if (options.small_checkmark) { ;__p += ' <span class="eln-sprite eln-icon-checkmark-small"></span> '; } else { ;__p += ' <span class="eln-sprite eln-icon-checkmark"></span> '; } ;__p += ' '; } ;__p += ' </span> '; } ;__p += ' '; if (options.short_names) { ;__p += ' <span class="eln-name-short">' +((__t = ( c.last_name )) == null ? '' : __t) +'</span> '; } else { ;__p += ' <span class="eln-name-long">' +((__t = ( c.name )) == null ? '' : __t) +'</span> '; } ;__p += ' '; if (c.ap_candidate_id == "special_other") { ;__p += ' <div class="eln-expander"> <div class="eln-expander-show"> Show All <div class="eln-sprite eln-icon-showall"></div> </div> <div class="eln-expander-hide"> Collapse <div class="eln-sprite eln-icon-hide"></div> </div> </div> '; } ;__p += ' '; if (c.incumbent && !options.hide_incumbency && race.branch != "supreme-court") { ;__p += ' <span class="eln-incumbent-marker">*</span> <span class="eln-pill eln-incumbent-pill">Incumbent</span> '; } ;__p += ' '; if (race.uncontested) { ;__p += ' <span class="eln-pill">Uncontested</span> '; } ;__p += ' </td> '; if (race.contest_type != "Primary" && race.branch != "initiative" && race.branch != "supreme-court") { ;__p += ' <td class="eln-cell eln-col-party"> <span title="' +((__t = ( c.party_name )) == null ? '' : __t) +'" class="eln-party-short">' +((__t = ( c.party_display )) == null ? '' : __t) +'</span> </td> '; } ;__p += ' '; if (!race.uncontested) { ;__p += ' <td class="eln-cell eln-col-votes eln-votes eln-numeric"> '; if (race.report_votes && !race.uncontested) { ;__p += ' ' +((__t = ( c.vote_count_display )) == null ? '' : __t) +' '; } else if (race.report_votes && race.uncontested) { ;__p += ' '; } else { ;__p += ' &mdash; '; } ;__p += ' </td> <td class="eln-cell eln-col-pct eln-pct eln-numeric"> '; if (race.report_votes && !race.uncontested) { ;__p += ' ' +((__t = ( c.vote_pct_display )) == null ? '' : __t) +'<span class="eln-symbol">%</span> '; } else if (race.report_votes && race.uncontested) { ;__p += ' '; } else { ;__p += ' &mdash;<span class="eln-symbol">%</span> '; } ;__p += ' </td> '; if (options.show_bars) { ;__p += ' <td class="eln-results-bar-cell eln-cell"> '; if (race.report_votes) { ;__p += ' <div class="eln-results-bar-container"> <div class="eln-results-bar '; if (c._swatch_color || true) { ;__p += ' '; } else if (c.party_id == 'DEM') { ;__p += ' eln-swatch-dem '; } else if (c.party_id == 'REP') { ;__p += ' eln-swatch-rep '; } else if (c.party_id == 'Ind') { ;__p += ' eln-swatch-ind '; } ;__p += ' " style="width: ' +((__t = ( c.vote_pct_display )) == null ? '' : __t) +'%; "></div> </div> '; } ;__p += ' </td> '; } ;__p += ' '; } ;__p += ' </tr> '; if (options.results_expander && context.last && !options.max_candidates && candidates.length > 4) { ;__p += ' <tr class="eln-candidate eln-expander"> <td class="eln-cell" colspan="' +((__t = ( colspan )) == null ? '' : __t) +'"> <div class="eln-expander-showall"> <div class="eln-sprite eln-icon-showall"></div> Show All </div> <div class="eln-expander-hide"> <div class="eln-sprite eln-icon-hide"></div> Hide </div> </td> </tr> '; } ; }) ;__p += '</tbody>';}return __p};

  this["templates"]["jst/results_widget"] = function(obj) {obj || (obj = {});var __t, __p = '', __e = _.escape;with (obj) {__p += '<div class="eln-widget-results"> ' +((__t = ( templates['jst/results_table']({ race: race, templates: templates, options: options }) )) == null ? '' : __t) +'</div>';}return __p};

  this["templates"]["jst/tweet"] = function(obj) {obj || (obj = {});var __t, __p = '', __e = _.escape, __j = Array.prototype.join;function print() { __p += __j.call(arguments, '') }with (obj) {__p += '<div id="' +((__t = ( id_str )) == null ? '' : __t) +'" class="eln-entry ' +((__t = ( is_new ? 'eln-entry-new' : '' )) == null ? '' : __t) +'">\t<div class="eln-entry-meta"> <a class="eln-entry-timestamp" href="//twitter.com/statuses/' +((__t = ( id_str )) == null ? '' : __t) +'">' +((__t = ( timestamp )) == null ? '' : __t) +'</a>\t</div>\t<div class="eln-entry-content clearfix"> <div class="eln-entry-text">' +((__t = ( html )) == null ? '' : __t) +'</div> <div class="eln-entry-author"> <span class="eln-entry-name">â€” ' +((__t = ( user.name )) == null ? '' : __t) +'</span> <a class="eln-entry-screen-name" href="//twitter.com/' +((__t = ( user.screen_name )) == null ? '' : __t) +'">@' +((__t = ( user.screen_name )) == null ? '' : __t) +'</a> <span class="g-middot"></span> <a class="eln-entry-timestamp" href="//twitter.com/statuses/' +((__t = ( id_str )) == null ? '' : __t) +'">' +((__t = ( timestamp )) == null ? '' : __t) +'</a> </div> '; if (show_map && race) { ;__p += ' <div class="eln-hub-map eln-entry-map-container"> <div class="eln-state-map" data-map-width="' +((__t = ( race.map_width )) == null ? '' : __t) +'" data-map-height="' +((__t = ( race.map_height )) == null ? '' : __t) +'" data-map-state="' +((__t = ( geo.state_abbr.toUpperCase() )) == null ? '' : __t) +'" data-map-fips="' +((__t = ( race.map_fips )) == null ? '' : __t) +'" '; if (race.map_colors) { ;__p += ' data-map-party="' +((__t = ( race.party_id )) == null ? '' : __t) +'" data-map-radius="' +((__t = ( geo.radius )) == null ? '' : __t) +'" data-map-lat="' +((__t = ( geo.lat )) == null ? '' : __t) +'" data-map-lng="' +((__t = ( geo.lng )) == null ? '' : __t) +'" data-map-geoid="' +((__t = ( geo.geo_id )) == null ? '' : __t) +'" data-map-colors=' +((__t = ( JSON.stringify(race.map_colors) )) == null ? '' : __t) +' '; } ;__p += ' data-map-data-url="' +((__t = ( race.map_url.replace('{{race_id}}', race.race_id) )) == null ? '' : __t) +'"></div> </div> '; } ;__p += '\t</div></div>';}return __p};

  this["templates"]["jst/vote_comparison"] = function(obj) {obj || (obj = {});var __t, __p = '', __e = _.escape, __j = Array.prototype.join;function print() { __p += __j.call(arguments, '') }with (obj) {__p += '<h2 class="eln-hub-race-title">How the Vote Has Changed From the June 3 Primary</h2><p class="eln-vote-comparison-description">In counties with 100% of precincts reporting:</p><!-- <span class="eln-swatch-mcdaniel"></span> <span class="eln-swatch-cochran"></span> --><ul>\t<li>McDaniel has '; if (candidates.mcdaniel.change > 0) { ;__p += ' ' +((__t = ( numberWithCommas(candidates.mcdaniel.change) )) == null ? '' : __t) +' more votes than '; } else if (candidates.mcdaniel.change < 0) { ;__p += ' ' +((__t = ( numberWithCommas(candidates.mcdaniel.change) )) == null ? '' : __t) +' fewer votes than '; } else if (candidates.mcdaniel.change == 0) { ;__p += ' the same number of votes as '; } ;__p += ' last time\t</li>\t<li>Cochran has '; if (candidates.cochran.change > 0) { ;__p += ' ' +((__t = ( numberWithCommas(candidates.cochran.change) )) == null ? '' : __t) +' more votes than '; } else if (candidates.cochran.change < 0) { ;__p += ' ' +((__t = ( numberWithCommas(candidates.cochran.change) )) == null ? '' : __t) +' fewer votes than '; } else if (candidates.cochran.change == 0) { ;__p += ' the same number of votes as '; } ;__p += ' last time\t</li></ul><!-- <p class="eln-vote-comparison-description">Last time, McDaniel received 1,418 more votes than Cochran.</p> --><a class="eln-show-counties">\t<span class=\'eln-show-label\'>Show Details for Completed Counties <span class="eln-sprite eln-icon-showall"></span></span>\t<span class=\'eln-hide-label\'>Hide Details for Completed Counties <span class="eln-sprite eln-icon-hide"></span></span></a><div class="eln-counties"><table class="eln-compare-details">\t<thead> <tr> <th></th> <!-- <th></th> --> <th colspan=2 class="eln-compare-candidate eln-mcdaniel"> <div class="eln-candidate-border">McDaniel</div> </th> <th colspan=2 class="eln-compare-candidate eln-cochran"> <div class="eln-candidate-border">Cochran</div> </th> </tr> <tr> <th class="eln-compare-name"></th> <!-- <th>Rpt.</th> --> <th>June 4</th> <th>June 24</th> <th class="eln-hide-col">Change</th> <th>June 4</th> <th>June 24</th> <th class="eln-hide-col">Change</th> </tr>\t</thead>\t<tbody> <tr> <td class="eln-compare-name">Total</td> <td>' +((__t = ( numberWithCommas(candidates.mcdaniel.oldTotal) )) == null ? '' : __t) +'</td> <td>' +((__t = ( numberWithCommas(candidates.mcdaniel.newTotal) )) == null ? '' : __t) +'</td> <td class="eln-hide-col">' +((__t = ( (candidates.mcdaniel.change <= 0 ? "" : "+") + numberWithCommas(candidates.mcdaniel.change) )) == null ? '' : __t) +'</td> <td>' +((__t = ( numberWithCommas(candidates.cochran.oldTotal) )) == null ? '' : __t) +'</td> <td>' +((__t = ( numberWithCommas(candidates.cochran.newTotal) )) == null ? '' : __t) +'</td> <td class="eln-hide-col">' +((__t = ( (candidates.cochran.change <= 0 ? "" : "+") + numberWithCommas(candidates.cochran.change) )) == null ? '' : __t) +'</td> </tr> '; _.each(geographies, function(geography) { ;__p += ' <tr> <td class="eln-compare-name">' +((__t = ( geography.newer.name )) == null ? '' : __t) +'</td> <!-- <td>' +((__t = ( pctReporting(geography.newer.reporting, geography.newer.precincts, geography.newer.votes) )) == null ? '' : __t) +'%</td> --> <td>' +((__t = ( numberWithCommas(geography.older.mcdaniel) )) == null ? '' : __t) +'</td> <td>' +((__t = ( numberWithCommas(geography.newer.mcdaniel) )) == null ? '' : __t) +'</td> <td class="eln-hide-col">' +((__t = ( ((geography.newer.mcdaniel - geography.older.mcdaniel) <= 0 ? "" : "+") + numberWithCommas(geography.newer.mcdaniel - geography.older.mcdaniel) )) == null ? '' : __t) +'</td> <td>' +((__t = ( numberWithCommas(geography.older.cochran) )) == null ? '' : __t) +'</td> <td>' +((__t = ( numberWithCommas(geography.newer.cochran) )) == null ? '' : __t) +'</td> <td class="eln-hide-col">' +((__t = ( ((geography.newer.cochran - geography.older.cochran) <= 0 ? "" : "+") + numberWithCommas(geography.newer.cochran - geography.older.cochran) )) == null ? '' : __t) +'</td> </tr> '; }) ;__p += '\t</tbody></table></div><!-- <a class="eln-show-counties">\t<span class=\'eln-show-label\'><span class="eln-sprite eln-icon-showall"></span> Show</span>\t<span class=\'eln-hide-label\'><span class="eln-sprite eln-icon-hide"></span>Hide</span>\tCounty Details</a> -->';}return __p};

  this["templates"]["jst/widget"] = function(obj) {obj || (obj = {});var __t, __p = '', __e = _.escape;with (obj) {__p += '<link rel="stylesheet" href="https://static01.nyt.com/newsgraphics/2014/elections/5952c9a6ff417f4bac9b523052009ff2933e8ee3/widget.css"><div id="' +((__t = ( widget_id )) == null ? '' : __t) +'" class="eln-widget ' +((__t = ( widget_class )) == null ? '' : __t) +'" data-url="' +((__t = ( widget_url )) == null ? '' : __t) +'" data-race-id="' +((__t = ( widget_race_id )) == null ? '' : __t) +'" data-kicker="' +((__t = ( widget_kicker )) == null ? '' : __t) +'" data-options=' +((__t = ( "'" + JSON.stringify(widget_options) + "'" )) == null ? '' : __t) +'></div><script src="https://static01.nyt.com/newsgraphics/2014/elections/5952c9a6ff417f4bac9b523052009ff2933e8ee3/' +((__t = ( widget_js )) == null ? '' : __t) +'">&lt;/script&gt;';}return __p};

  return this["templates"];

});
var PourOver = (function(){

  
    //     Underscore.js 1.6.0
  //     //underscorejs.org
  //     (c) 2009-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
  //     Underscore may be freely distributed under the MIT license.
  (function(){var n=this,t=n._,r={},e=Array.prototype,u=Object.prototype,i=Function.prototype,a=e.push,o=e.slice,c=e.concat,l=u.toString,f=u.hasOwnProperty,s=e.forEach,p=e.map,h=e.reduce,v=e.reduceRight,g=e.filter,d=e.every,m=e.some,y=e.indexOf,b=e.lastIndexOf,x=Array.isArray,w=Object.keys,_=i.bind,j=function(n){return n instanceof j?n:this instanceof j?void(this._wrapped=n):new j(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=j),exports._=j):n._=j,j.VERSION="1.6.0";var A=j.each=j.forEach=function(n,t,e){if(null==n)return n;if(s&&n.forEach===s)n.forEach(t,e);else if(n.length===+n.length){for(var u=0,i=n.length;i>u;u++)if(t.call(e,n[u],u,n)===r)return}else for(var a=j.keys(n),u=0,i=a.length;i>u;u++)if(t.call(e,n[a[u]],a[u],n)===r)return;return n};j.map=j.collect=function(n,t,r){var e=[];return null==n?e:p&&n.map===p?n.map(t,r):(A(n,function(n,u,i){e.push(t.call(r,n,u,i))}),e)};var O="Reduce of empty array with no initial value";j.reduce=j.foldl=j.inject=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),h&&n.reduce===h)return e&&(t=j.bind(t,e)),u?n.reduce(t,r):n.reduce(t);if(A(n,function(n,i,a){u?r=t.call(e,r,n,i,a):(r=n,u=!0)}),!u)throw new TypeError(O);return r},j.reduceRight=j.foldr=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),v&&n.reduceRight===v)return e&&(t=j.bind(t,e)),u?n.reduceRight(t,r):n.reduceRight(t);var i=n.length;if(i!==+i){var a=j.keys(n);i=a.length}if(A(n,function(o,c,l){c=a?a[--i]:--i,u?r=t.call(e,r,n[c],c,l):(r=n[c],u=!0)}),!u)throw new TypeError(O);return r},j.find=j.detect=function(n,t,r){var e;return k(n,function(n,u,i){return t.call(r,n,u,i)?(e=n,!0):void 0}),e},j.filter=j.select=function(n,t,r){var e=[];return null==n?e:g&&n.filter===g?n.filter(t,r):(A(n,function(n,u,i){t.call(r,n,u,i)&&e.push(n)}),e)},j.reject=function(n,t,r){return j.filter(n,function(n,e,u){return!t.call(r,n,e,u)},r)},j.every=j.all=function(n,t,e){t||(t=j.identity);var u=!0;return null==n?u:d&&n.every===d?n.every(t,e):(A(n,function(n,i,a){return(u=u&&t.call(e,n,i,a))?void 0:r}),!!u)};var k=j.some=j.any=function(n,t,e){t||(t=j.identity);var u=!1;return null==n?u:m&&n.some===m?n.some(t,e):(A(n,function(n,i,a){return u||(u=t.call(e,n,i,a))?r:void 0}),!!u)};j.contains=j.include=function(n,t){return null==n?!1:y&&n.indexOf===y?n.indexOf(t)!=-1:k(n,function(n){return n===t})},j.invoke=function(n,t){var r=o.call(arguments,2),e=j.isFunction(t);return j.map(n,function(n){return(e?t:n[t]).apply(n,r)})},j.pluck=function(n,t){return j.map(n,j.property(t))},j.where=function(n,t){return j.filter(n,j.matches(t))},j.findWhere=function(n,t){return j.find(n,j.matches(t))},j.max=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.max.apply(Math,n);var e=-1/0,u=-1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;o>u&&(e=n,u=o)}),e},j.min=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.min.apply(Math,n);var e=1/0,u=1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;u>o&&(e=n,u=o)}),e},j.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=j.random(r++),e[r-1]=e[t],e[t]=n}),e},j.sample=function(n,t,r){return null==t||r?(n.length!==+n.length&&(n=j.values(n)),n[j.random(n.length-1)]):j.shuffle(n).slice(0,Math.max(0,t))};var E=function(n){return null==n?j.identity:j.isFunction(n)?n:j.property(n)};j.sortBy=function(n,t,r){return t=E(t),j.pluck(j.map(n,function(n,e,u){return{value:n,index:e,criteria:t.call(r,n,e,u)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index-t.index}),"value")};var F=function(n){return function(t,r,e){var u={};return r=E(r),A(t,function(i,a){var o=r.call(e,i,a,t);n(u,o,i)}),u}};j.groupBy=F(function(n,t,r){j.has(n,t)?n[t].push(r):n[t]=[r]}),j.indexBy=F(function(n,t,r){n[t]=r}),j.countBy=F(function(n,t){j.has(n,t)?n[t]++:n[t]=1}),j.sortedIndex=function(n,t,r,e){r=E(r);for(var u=r.call(e,t),i=0,a=n.length;a>i;){var o=i+a>>>1;r.call(e,n[o])<u?i=o+1:a=o}return i},j.toArray=function(n){return n?j.isArray(n)?o.call(n):n.length===+n.length?j.map(n,j.identity):j.values(n):[]},j.size=function(n){return null==n?0:n.length===+n.length?n.length:j.keys(n).length},j.first=j.head=j.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:0>t?[]:o.call(n,0,t)},j.initial=function(n,t,r){return o.call(n,0,n.length-(null==t||r?1:t))},j.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:o.call(n,Math.max(n.length-t,0))},j.rest=j.tail=j.drop=function(n,t,r){return o.call(n,null==t||r?1:t)},j.compact=function(n){return j.filter(n,j.identity)};var M=function(n,t,r){return t&&j.every(n,j.isArray)?c.apply(r,n):(A(n,function(n){j.isArray(n)||j.isArguments(n)?t?a.apply(r,n):M(n,t,r):r.push(n)}),r)};j.flatten=function(n,t){return M(n,t,[])},j.without=function(n){return j.difference(n,o.call(arguments,1))},j.partition=function(n,t){var r=[],e=[];return A(n,function(n){(t(n)?r:e).push(n)}),[r,e]},j.uniq=j.unique=function(n,t,r,e){j.isFunction(t)&&(e=r,r=t,t=!1);var u=r?j.map(n,r,e):n,i=[],a=[];return A(u,function(r,e){(t?e&&a[a.length-1]===r:j.contains(a,r))||(a.push(r),i.push(n[e]))}),i},j.union=function(){return j.uniq(j.flatten(arguments,!0))},j.intersection=function(n){var t=o.call(arguments,1);return j.filter(j.uniq(n),function(n){return j.every(t,function(t){return j.contains(t,n)})})},j.difference=function(n){var t=c.apply(e,o.call(arguments,1));return j.filter(n,function(n){return!j.contains(t,n)})},j.zip=function(){for(var n=j.max(j.pluck(arguments,"length").concat(0)),t=new Array(n),r=0;n>r;r++)t[r]=j.pluck(arguments,""+r);return t},j.object=function(n,t){if(null==n)return{};for(var r={},e=0,u=n.length;u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},j.indexOf=function(n,t,r){if(null==n)return-1;var e=0,u=n.length;if(r){if("number"!=typeof r)return e=j.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,u+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;u>e;e++)if(n[e]===t)return e;return-1},j.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(b&&n.lastIndexOf===b)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var u=e?r:n.length;u--;)if(n[u]===t)return u;return-1},j.range=function(n,t,r){arguments.length<=1&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=0,i=new Array(e);e>u;)i[u++]=n,n+=r;return i};var R=function(){};j.bind=function(n,t){var r,e;if(_&&n.bind===_)return _.apply(n,o.call(arguments,1));if(!j.isFunction(n))throw new TypeError;return r=o.call(arguments,2),e=function(){if(!(this instanceof e))return n.apply(t,r.concat(o.call(arguments)));R.prototype=n.prototype;var u=new R;R.prototype=null;var i=n.apply(u,r.concat(o.call(arguments)));return Object(i)===i?i:u}},j.partial=function(n){var t=o.call(arguments,1);return function(){for(var r=0,e=t.slice(),u=0,i=e.length;i>u;u++)e[u]===j&&(e[u]=arguments[r++]);for(;r<arguments.length;)e.push(arguments[r++]);return n.apply(this,e)}},j.bindAll=function(n){var t=o.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return A(t,function(t){n[t]=j.bind(n[t],n)}),n},j.memoize=function(n,t){var r={};return t||(t=j.identity),function(){var e=t.apply(this,arguments);return j.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},j.delay=function(n,t){var r=o.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},j.defer=function(n){return j.delay.apply(j,[n,1].concat(o.call(arguments,1)))},j.throttle=function(n,t,r){var e,u,i,a=null,o=0;r||(r={});var c=function(){o=r.leading===!1?0:j.now(),a=null,i=n.apply(e,u),e=u=null};return function(){var l=j.now();o||r.leading!==!1||(o=l);var f=t-(l-o);return e=this,u=arguments,0>=f?(clearTimeout(a),a=null,o=l,i=n.apply(e,u),e=u=null):a||r.trailing===!1||(a=setTimeout(c,f)),i}},j.debounce=function(n,t,r){var e,u,i,a,o,c=function(){var l=j.now()-a;t>l?e=setTimeout(c,t-l):(e=null,r||(o=n.apply(i,u),i=u=null))};return function(){i=this,u=arguments,a=j.now();var l=r&&!e;return e||(e=setTimeout(c,t)),l&&(o=n.apply(i,u),i=u=null),o}},j.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},j.wrap=function(n,t){return j.partial(t,n)},j.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},j.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},j.keys=function(n){if(!j.isObject(n))return[];if(w)return w(n);var t=[];for(var r in n)j.has(n,r)&&t.push(r);return t},j.values=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=n[t[u]];return e},j.pairs=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=[t[u],n[t[u]]];return e},j.invert=function(n){for(var t={},r=j.keys(n),e=0,u=r.length;u>e;e++)t[n[r[e]]]=r[e];return t},j.functions=j.methods=function(n){var t=[];for(var r in n)j.isFunction(n[r])&&t.push(r);return t.sort()},j.extend=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},j.pick=function(n){var t={},r=c.apply(e,o.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},j.omit=function(n){var t={},r=c.apply(e,o.call(arguments,1));for(var u in n)j.contains(r,u)||(t[u]=n[u]);return t},j.defaults=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]===void 0&&(n[r]=t[r])}),n},j.clone=function(n){return j.isObject(n)?j.isArray(n)?n.slice():j.extend({},n):n},j.tap=function(n,t){return t(n),n};var S=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof j&&(n=n._wrapped),t instanceof j&&(t=t._wrapped);var u=l.call(n);if(u!=l.call(t))return!1;switch(u){case"[object String]":return n==String(t);case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==n)return e[i]==t;var a=n.constructor,o=t.constructor;if(a!==o&&!(j.isFunction(a)&&a instanceof a&&j.isFunction(o)&&o instanceof o)&&"constructor"in n&&"constructor"in t)return!1;r.push(n),e.push(t);var c=0,f=!0;if("[object Array]"==u){if(c=n.length,f=c==t.length)for(;c--&&(f=S(n[c],t[c],r,e)););}else{for(var s in n)if(j.has(n,s)&&(c++,!(f=j.has(t,s)&&S(n[s],t[s],r,e))))break;if(f){for(s in t)if(j.has(t,s)&&!c--)break;f=!c}}return r.pop(),e.pop(),f};j.isEqual=function(n,t){return S(n,t,[],[])},j.isEmpty=function(n){if(null==n)return!0;if(j.isArray(n)||j.isString(n))return 0===n.length;for(var t in n)if(j.has(n,t))return!1;return!0},j.isElement=function(n){return!(!n||1!==n.nodeType)},j.isArray=x||function(n){return"[object Array]"==l.call(n)},j.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){j["is"+n]=function(t){return l.call(t)=="[object "+n+"]"}}),j.isArguments(arguments)||(j.isArguments=function(n){return!(!n||!j.has(n,"callee"))}),"function"!=typeof/./&&(j.isFunction=function(n){return"function"==typeof n}),j.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},j.isNaN=function(n){return j.isNumber(n)&&n!=+n},j.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==l.call(n)},j.isNull=function(n){return null===n},j.isUndefined=function(n){return n===void 0},j.has=function(n,t){return f.call(n,t)},j.noConflict=function(){return n._=t,this},j.identity=function(n){return n},j.constant=function(n){return function(){return n}},j.property=function(n){return function(t){return t[n]}},j.matches=function(n){return function(t){if(t===n)return!0;for(var r in n)if(n[r]!==t[r])return!1;return!0}},j.times=function(n,t,r){for(var e=Array(Math.max(0,n)),u=0;n>u;u++)e[u]=t.call(r,u);return e},j.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},j.now=Date.now||function(){return(new Date).getTime()};var T={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};T.unescape=j.invert(T.escape);var I={escape:new RegExp("["+j.keys(T.escape).join("")+"]","g"),unescape:new RegExp("("+j.keys(T.unescape).join("|")+")","g")};j.each(["escape","unescape"],function(n){j[n]=function(t){return null==t?"":(""+t).replace(I[n],function(t){return T[n][t]})}}),j.result=function(n,t){if(null==n)return void 0;var r=n[t];return j.isFunction(r)?r.call(n):r},j.mixin=function(n){A(j.functions(n),function(t){var r=j[t]=n[t];j.prototype[t]=function(){var n=[this._wrapped];return a.apply(n,arguments),z.call(this,r.apply(j,n))}})};var N=0;j.uniqueId=function(n){var t=++N+"";return n?n+t:t},j.templateSettings={evaluate:/===([\s\S]+?)===/g,interpolate:/====([\s\S]+?)===/g,escape:/===-([\s\S]+?)===/g};var q=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n"," ":"t","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\t|\u2028|\u2029/g;j.template=function(n,t,r){var e;r=j.defaults({},r,j.templateSettings);var u=new RegExp([(r.escape||q).source,(r.interpolate||q).source,(r.evaluate||q).source].join("|")+"|$","g"),i=0,a="__p+='";n.replace(u,function(t,r,e,u,o){return a+=n.slice(i,o).replace(D,function(n){return"\\"+B[n]}),r&&(a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(a+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),u&&(a+="';\n"+u+"\n__p+='"),i=o+t.length,t}),a+="';\n",r.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{e=new Function(r.variable||"obj","_",a)}catch(o){throw o.source=a,o}if(t)return e(t,j);var c=function(n){return e.call(this,n,j)};return c.source="function("+(r.variable||"obj")+"){\n"+a+"}",c},j.chain=function(n){return j(n).chain()};var z=function(n){return this._chain?j(n).chain():n};j.mixin(j),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];j.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],z.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];j.prototype[n]=function(){return z.call(this,t.apply(this._wrapped,arguments))}}),j.extend(j.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return j})}).call(this);
  //# sourceMappingURL=underscore-min.map

    PourOver = {
      // Utility functions. Skip down to "Collections" for the real meat of PourOver.
      //
      // # The basic sorted set operations
      //
      union_sorted: function(a,b){
        // Make more efficient by just copying at Infinity
        var lowa = 0, lowb = 0, higha = a.length, highb = b.length, result=[], la, lb;
        while (higha > lowa || highb > lowb){
          la = a[lowa];
          lb = b[lowb];
          if(_.isUndefined(la)) la = Infinity;
          if(_.isUndefined(lb)) lb = Infinity;
          if(lowa == higha){
            return result.concat(b.slice(lowb,highb));
          }
          if(lowb == highb){
            return result.concat(a.slice(lowa,higha));
          }
          if(la == lb){
            result.push(la);
            lowa++;lowb++;
          } else if (la < lb){
            result.push(la);
            lowa++;
          } else {
            result.push(lb);
            lowb++;
          }
        }
        return result;
      },
      intersect_sorted: function(a,b){
        var lowa = 0, lowb = 0, higha = a.length, highb = b.length, result=[], la, lb;
        while (higha > lowa && highb > lowb){
          la = a[lowa];
          lb = b[lowb];


          if(la == lb){
            result.push(la);
            lowa++;lowb++;
          } else if (la < lb){
            lowa++;
          } else {
            lowb++;
          }
        }
        return result;
      },
      subtract_sorted: function(a,b){
        var lowa = 0, lowb = 0, higha = a.length, highb = b.length, result=[], la, lb;
        while (higha > lowa || highb > lowb){
          la = a[lowa];
          lb = b[lowb];
          if(higha == lowa){
            return result;
          }
          if(highb == lowb){
            return result.concat(a.slice(lowa,higha));
          }
          if(la == lb){
            lowa++;lowb++;
          } else if (la < lb){
            result.push(la);
            lowa++;
          } else {
            lowb++;
          }
        }
        return result;
      },
      insert_sorted: function(set,element){
        var length = set.length,
          i = 0,
          last_elem = set[length - 1];
        if(element > last_elem){
          set.push(element);
          return set;
        }
        while(i < length){
          if(element < set[i]){
            return set.slice(0,i).concat([element]).concat(set.slice(i,length));
          } else {
            i++;
          }
        }
        set.push(element);
        return set;
      },

      //
      // # Sort support
      //

      // Sort the set according to some function and then store an array of the translations
      // of the indicies. So if the first item went to index 2 after being sorted, put 2 in
      // the first spot of the permutation array.
      build_permutation_array: function(set,sort){
        var sorted_set = _(set).clone(),perm=[];
        if(typeof(sort) === "function"){
          sorted_set.sort(sort);
        } else {
          sorted_set.sort(function(a,b){return sort.fn.call(sort,a,b);});
        }
        _(sorted_set).each(function(m,i){perm[m.cid] = i;});
        return perm;
      },
      // Use a permutation array to resort a subset of a collection.
      permute_from_array: function(collection,perm){
        var output = [];
        if(typeof(collection[0]) === "number"){
          _(collection).each(function(i){ output[perm[i]] = i ;});
        } else {
          _(collection).each(function(i){ output[perm[i.cid]] = i ;});
        }
        return _(output).without(undefined);
      },
      // Remove an element from a sorted set.
      remove_sorted: function(set,element){
        var length = set.length,
            i = 0;
        while(i < length){
          if(element == set[i]){
            return set.slice(0,i).concat(set.slice(i+1,length));
          } else {
            i++;
          }
        }
        return set;
      },
      bisect_by: function(f) {
        // Thanks to crossfilter (https://github.com/square/crossfilter) for this implementation.
        function bisectLeft(a, x, lo, hi) {
          while (lo < hi) {
            var mid = lo + hi >>> 1;
            if (f(a[mid]) < x) lo = mid + 1;
            else hi = mid;
          }
          return lo;
        }

        function bisectRight(a, x, lo, hi) {
          while (lo < hi) {
            var mid = lo + hi >>> 1;
            if (x < f(a[mid])) hi = mid;
            else lo = mid + 1;
          }
          return lo;
        }

        bisectRight.right = bisectRight;
        bisectRight.left = bisectLeft;
        return bisectRight;
      },
      // # Pre-defined cache methods
      // Caching is really the raison d'etre of Pourover. Every filter has two cache methods: one for rebuilding the whole filter from scratch
      // and one for adding new items. As Pourover grows it will gain more pre-defined cache methods that correlate with common UI and data patterns.
      cacheMethods: {
        // ### Default: the dumb caches.
        // Just goes through each possible value for the filter and tests every item in the collection against it. As expensive as
        // possibile, but simple.
        defaultCache: function(items){
          var that = this;
          _(that.possibilities).each(function(p){
            var matching_items = _(items).filter(function(i){return that.fn(p,i);}),
                matching_cids = _(matching_items).map(function(i){return i.cid;});
            p.matching_cids = matching_cids;
          });
        },
        defaultAddCache: function(items){
          var that = this;
          _(that.possibilities).each(function(p){
            var matching_items = _(items).filter(function(i){return that.fn(p,i);}),
                matching_cids = _(matching_items).map(function(i){return i.cid;});
            p.matching_cids = PourOver.union_sorted(p.matching_cids,matching_cids);
          });
        },
        // ### Exact: the fastest caches.
        // For filters that evaluate by strict equality (this property === this value). The name of the filter must
        // match the name of the property for exact cache to work.
        exactCache: function(items){
          var that = this,
              attr = this.attr || this.name;
          _(items).each(function(i){
            var p = that.possibilities[i[attr]];
            if (p) {
              p.matching_cids = PourOver.insert_sorted(p.matching_cids,i.cid);
            }
          });
        },
        exactAddCache: function(items){
          PourOver.cacheMethods.exactCache.call(this,items);
        },
        inclusionCache: function(items){
          var that = this,
              attr = this.attr || this.name;
          _(items).each(function(i){
            _(i[attr]).each(function(v){
              var p = that.possibilities[v];
              if(p){
                p.matching_cids = PourOver.insert_sorted(p.matching_cids,i.cid);
              }
            });
          });
        },
        inclusionAddCache: function(items){
          PourOver.cacheMethods.inclusionCache.call(this,items);
        }
      }
    };
        // Copied from Backbone
        var array = [];
        var push = array.push;
        var slice = array.slice;
        var splice = array.splice;
        var Events = PourOver.Events = {

        // Bind an event to a `callback` function. Passing `"all"` will bind
        // the callback to all events fired.
        on: function(name, callback, context) {
          if (!eventsApi(this, 'on', name, [callback, context]) || !callback) return this;
          this._events || (this._events = {});
          var events = this._events[name] || (this._events[name] = []);
          events.push({callback: callback, context: context, ctx: context || this});
          return this;
        },

        // Bind an event to only be triggered a single time. After the first time
        // the callback is invoked, it will be removed.
        once: function(name, callback, context) {
          if (!eventsApi(this, 'once', name, [callback, context]) || !callback) return this;
          var self = this;
          var once = _.once(function() {
            self.off(name, once);
            callback.apply(this, arguments);
          });
          once._callback = callback;
          return this.on(name, once, context);
        },

        // Remove one or many callbacks. If `context` is null, removes all
        // callbacks with that function. If `callback` is null, removes all
        // callbacks for the event. If `name` is null, removes all bound
        // callbacks for all events.
        off: function(name, callback, context) {
          var retain, ev, events, names, i, l, j, k;
          if (!this._events || !eventsApi(this, 'off', name, [callback, context])) return this;
          if (!name && !callback && !context) {
            this._events = void 0;
            return this;
          }
          names = name ? [name] : _.keys(this._events);
          for (i = 0, l = names.length; i < l; i++) {
            name = names[i];
            if (events = this._events[name]) {
              this._events[name] = retain = [];
              if (callback || context) {
                for (j = 0, k = events.length; j < k; j++) {
                  ev = events[j];
                  if ((callback && callback !== ev.callback && callback !== ev.callback._callback) ||
                      (context && context !== ev.context)) {
                    retain.push(ev);
                  }
                }
              }
              if (!retain.length) delete this._events[name];
            }
          }

          return this;
        },

        // Trigger one or many events, firing all bound callbacks. Callbacks are
        // passed the same arguments as `trigger` is, apart from the event name
        // (unless you're listening on `"all"`, which will cause your callback to
        // receive the true name of the event as the first argument).
        trigger: function(name) {
          if (!this._events) return this;
          var args = slice.call(arguments, 1);
          if (!eventsApi(this, 'trigger', name, args)) return this;
          var events = this._events[name];
          var allEvents = this._events.all;
          if (events) triggerEvents(events, args);
          if (allEvents) triggerEvents(allEvents, arguments);
          return this;
        },

        // Tell this object to stop listening to either specific events ... or
        // to every object it's currently listening to.
        stopListening: function(obj, name, callback) {
          var listeningTo = this._listeningTo;
          if (!listeningTo) return this;
          var remove = !name && !callback;
          if (!callback && typeof name === 'object') callback = this;
          if (obj) (listeningTo = {})[obj._listenId] = obj;
          for (var id in listeningTo) {
            obj = listeningTo[id];
            obj.off(name, callback, this);
            if (remove || _.isEmpty(obj._events)) delete this._listeningTo[id];
          }
          return this;
        }

      };

      // Regular expression used to split event strings.
      var eventSplitter = /\s+/;

      // Implement fancy features of the Events API such as multiple event
      // names `"change blur"` and jQuery-style event maps `{change: action}`
      // in terms of the existing API.
      var eventsApi = function(obj, action, name, rest) {
        if (!name) return true;

        // Handle event maps.
        if (typeof name === 'object') {
          for (var key in name) {
            obj[action].apply(obj, [key, name[key]].concat(rest));
          }
          return false;
        }

        // Handle space separated event names.
        if (eventSplitter.test(name)) {
          var names = name.split(eventSplitter);
          for (var i = 0, l = names.length; i < l; i++) {
            obj[action].apply(obj, [names[i]].concat(rest));
          }
          return false;
        }

        return true;
      };

      // A difficult-to-believe, but optimized internal dispatch function for
      // triggering events. Tries to keep the usual cases speedy (most internal
      // PourOver events have 3 arguments).
      var triggerEvents = function(events, args) {
        var ev, i = -1, l = events.length, a1 = args[0], a2 = args[1], a3 = args[2];
        switch (args.length) {
          case 0: while (++i < l) (ev = events[i]).callback.call(ev.ctx); return;
          case 1: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1); return;
          case 2: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1, a2); return;
          case 3: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1, a2, a3); return;
          default: while (++i < l) (ev = events[i]).callback.apply(ev.ctx, args); return;
        }
      };

      var listenMethods = {listenTo: 'on', listenToOnce: 'once'};

      // Inversion-of-control versions of `on` and `once`. Tell *this* object to
      // listen to an event in another object ... keeping track of what it's
      // listening to.
      _.each(listenMethods, function(implementation, method) {
        Events[method] = function(obj, name, callback) {
          var listeningTo = this._listeningTo || (this._listeningTo = {});
          var id = obj._listenId || (obj._listenId = _.uniqueId('l'));
          listeningTo[id] = obj;
          if (!callback && typeof name === 'object') callback = this;
          obj[implementation](name, callback, this);
          return this;
        };
      });

      // Aliases for backwards compatibility.
      Events.bind   = Events.on;
      Events.unbind = Events.off;

      // Allow the `PourOver` object to serve as a global event bus, for folks who
      // want global "pubsub" in a convenient place.
      _.extend(PourOver, Events);
      // #Collections
      //The main kind of object in Pourover. A collection is basically a wrapper around an array of objects.
      //It adds collection ids to its members and has support for various ways of retrieving all or a part of
      //its members.

      PourOver.Collection = function(items,opts){
        if(typeof(items) == "undefined"){items = [];}
        this.items = [];
        this.filters = {};
        this.sorts = {};
        this.addItems(items);
        this.on("change",function(){
          _(this.filters).each(function(f){ if(f.current_query){f.current_query.refresh();} });
        });
        this.initialize.apply(this, arguments);
      };

      _.extend(PourOver.Collection.prototype,PourOver.Events,{
          initialize: function(){},
          // Force the filters and sorts of a collection to refresh. Generally most useful if you have batched
          // up a bunch of silented actions and you want to refresh once at the end.
          refresh: function(){
            this.trigger("queryChange");
          },

          // Retrive the objects associated with an array of cids. Like everything in Pourover, the cids must be sorted.
          // This is not ususally an issue as you generally will not be calling `collection.get` with an array you
          // manually create. You will probably be using the output of some function that keeps it sorted for you.
          get: function(cids){
            return PourOver.Collection.prototype.getBy.call(this,"cid",cids,true);
          },

          // Similar to get, except -- rather than getting items by cid -- you are getting them by [attr_name].
          // Here vals is an array of [attr_names]s.
          getBy: function(attr_name,vals,sorted){
            if(! _.isArray(vals)){ var vals = [vals] }
            if(typeof(sorted) == "undefined"){sorted = false;}
            var low = 0, high = this.items.length,lc = 0, hc = vals.length, output = [],items = this.items,i;
            if(sorted == true){
              while (low < high && lc < hc){
                if (vals[lc] == (i=items[low])[attr_name]){
                  output.push(i);
                  low++;
                  lc++;
                } else if (vals[lc] < i[attr_name]){
                  lc++;
                } else{
                  low++;
                }
              }
            } else if (sorted == "reverse"){
              while (low < high && lc < hc){
                if (vals[lc] == (i=items[low])[attr_name]){
                  output.push(i);
                  low++;
                  lc++;
                } else if (vals[lc] > i[attr_name]){
                  lc++;
                } else{
                  low++;
                }
              }
            } else {
              while (low < high && lc < hc){
                if ( _(vals).include((i=items[low])[attr_name])){
                  output.push(i);
                  vals = _(vals).without(i[attr_name]);
                  low++;
                  lc++;
                } else {
                  low++;
                }
              }
            }
            return output;
          },

          // Add items to the collection, triggering the appropriate events to keep all dependent sort and filter sets up-to-date.
          addItems: function(i){
            this.trigger("will_change");
            if(! _.isArray(i)){ var i = [i] }
            var last_id = this.items.length > 0 ? _(this.items).last().cid + 1 : 0,new_items;
            new_items = _(i).map(function(c){var n = PourOver.Item(c); n.cid = last_id++; return n;});
            this.items = this.items.concat(new_items);
            this.regenerateFilterSets(new_items);
            this.trigger("change");
          },

          // Remove items from the collection, triggering the appropriate events to keep all dependent sort and filter sets up-to-date.
          // This functionality is only included begrudgingly. Pourover is best for collections that rarely remove members.
          // TODO: Optimize
          removeItems: function(i,isSorted){
            this.trigger("will_change");
            if(typeof(isSorted) === "undefined"){var isSorted = false}
            if(! _.isArray(i)){ var i = [i] }
            if(isSorted){
              i = i.sort(function(a,b){return a.cid - b.cid ;});
              var new_items = [],old_items = this.items,new_length = i.length,old_length = this.items.length,newi = 0, oldi = 0;
              while(oldi < old_length){
                if(! newi < new_length){
                  new_items = new_items.concat(old_items.slice(oldi));
                  break;
                } else if(old_items[oldi].cid === i[newi].cid){
                  newi++;
                  oldi++;
                } else {
                  new_items.push(old_items[oldi]);
                  oldi++;
                }
              }
            } else {
              var new_items = [], old_items = this.items,old_length = this.items.length, oldi = 0,delete_cids = _(i).pluck("cid");
              while(oldi < old_length && delete_cids.length > 0){
                if(_(delete_cids).include(old_items[oldi].cid)){

                } else {
                  new_items.push(old_items[oldi]);
                }
                oldi++;
              }
            }
            this.items = new_items;
            this.regenerateFilterSets();
            this.trigger("change");
          },

          // # Collection filter functions
          // All filters are associated to collections rather than views. This allows for multiple views to share the same filter.
          // This is especially useful for modal situations in which you can set filters on a grid view that are reflected in the
          // one up view as well.
          addFilters: function(f){
            var that = this,new_filters;
            if(! _.isArray(f)){ var f = [f] }
            new_filters = _(f).reduce(function(m,i){ m[i.name] = _.clone(i); m[i.name].collection = that; return m; },{});
            this.filters = _(this.filters).extend(new_filters);
            // Bubble all query change events up from the individual filters to the collection. This allows a developers to
            // specify events that should be triggered whenever any filter's query is changed.
            _(new_filters).each(function(f){
              f.on("queryChange",function(){
                that.trigger("queryChange");
              });
              // All filters precache the result of their filtering. This is the source of pourover's speed optimizations.
              f.cacheResults(that.items);
              // If a user passes in an `associated_attrs` property on a filter, that filter will re-cache its result whenever
              // any object in the collection has an attribute changed. Setting `associated_attrs` is essential for admins or
              // other uses in which filterable values can change.
              if(f.associated_attrs){
                _(f.associated_attrs).each(function(a){
                  that.on("change:"+a,function(objs){
                    f.removeFromCache(objs);
                    f.addCacheResults(objs);
                    if(f.current_query){f.current_query.refresh();}
                  });
                });
              }
            });
          },

          // A shortcut to re-calculate the results of every filter. This is expensive if you do not pass in `new_items`, in which cases
          // only the new_items will be cached and the filters updated.
          regenerateFilterSets: function(new_items){
            var that = this;
            // If no new items are passed in, regenerate filters for all items in the collection
            if(typeof(new_items) == "undefined"){
              _(this.filters).each(function(f){
                f.cacheResults(that.items);
              });
            } else {
              _(this.filters).each(function(f){
                f.addCacheResults(new_items);
              });
            }
          },

          // A shortcut for returning a match object containing all the items in a collection. More on matches below.
          getAllItems: function(){
            var cids = _(this.items).map(function(i){return i.cid;});
            return new PourOver.MatchSet(cids,this,["all"]);
          },

          // Get the currently cached results for the last stateful query on a filter (the last time a `setQuery` was called on that filter.)
          // If `empty_default` is set to true, the function will return no items if the filter does not have a current query set. Otherwise,
          // the function will return all items in the collection. The former `empty_default` setting is useful when OR-ing filters together, when
          // you want an unset filter to represent an unselected dimension. The latter is useful when AND-ing filters together, when you
          // want an unset filter to comprise all objects in the collection.
          getCurrentFilteredItems: function(filter_name,empty_default){
            if(typeof(empty_default) === "undefined"){empty_default = false;}
            if(this.filters[filter_name].current_query && this.filters[filter_name].current_query.stack.length > 0){
              return this.filters[filter_name].current_query;
            } else {
              if(empty_default){
                return new PourOver.MatchSet([],this,[]);
              } else {
                return this.getAllItems();
              }
            }
          },

          // The non-stateful way to query a filter. Simply returns the result of the query but does not store the query on the filter.
          getFilteredItems: function(filter_name,query){
            var filter = this.filters[filter_name],possibility;
            if (_.isUndefined(filter) ) throw "The filter " + filter_name + " does not exist.";
            return filter.getFn(query);
          },

          // # Sort functions
          // Sorts, like filters, are generally stored on collections for the same reason that filters are stored on the collection rather than the view.
          // However, whereas filters keep track of their own state and this is shared between views, the state of which sort is enabled is stored on the view.

          addSort: function(sort){
            var that = this;
            this.sorts[sort.name] = sort;
            sort.collection = this;
            sort.rebuild_sort();
            this.on("change",function(){ sort.rebuild_sort(); });
            // Like filters, if you set `associated_attrs` on a sort, they will rebuild themselves whenever any item in the collection undergoes a change
            // on that attribute.
            // TODO: Consider cloning on add. Also, bring in line with addFilter (events or not!?)
            if(sort.associated_attrs){
              _(sort.associated_attrs).each(function(a){
                that.on("change:"+a,function(objs){
                  sort.rebuild_sort();
                });
              });
            }
          },

          // Add multiple sorts.
          addSorts: function(sorts){
            if(typeof(opts) === "undefined"){ opts = {};}
            if(! _(sorts).isArray()){sorts = [sorts];}
            var that = this;
            _(sorts).each(function(s){
              that.addSort(s);
            });
          },

          // The non-stateful way to retrieve all the items in the collection, sorted.
          getSortedItems: function(sort_name){
            var s = this.sorts[sort_name],that = this,output;
            return s.sort(this.items);
          },

          // A silly shortcut, pass in a cid and an attribute, retrieve its value. Useful for template helpers.
          getItemValue: function(cid,attribute){
            var item = _(this.items).find(function(i){return i.cid === Number(cid);});
            return item[attribute];
          },

          // Update the value of one attribute of one item in the collection.
          updateItem: function(cid,attribute,value){
            this.trigger("will_incremental_change");
            var item = _(this.items).find(function(i){return i.cid === Number(cid);});
            item[attribute] = value;
            this.trigger("change:"+attribute,[item]);
            this.trigger("incremental_change",[attribute]);
            this.trigger("update","updateItem");
            return item.guid;
          },

          // Delete an attribute of one item in the collection.
          removeItemAttribute: function(cid,attribute,value){
            this.trigger("will_incremental_change");
            var item = _(this.items).find(function(i){return i.cid === Number(cid);});
            delete item[attribute];
            this.trigger("change:"+attribute,[item]);
            this.trigger("incremental_change",[attribute]);
            this.trigger("update","updateItem");
            return item.guid;
          },

          // Change the value of one attribute of many items to the same value.
          batchUpdateItems: function(cids,attribute,value){
            this.trigger("will_incremental_change");
            var items = this.get(cids,true);
            _(items).each(function(i){
              i[attribute] = value;
            });
            this.trigger("change:"+attribute,items);
            this.trigger("incremental_change",[attribute]);
            this.trigger("update","batchUpdate");
            return _(items).pluck("guid");
          },

          // Change the value of several attributes of a single item in the collection.
          updateAttributes: function(cid,updates){
            this.trigger("will_incremental_change");
            var item = _(this.items).find(function(i){return i.cid === Number(cid);});
            var that = this;
            _(updates).each(function(v,k){
              item[k] = v;
              that.trigger("change:"+k,[item]);
            });
            this.trigger("incremental_change",_(updates).keys());
            this.trigger("update","updateAttribute");
            return item.guid;
          },

          // Change the value of several attributes of several items in the collection. Here 'updates'
          // is a hash of attributes -> new values.
          batchUpdateAttributes: function(cids,updates){
            this.trigger("will_incremental_change");
            var items = this.get(cids,true);
            var that = this;
            _(items).each(function(item){
              _(updates).each(function(v,k){
                item[k] = v;
              });
            });
            _(updates).each(function(v,k){
              that.trigger("change:"+k,items);
            });
            this.trigger("incremental_change",_(updates).keys());
            this.trigger("update","batchUpdate");
            this.trigger("batchUpdateAttribute");
            return _(items).pluck("guid");
          },

          batchLoadItems: function(data){
            this.trigger("will_incremental_change");

            _(data).each(_.bind(function(d){
                var item = this.getBy("guid",d.guid),
                    last_id = this.items.length > 0 ? _(this.items).last().cid + 1 : 0,
                    current_item;
                if (item && item[0]){
                    current_item = item[0];
                  _(d).each(function(v,k){
                    current_item[k] = v;
                  });
                } else {
                    item = PourOver.Item(d);
                    item.cid = last_id++;
                    this.items = this.items.concat([item]);
                }
            },this))

            this.regenerateFilterSets();
            this.trigger("incremental_change","*");
            this.trigger("change");
            this.trigger("update","batchLoad");
            this.trigger("batchLoadItems");
          }
      });

      // #Items
      // If we ever need to add properties to items in a collection, the code would go here.
      PourOver.Item = function(i){
        return i;
      },

      // #Filters

      // A filter is basically a rule for mapping items of a collection into groups based on attribute
      // values. It caches the results and can be queried either statefully or non-statefully, depending
      // on developer preference.
      PourOver.Filter = function(name,values,opts){
        if(typeof(opts) === "undefined"){opts = {};}
        this.name = name;
        this.possibilities = this.create_possibilities(values);
        this.values = _(values).map(function(v){return v.value;});
        _.extend(this,opts);
        this.initialize.apply(this, arguments);
      }

      _.extend(PourOver.Filter.prototype,PourOver.Events,{

        // Initialize is a no-op by default.
        initialize: function(){},

        // Given an array of possible values, initializes the object that will store the cached results
        // of querying for that possibility.
        create_possibilities: function(vs){
          var o = {};
          _(vs).each(function(v){
            var name = v.name || String(v.value);
            o[name] = v;
            o[name].matching_cids = [];
          });
          return o;
         },

         // cacheResults and addCacheResults are generic methods that are must be overridden before instantiating a filter.
         // The preset filters included below provide good examples of how these functions should be written. cacheResults
         // should cache all the items in the collection, whereas addCacheResults incrementally adds new items to already
         // cached, filtered results.
         cacheResults: function(items){
           throw "No cache function has been defined for this filter '" + this.name + "'.";
         },
         addCacheResults: function(items){
           throw "No add cache function has been defined for this filter '" + this.name + "'.";
         },

         makeQueryMatchSet: function(cids,query){
            return new PourOver.MatchSet(cids, this.getCollection(), [[this,query]]);
         },

         // Generally only used when removing items from a collection or when an item changes value. This will remove the item from
         // the cache so that it can either be recached with its new value or thrown away.
         removeFromCache: function(items){
          var cids = _(items).map(function(i){return i.cid;}).sort(function(a,b){return a-b;});
          _(this.possibilities).each(function(p){
            p.matching_cids = PourOver.subtract_sorted(p.matching_cids,cids);
          });
         },

         // The stateful way to query a filter. Delegates the retrieval of a MatchSet to the filter's getFn and caches the results on the filter.
         query: function(q,silent){
           if(typeof(silent) === "undefined"){var silent = false;}
           var match_set = this.getFn(q);
           this.setQuery(match_set,silent);
         },

         // Assigns a MatchSet to a filter (caches the result) and triggers the appropriate events.
         setQuery: function(q,silent){
           if(typeof(silent) === "undefined"){var silent = false;}
           this.current_query = q;
           if(!silent){
             this.trigger("queryChange");
           }
         },

         // Removes a cached result from a filter.
         clearQuery: function(silent){
           if(typeof(silent) === "undefined"){var silent = false;}
           this.current_query = false;
           if(!silent){
             this.trigger("queryChange");
           }
         },

         // Unions a cached result with another result (both being MatchSets) and produces a new MatchSet.
         unionQuery: function(q,silent){
           if(typeof(silent) === "undefined"){var silent = false;}
           if(typeof(q) === "string" || typeof(q) === "number" || _.isArray(q)){
             var q = this.getFn(q);
           }
           if(this.current_query){
             this.current_query = this.current_query.or(q);
           } else {
             this.current_query = q;
           }
           if(!silent){
             this.trigger("queryChange");
           }
         },

         // Intersects a cached result with another result (both being MatchSets) and produces a new MatchSet.
         intersectQuery: function(q,silent){
           if(typeof(silent) === "undefined"){var silent = false;}
           if(typeof(q) === "string" || typeof(q) === "number" || _.isArray(q)){
             var q = this.getFn(q);
           }
           if(this.current_query){
             this.current_query = this.current_query.and(q);
           } else {
             this.current_query = q;
           }
           if(!silent){
             this.trigger("queryChange");
           }
         },

         // Subtracts a cached result with another result (both being MatchSets) and produces a new MatchSet.
         subtractQuery: function(q,silent){
           if(typeof(silent) === "undefined"){var silent = false;}
           if(typeof(q) === "string" || typeof(q) === "number" || _.isArray(q)){
             var q = this.getFn(q);
           }
           if(this.current_query){
             this.current_query = this.current_query.not(q);
           } else {
             this.current_query = q;
           }
           if(!silent){
             this.trigger("queryChange");
           }
         },

         // This is the inverse of the three functions above. Removes a query from a compound, cached MatchSet on a filter.
         // This is useful when you have a UI in which subsequent selections union together. It is faster on a toggle to remove
         // the deselected possibility rather than re-union the remaining selected ones.
         // TODO: Test
         removeSingleQuery: function(q,silent){
           if(! this.current_query){return false;}
           if(typeof(silent) === "undefined"){var silent = false;}
           if(typeof(q) === "string" || typeof(q) === "number" || _.isArray(q)){
             var q = this.getFn(q);
           }
           var s = [],
               stack = this.current_query.stack,new_stack,
               is_compound = function(c){return _.isString(c) && c.match(/^(or|and|not)$/);};
            new_stack = _(stack).reduce(function(m,i){
              if(i[1] === q.stack[0][1]){
                return m;
              } else if(is_compound(i[0]) && i[1][0][1] === q.stack[0][1]){
                return m;
              } else {m.push(i); return m;}
            },s);
           if(new_stack[0] && (new_stack[0][0] == "and" || new_stack[0][0] == "or" || new_stack[0][0] == "not")){
             new_stack[0] = new_stack [0][1][0];
           }
           this.current_query.stack = new_stack;
           this.current_query.refresh();
           if(!silent){
             this.trigger("queryChange");
           }
         },

         // Convenice method for getting the collection attached to a filter.
         // Just an aesthetic thing. I like the explicit "getCollection" calls in
         // the rest of the code.
         getCollection: function(){
           return this.collection;
          },

         getByPossibilityGroups: function(){
           var collection = this.collection;
           return _(this.possibilities).reduce(function(m,p,k){m[k] = collection.get(p.matching_cids); return m;},{});
         }
      });

      // #Sorts
      //
      // Sorts cache different orderings of collection items and subsets thereof. Sorts generally belong to collections,
      // but they can belong to views as well for optimization concerns.
      PourOver.Sort = function(name,opts){
        this.name = name;
        _.extend(this,opts);
        this.initialize.apply(this, arguments);
      };

      _.extend(PourOver.Sort.prototype,PourOver.Events,{
        initialize: function(){},

        // By default, sorts are not view sorts. A view sort is attached to a specific view and only updates when that
        // view undergoes a queryChange.
        view: false,

        // Use a sort to order an array of cids
        sort: function(set){return PourOver.permute_from_array(set,this.permutation_array);},

        // Recache the results of sorting the collection.
        rebuild_sort: function(){
          if(this.view){
            var items = this.view.match_set.all();
          } else {
            var items = this.collection.items;
          }
          this.permutation_array = PourOver.build_permutation_array(items,this);
          this.trigger("resort");
        }
      });

      // #Views
      //
      // Views store a state of collection and are generally what should be rendered. There can be many views per collection.
      // Views can be paged. Moreover, a view has a selection function which tells the view how to compose its various filters to produce the current set.
      PourOver.View = function(name,collection,opts){
        var that = this;
        this.name = name;
        if(typeof(opts) === "undefined"){ opts = {};}
        this.collection = collection;
        this.match_set = new PourOver.MatchSet(_(this.collection.items).map(function(i){return i.cid;}),this.collection,["all"]);
        if(opts.template){this.template = opts.template;}

        // Whenever the collection gains or loses members, recache the MatchSet saved on the view.
        this.collection.on("will_change will_incremental_change",function(){
            that.storeViewPosition();
        });

        this.collection.on("change",function(){
          that.match_set.refresh();
          that.setNaturalSelection();
          that.resetPage();
          that.trigger("collection-change");
        });

        // Whenever an item in the collection is changed, recache the MatchSet saved on the view.
        this.collection.on("incremental_change",function(attrs){
          that.match_set.refresh();
          that.setNaturalSelection(attrs);
          that.resetPage();
          that.trigger("collection-incremental-change");
        });

        // Bubble all collection update events through.
        this.collection.on("update",function(f){
          that.trigger("update",f);
        });

        // Whenever any filter is queried statefully, reset the view's MatchSet; We don't have to refresh the match_set here. That is only necessary
        // when it's possible that a filter has stale information as a result of a change in the underlying data.
        this.collection.on("queryChange",function(){
          that.setNaturalSelection();
          that.trigger("update","query");
        });

        // Bubble up sortChange events as updates
        this.on("sortChange",function(){
          this.trigger("update","sort");
        });

        // Bubble up pageChange events as updates
        this.on("pageChange",function(){
          this.trigger("update","page");
        });
        this.view_sorts = [];
        _.extend(this,opts);
        this.initialize.apply(this, arguments);
      };

      _.extend(PourOver.View.prototype,PourOver.Events,{
        initialize: function(){},
        current_page: 0,

        // By default, return all items in the view.
        page_size: Infinity,
        current_sort: false,

        // Changes a view from being sorted to no longer being sorted.
        removeSort: function(){
          if(this.current_sort.off){this.current_sort.off("resort");}
          this.current_sort = false;
          this.trigger("sortChange");
        },

        // Sets a sort on a view and fires all appropriate events.
        setSort: function(sort_name,view_sort,silent){
          if(typeof(view_sort) === "undefined"){view_sort = false;}
          if(typeof(silent) === "undefined"){silent = false;}
          var that = this;
          if(this.current_sort.off){this.current_sort.off("resort");}
          if(sort_name && view_sort){
            this.current_sort = this.view_sorts[sort_name];
            this.current_sort.on("resort",function(){that.trigger("sortChange");});
          } else if(sort_name){
            this.current_sort = this.collection.sorts[sort_name];
            this.current_sort.on("resort",function(){that.trigger("sortChange");});
          } else {
            this.current_sort = false;

          }
          if(! silent){
            this.trigger("sortChange");
          }
        },

        // Return the name of the current sort of the view.
        getSort: function(){
          if (!this.current_sort){
            return false;
          } else {
            return this.current_sort.name;
          }
        },

        // Add a sort to the view. The difference between this and a collection sort is that this sort will
        // only change if the view receives a selectionChange.
        addViewSorts: function(sorts){
            if(typeof(opts) === "undefined"){ opts = {};}
            if(! _(sorts).isArray()){sorts = [sorts];}
            var that = this;
            _(sorts).each(function(sort){
              that.view_sorts[sort.name] = sort;
              sort.collection = that.collection;
              sort.view = that;
              sort.rebuild_sort();
              that.on("selectionChange",function(attrs){
                if(sort.associated_attrs == undefined || attrs === "*"){
                  sort.rebuild_sort();
                }
                if(sort.associated_attrs && _.intersection(sort.associated_attrs,attrs).length > 0){
                  sort.rebuild_sort();
                }
              });
            });
        },

        // IMPORTANT: This determines how a view composes the filters on a collection to generate results. Here, by default,
        // every filter on the collection is intersected. This is often the desired behavior. However, this must be overridden
        // if you want your view to do fancier things such as union some filters, difference others, and intersect the rest.
        selectionFn: function(){
          var collection = this.collection;
          var output = _(collection.filters).reduce(function(m,i){
            var q = i.current_query;
            if(m && (!q || _.isEmpty(q.stack))){ return m;}
            if(!m && (!q || _.isEmpty(q.stack))){return collection.getAllItems();}

            if(m){
              return m.and(q);
            } else {
              return q;
            }
          },false);
          return output;
        },

        // Caches a MatchSet on the view as the current match_set;
        setSelection: function(match_set,attrs){
          this.match_set = match_set;
          this.trigger("selectionChange",attrs);
        },

        // Delegates to the views selectionFn to generate an array of valid cids given the current filters.
        setNaturalSelection: function(attrs){
          var selection;
          selection = this.selectionFn();
          this.setSelection(selection,attrs);
        },

        // Removes a MatchSet from a view and replaces it with the universe of possible items.
        clearSelection: function(){this.match_set = this.collection.getAllItems();},

        // IMPORTANT: This is the function you will call most often on views. This returns the cached, filtered items and
        // then sorts them and pages them as appropriate.
        getCurrentItems: function(page){
          if(! this.match_set){return [];}
          if(typeof(page) === "undefined"){
            var page = this.current_page;
          }
          if(this.page_size == Infinity){
            if(this.current_sort){
              var items = this.match_set.all_sorted(this.current_sort);
            } else {
              var items = this.match_set.all();
            }
          } else {
          // TODO: Slice cids before reassociating
            if(this.current_sort){
              var items = this.match_set.all_sorted_cids(this.current_sort);
              items = items.slice(this.page_size * page,this.page_size * (page + 1));
              var ordered_cids = _(items).clone().sort(function(a,b){return a-b;});
              var unsorted_items = this.collection.get(ordered_cids);
              items = _(items).map(function(i){return _(unsorted_items).find(function(o){return o.cid === i;});});
            } else {
              var items = this.match_set.cids;
              items = items.slice(this.page_size * page,this.page_size * (page + 1));
              items = this.collection.get(items);
            }
          }
          return items;
        },

        storeViewPosition: function(){
            var head_item =  this.getCurrentItems()[0];
            if(head_item){
                this.last_head_cid = head_item.cid;
            }
        },

        resetPage: function(){
            if(this.last_head_cid){
                if(this.current_sort){
                    this.current_sort.rebuild_sort();
                }
                this.pageTo(this.last_head_cid,true);
            }
            this.last_head_cid = undefined;
        },

        // Change the page of the view by [dir] pages. Negative values to page back.
        page: function(dir){
          var new_dir = dir + this.current_page;
          if(new_dir < 0) new_dir = 0;
          if(new_dir > Math.ceil(this.match_set.length()/this.page_size - 1)) new_dir = Math.ceil(this.match_set.length()/this.page_size - 1);
          this.current_page = new_dir;
          this.trigger("pageChange");
        },

        // Page to a specific cid.
        pageTo: function(cid,silent){
          if(typeof(silent) == "undefined"){
            var silent = false;
          }
          if(this.current_sort){
            var index = _(this.match_set.all_sorted_cids(this.current_sort)).indexOf(cid),
                len = this.match_set.cids.length,
                page = Math.floor(index/this.page_size);
          } else {
            var index = _(this.match_set.cids).indexOf(cid),
                len = this.match_set.cids.length,
                page = Math.floor(index/this.page_size);
          }
          if(index >= 0){
              this.current_page = page;
              if(! silent){
                this.trigger("pageChange");
              }
          }
        },

        // Change the page of the view to a specific page.
        setPage: function(page) {
          if(page < 0) page = 0;
          if(page > Math.ceil(this.match_set.length()/this.page_size - 1)) page = Math.ceil(this.match_set.length()/this.page_size - 1);
          this.current_page = page;
          this.trigger("pageChange");
        },

        // Set the page size.
        setPageSize: function(size){
          this.page_size = size;
          this.trigger("pageChange");
        },
        render: function(){}
      });

      // #MatchSets
      //
      // These are what are returned from queries on filters. They can be chained together with ands, or, & nots.
      // They also keep a "stack" to remember how they were created (after chaining) so that they can refresh themselves.
      PourOver.MatchSet = function(cids,collection,stack){
        this.cids = cids;
        this.collection = collection;
        this.stack = stack;
        this.initialize.apply(this, arguments);
      };
      _.extend(PourOver.MatchSet.prototype,PourOver.Events,{
        initialize: function(){},

        // When the underlying data has changed re-evaluate which items are included in this possibily compound result.
        refresh: function(s,match_set){
         if(typeof(s) === "undefined"){var s = this.stack || []}
         if(s.length < 1 && match_set){
           this.cids = match_set.cids;
           return this;
         } else if (s.length < 1){
           this.cids = false;
           return this;
         }

         var step = s[0],
             operation = step[0],
             is_compound = function(c){return _.isString(c) && c.match(/^(or|and|not)$/);};
         if(typeof(operation) === "object"){
           var match_set = operation.getFn(step[1]);
           return this.refresh(_(s).rest(),match_set);
         } else if(operation === "all" || step === "all") {
           var cids = _(this.collection.items).map(function(i){return i.cid;});
           var match_set = new PourOver.MatchSet(cids,this,["all"]);
           return this.refresh(_(s).rest(),match_set)
         } else if(is_compound(operation)) {
             var m = match_set[operation](this.refresh(step[1]));
         } else {
             var m = this.refresh(step[1]);
         }
         return this.refresh(_(s).rest(),m);
        },

        // Intersect this MatchSet with another MatchSet.
        and: function(other_matches){
          if(this.stack.length < 1 && other_matches){
            return other_matches;
          } else if (!other_matches){
            return this;
          } else {
            var set = PourOver.intersect_sorted(this.cids,other_matches.cids);
            return new PourOver.MatchSet(set,this.collection,this.stack.concat([["and",other_matches.stack]]))
          }
        },

        // Union this MatchSet with another MatchSet.
        or: function(other_matches){
          if(this.stack.length < 1 && other_matches){
            return other_matches;
          } else if (!other_matches){
            return this;
          } else {
            var set = PourOver.union_sorted(this.cids,other_matches.cids);
            return new PourOver.MatchSet(set,this.collection,this.stack.concat([["or",other_matches.stack]]));
          }
        },

        // Difference this MatchSet with another MatchSet.
        not: function(other_matches){
          if(this.stack.length < 1 || ! other_matches){
            return this;
          } else {
            var set = PourOver.subtract_sorted(this.cids,other_matches.cids);
            return new PourOver.MatchSet(set,this.collection,this.stack.concat([["not",other_matches.stack]]));
          }
        },

        // Return all the items corresponding to the cids cached on the MatchSet.
        all: function(){ return this.collection.get(this.cids);},

        // Return a slice of the items corresponding to the cids cached on the MatchSet.
        slice: function(s,e){ return this.collection.get(this.cids.slice(s,e)) },

        // Return all the items corresponding to the cids cached on the MatchSet AND sorted by sort s.
        all_sorted: function(s){
          var c = this.all();
          if(s){
            return s.sort(c);
          } else {
            return c;
          }
        },

        // Sort the cached cids.
        all_sorted_cids: function(s){
          var c = this.cids;
          if(s){
            return s.sort(c);
          } else {
            return c;
          }
        },

        // Return how many items comprise this MatchSet.
        length: function(){return this.cids.length}
      });


    // #PourOver.UI
    // PourOver.UI is a simple add-on for creating objects to be rendered as UI elements controlling the
    // state of filters and views.
    PourOver.UI = {}
    PourOver.UI.Element = function(opts){
        if(typeof(opts) === "undefined"){var opts = {}}
        _.extend(this,opts)
        this.initialize.apply(this, arguments);
    }

    _.extend(PourOver.UI.Element.prototype,PourOver.Events,{
      initialize: function(){},
      getMatchSet: function(){
        throw "No get match set function specified"
      },
      getFilterState: function(){
        throw "No get filter state specified";
      },
      template: function(){
        throw "No template specified"
      },
      render: function(){
        var filter_state = this.getFilterState(),
            output = this.template({state:filter_state});
        return output
      },
      // Pass in a MatchSet that only has a single query of a chain of OR'ed queried and receive
      // an array of possibility names that have been selected.
      getSimpleSelectState: function(match_set,s,output){
          if(typeof(match_set) === "undefined" || !match_set || !match_set.stack){return false}
          if(typeof(s) === "undefined"){var s = match_set.stack}
          if(typeof(output) === "undefined"){var output = []}
          if(s.length < 1){
            return output;
          } else if (typeof(s[0][0]) === "object"){
            output.push(s[0][1]);
            return this.getSimpleSelectState(match_set,_(s).rest(),output);
          } else if (s[0][0] === "or"){
            output = output.concat(this.getSimpleSelectState(match_set,s[0][1]));
            return this.getSimpleSelectState(match_set,_(s).rest(),output);
          } else {
            throw "This does not appear to be a valid, simple selectElement stack."
          }
      },
      getIntersectedSelectState: function(match_set,s,output){
          if(typeof(match_set) === "undefined" || !match_set || !match_set.stack){return false}
          if(typeof(s) === "undefined"){var s = match_set.stack}
          if(typeof(output) === "undefined"){var output = []}
          if(s.length < 1){
            return output;
          } else if (typeof(s[0][0]) === "object"){
            output.push(s[0][1]);
            return this.getIntersectedSelectState(match_set,_(s).rest(),output);
          } else if (s[0][0] === "and"){
            output = output.concat(this.getIntersectedSelectState(match_set,s[0][1]));
            return this.getIntersectedSelectState(match_set,_(s).rest(),output);
          } else {
            throw "This does not appear to be a valid, simple selectElement stack."
          }
      },

      // Pass in a MatchSet that is the result of a single, non-compounded range and receive the
      // value of that range.
      getSimpleRangeState: function(match_set){
        if(typeof(match_set) === "undefined" || !match_set || !match_set.stack){return false}
        stack = match_set.stack;
        if(stack.length !== 1 || stack[0][1].length !== 2){throw "The filter specified does not appear to have a simple range stack."}
        return stack[0][1];
      }

      // TODO: Added more UI gets.
    });


    // From Backbone
    // Helper function to correctly set up the prototype chain, for subclasses.
      // Similar to `goog.inherits`, but uses a hash of prototype properties and
      // class properties to be extended.
      PourOver.extend = function(protoProps, staticProps) {
          var parent = this;
          var child;

          // The constructor function for the new subclass is either defined by you
          // (the "constructor" property in your `extend` definition), or defaulted
          // by us to simply call the parent's constructor.
          if (protoProps && _.has(protoProps, 'constructor')) {
            child = protoProps.constructor;
          } else {
            child = function() {
              return parent.apply(this, arguments);
            };
          }

          // Add static properties to the constructor function, if supplied.
          _.extend(child, parent, staticProps);

          // Set the prototype chain to inherit from `parent`, without calling
          // `parent`'s constructor function.
          var Surrogate = function() {
              this.constructor = child;
            };
          Surrogate.prototype = parent.prototype;
          child.prototype = new Surrogate;

          // Add prototype properties (instance properties) to the subclass,
          // if supplied.
          if (protoProps) _.extend(child.prototype, protoProps);

          // Set a convenience property in case the parent's prototype is needed
          // later.
          child.__super__ = parent.prototype;

          return child;
        };


      PourOver.Collection.extend = PourOver.View.extend = PourOver.Filter.extend = PourOver.Sort.extend = PourOver.MatchSet.extend = PourOver.UI.Element.extend = PourOver.extend

      // #Presets

      // A PourOver buffered collection is one that stores some or all of its data as a promise. This is useful in conjunction with a
      // large data set in which you don't want to load all the data at page open.
      PourOver.BufferedCollection = PourOver.Collection.extend({
        buffered_items: {},
        stripFutures: function(item){
          return _(item).reduce(function(m,v,k){if(typeof(v) != "undefined"){m[k] = v} return m},{});
        },

        // Overrides the base get function with one that buffers in whole values from the server
        get: function(cids,raw){
          if(typeof(raw) === "undefined"){var raw = false}
          var items = PourOver.Collection.prototype.get.call(this,cids),
              that = this;
          if(raw){return items;}
          return _(items).map(function(i){
            var guid = i.guid, new_item;
            if(that.buffered_items.hasOwnProperty(guid)){
              return _(that.buffered_items[guid]).extend(that.stripFutures(i));
            } else {
              return i;
            }
          });
        },
        getBy: function(attr_name,vals,sorted,raw){
          if(typeof(raw) === "undefined"){var raw = false}
          var items = PourOver.Collection.prototype.getBy.call(this,attr_name,vals,sorted),
              that = this;
          if(raw){return items;}
          return _(items).map(function(i){
            var guid = i.guid, new_item;
            if(that.buffered_items.hasOwnProperty(guid)){
              return _(that.buffered_items[guid]).extend(that.stripFutures(i));
            } else {
              return i;
            }
          });
        },

        // Retrieve a specific attr of a specific item from the buffer.
        getBufferedValue: function(guid,attr){
          if(this.buffered_items.hasOwnProperty(guid)){
            return this.buffered_items[guid][attr] || false;
          } else {
            return false;
          }
        },

        // Delete all buffered values for items in the collection.
        clearBufferedItems: function (){
          var buffered_items = this.buffered_items;
          for (var p in buffered_items){
            if (buffered_items.hasOwnProperty(p)){
                delete buffered_items[p];
            }
          }
        },

        // When instantiating a buffered collection you must provide this method. This is how a buffered collection
        // knows what URL to fetch new data from.
        getBufferUrl: function(guids){
          throw "You must override getBufferUrl;"
        },
        preprocessItem: function(item){
          return [item["guid"],item]
        },

        // Pull down new data for an array of guids from the server at the URL returned by getBufferUrl. When the request returns,
        // push the new values into the buffer. The deferred object is returned from this method so you can chain additional callbacks
        // onto the resolution such as a render action.
        bufferGuids: function(guids){
          var that = this,
              guids = _(guids).select(function(g){ return g &&  ! that.buffered_items.hasOwnProperty(g);}),
              buffurl = this.getBufferUrl(guids),
              url = buffurl[0],
              jsonpCallback = buffurl[1];
          if(guids.length > 0){
            return $.ajax({
              url: url,
              dataType:'jsonp',
              cache: true
            }).always(function(d){
              if(_.isArray(d)){
                items = _(d).map(_.bind(that.preprocessItem,that));
                _(items).each(function(i){
                  that.buffered_items[i[0]] = i[1];
                });
              }
            });
          } else {
            return $.Deferred().resolve(false);
          }
        }
      });

      // A buffered view is the pair to a buffered collection. It calls the appropriate buffering methods of the buffered collection
      // so that you automatically get the benefits of buffering as you are paging through the view. If you use a buffered view with a buffered collection
      // you shouldn't need to call the buffering methods of the collection explicitly.
      PourOver.BufferedView = PourOver.View.extend({
        buffer_pages: 1,
        bufferAroundCurrentPage: function(){
          var current_page = this.current_page,
              low_bound = current_page - this.buffer_pages > 0 ? current_page - this.buffer_pages : 0,
              high_bound = current_page + this.buffer_pages,
              range = _.range(low_bound,high_bound + 1),
              that = this;
          range = _(range).map(function(page){
            return _(that.getCurrentItems(page)).pluck("guid");
          });
          var guids = _.flatten(range);
          buffer_deferred = this.collection.bufferGuids(guids);
          buffer_deferred.done(function(d){
              if(d){
                that.render();
              }
          })
        },
        bufferRender: function(){
          var guids = _(this.getCurrentItems()).pluck('guid'),
              buffer_deferred = this.collection.bufferGuids(guids);
          buffer_deferred.done(_(function(){
            this.render()
          }).bind(this));
        },
        page: function(dir){
          PourOver.View.prototype.page.call(this,dir);
          this.bufferAroundCurrentPage();
        },
        pageTo: function(cid,silent){
          if(typeof(silent) === "undefined"){
            var silent = false;
          }
          PourOver.View.prototype.pageTo.call(this,cid,silent);
          this.bufferAroundCurrentPage();
        }
      })

      // ## Filter defaults
      //
      // A strange filter that selects items based on an explicit list of cids. This is useful when you want to use PourOver in association
      // with, say, an editorially composed list of items or any mechanic in which you can "select" items to be included in a filter independent of
      // any attribute.
      PourOver.manualFilter = PourOver.Filter.extend({
        cacheResults: function(){return false},
        addCacheResults: function(){return false},
        getFn: function(query){
          if(_(query).isArray()){
            query = query.sort(function(a,b){return a - b})
            return new PourOver.MatchSet(query,this.getCollection(),[[this,query]]);
          } else if (typeof(query) === "number") {
            return new PourOver.MatchSet([query],this.getCollection(),[[this,query]]);
          } else {
            throw "Manual filters only support querying by one or more cids"
          }
        },
        addItems: function(cids){
          if(! _(cids).isArray()){cids = [cids]}
          cids = cids.sort(function(a,b){return a - b});
          if(this.current_query){
            var current_query = this.current_query.cids,
                new_query = PourOver.union_sorted(current_query,cids);
          } else {
            var new_query = cids;
          }
          this.query(new_query);
        },
        removeItems: function(cids){
          if(! _(cids).isArray()){cids = [cids]}
          cids = cids.sort(function(a,b){return a - b});
          var current_query = this.current_query.cids,
              new_query = PourOver.subtract_sorted(current_query,cids);
          this.query(new_query);
        }
      });

      // The convenience constructor for manual filters.
      PourOver.makeManualFilter = function(name){
        var filter = new PourOver.manualFilter(name,[]);
        return filter;
      }

      // An exact filter is the most commonly used filter. Given an attribute and a list of possibilities, an exact filter will bucket the items
      // into those satisfying each of the possibilities. This also has the fastest peformance as far as creating and updating.
      PourOver.exactFilter = PourOver.Filter.extend({
        cacheResults: PourOver.cacheMethods.exactCache,
        addCacheResults: PourOver.cacheMethods.exactAddCache,
        getFn: function(query){
          var that = this;
          if(_(query).isArray()){
            var match_set = _(query).reduce(function(m,i){
              if(!m){
                return that.getFn(i);
              } else {
                return m.or(that.getFn(i));
              }
            },false);
            return match_set;
          } else {
            var possibility = this.possibilities[query];
            if (_.isUndefined(possibility) ) throw "The filter " + this.name + " does not have a match for the query '" + query + "'.";
            return new PourOver.MatchSet(possibility.matching_cids,this.getCollection(),[[this,query]]);
          }
        }
      });

      // The convenience constructor for exact filters.
      PourOver.makeExactFilter = function(name,values,opts){
        if(typeof(opts) === "undefined"){opts = {}}
        var values = _(values).map(function(i){return {value:i}}),
            attr = opts.attr || name,
            opts = _.extend({associated_attrs: [attr]},opts),
            filter = new PourOver.exactFilter(name,values,opts);
        return filter;
      }

      PourOver.inclusionFilter = PourOver.exactFilter.extend({
        cacheResults: PourOver.cacheMethods.inclusionCache,
        addCacheResults: PourOver.cacheMethods.inclusionAddCache
      });

      PourOver.makeInclusionFilter = function(name,values,opts){
        if(typeof(opts) === "undefined"){opts = {}}
        var values = _(values).map(function(i){return {value:i}}),
            attr = opts.attr || name,
            opts = _.extend({associated_attrs: [attr]},opts),
            filter = new PourOver.inclusionFilter(name,values,opts);
        return filter;
      };

      // A range filter is for dividing items into buckets of ranges based on a specific attribute. A good example is, say, each item as 0-1000 "friends", then you can
      // supply a range filter with the possibilities: [[0,10],[11,100],[101,1000]] and it will create buckets for 0-10, 11-100, and 101 + friends.
      PourOver.rangeFilter = PourOver.Filter.extend({
        cacheResults: PourOver.cacheMethods.defaultCache,
        addCacheResults: PourOver.cacheMethods.defaultAddCache,
        fn: function(possibility,item){
          var attr = this.attr || this.name;
          return possibility.low <= item[attr] && possibility.high >= item[attr]
        },
        getFn: function(query){
          var possibility = this.possibilities[query.join("-")];
          if (_.isUndefined(possibility) ) throw "The filter " + this.name + " does not have a match for the query '" + query + "'.";
          return new PourOver.MatchSet(possibility.matching_cids,this.getCollection(),[[this,query]]);
        }
      });

      // The convenience constructor for range filters.
      PourOver.makeRangeFilter = function(name,ranges,opts){
        if(typeof(opts) === "undefined"){opts = {}}
        var values = _(ranges).map(function(r){return {low: r[0], high: r[1], value: r.join("-")}}),
            attr = opts.attr || name,
            newopts = _.extend({associated_attrs: [attr]},opts),
            filter = new PourOver.rangeFilter(name,values,newopts);
        return filter;
      }

      // The inverse of a range filter. Again each item has single value for a certain attribute, but the possibilities you provide are every value of that attribute.
      // Then, you query by a range. So, if a person can have 1-10 hats, you would feed a dv range filter the possibilities [1,2,3,4,5,6,7,8,9,10] and then make
      // queries such as [2,5] for 2-5 hats. Do not use this for huge ranges like 1-100. Use crossfilter or write some optimized way of doing this. PourOver is not optimized
      // for that kind of continuous query.
      PourOver.dvrangeFilter = PourOver.Filter.extend({
        cacheResults:  PourOver.cacheMethods.exactCache,
        addCacheResults: PourOver.cacheMethods.exactAddCache,
        getFn: function(query){
          if(! query[0] || ! query[1]){
            return new PourOver.MatchSet([],this.getCollection(),[[this,query]]);
          }
          var li,hi,that,possibilities,cids;
          li = _(this.values).indexOf(query[0]);
          hi = _(this.values).indexOf(query[1]);
          that = this;
          possibilities = _(this.values.slice(li,hi+1)).map(function(p){return that.possibilities[p]});
          cids = _(possibilities).reduce(function(m,i){ return PourOver.union_sorted(m,i.matching_cids) },[]);
          return new PourOver.MatchSet(cids,this.getCollection(),[[this,query]]);
        }
      });

      // The convenience constructor for dv range filters.
      PourOver.makeDVrangeFilter = function(name,v,opts){
        if(typeof(opts) === "undefined"){opts = {}}
        var values = _(v).map(function(i){return {value:i}}),
            attr = opts.attr || name,
            newopts = _.extend({associated_attrs: [attr]},opts),
            filter = new PourOver.dvrangeFilter(name,values,newopts);
        return filter
      }

      // Filter for data with a continuous range or many possible values, such as dates, floats, etc.
      // Query with a scalar to query by exact value, or query with a length-2 array to
      // query a range (as in dvrangeFilter) such that the value is greater than or equal
      // to range[0] and less than range[1].
      PourOver.continuousRangeFilter = PourOver.Filter.extend({
        cacheResults: function(items){
          this.values = _.map(items, function(i) { return {cid: i.cid, val: i[this.name]}; }, this);
          this.values.sort(function(a,b) { return a.val-b.val });
        },
        addCacheResults: function(items){
          this.values = this.values.concat(items);
          this.values.sort(function(a,b) { return a.val-b.val });
        },
        getFn: function(query){
          var li,hi;
          var n = this.values.length;

          var bisect = PourOver.bisect_by( function(a) { return a.val });

          if(_.isArray(query)){
            // range filter
            if(_.isUndefined(query[0]) || _.isUndefined(query[1])){
              return new PourOver.MatchSet([],this.getCollection(),[[this,query]]);
            }
            li = bisect.left(this.values, query[0], 0, n);
            hi = bisect.left(this.values, query[1], 0, n);
          } else {
            // exact filter
            if(_.isUndefined(query)){
              return new PourOver.MatchSet([],this.getCollection(),[[this,query]]);
            }

            li = bisect.left(this.values, query, 0, n);
            hi = bisect.right(this.values, query, 0, n);
          }

          var cids = [];
          var i=li;
          while(i<hi) {
            cids.push(this.values[i].cid);
            ++i;
          }
          cids.sort(function(a,b) { return a-b });
          return new PourOver.MatchSet(cids,this.getCollection(),[[this,query]]);
        }
      });

      // The convenience constructor for continuous range filters.
      PourOver.makeContinuousRangeFilter = function(name,opts){
        if(typeof(opts) === "undefined"){opts = {}}
        var attr = opts.attr || name,
            newopts = _.extend({associated_attrs: [attr]},opts),
            filter = new PourOver.continuousRangeFilter(name,newopts);
        return filter;
      }

      // ## Preset sorts
      //
      // Sorts items based on an explicit ordering of values. This would be useful for, say, a slideshow in which
      // the order of items has nothing to do with any of their filterable attributes. Comes with methods to reorganize
      // the items in the sort.
      PourOver.explicitSort = PourOver.Sort.extend({
        fn: function(a,b){
          var a_index = _(this.order).indexOf(a[this.attr]),
              b_index = _(this.order).indexOf(b[this.attr]);
          if(a_index === -1) {a_index = 1/0}
          if(b_index === -1) {b_index = 1/0}
          return a_index - b_index;
        },
        reset: function(items){
          this.order = _(items).pluck(this.attr);
          this.rebuild_sort();
        },

        // Insert an item into the sort.
        insert: function(items,index){
          if(typeof(index) === "undefined"){var index = this.order.length}
          if(! _(items).isArray()){items = [items]}
          var new_order = _(items).pluck(this.attr),
              args = [index,0].concat(new_order);
          this.order.splice.apply(this.order,args);
          this.rebuild_sort();
        },

        // Remove an item from the sort.
        remove: function(items){
          if(! _(items).isArray()){items = [items]}
          var attrs = _(items).pluck(this.attr);
          this.order = _(this.order).difference(attrs);
          this.rebuild_sort();
        },

        // Move an item from one place to another in the sort.
        move: function(items,index){
          if(! _(items).isArray()){items = [items]}
          var attrs = _(items).pluck(this.attr);
          this.order = _(this.order).map(function(o){ return _(attrs).include(o) ? null : o });
          this.insert(items,index);
          this.order = _(this.order).compact();
        }
      });

      // The convenience constructor for an explicit sort.
      PourOver.makeExplicitSort = function(name,collection,attr,order,opts){
        var sort = new PourOver.explicitSort(name,opts);
        sort.attr = attr;
        sort.order = order;
        return sort;
      }

      PourOver.reverseCidSort = PourOver.Sort.extend({
        fn: function(a,b){
            return b.cid - a.cid;
        }
      })

      PourOver.makeReverseCidSort = function(name,collection){
        var sort = new PourOver.reverseCidSort(name);
        sort.attr = "cid";
        return sort;
      }

      // ## Preset UI elements
      //
      // A simple select element is roughly equavalent to elements such as a checklist or a radio list.
      // Items can only be unioned together. One or more selected.
      PourOver.UI.SimpleSelectElement = PourOver.UI.Element.extend({
        initialize: function(opts){
          if(!opts.filter){throw "A simple select element must have a filter specified"}
          this.filter = opts.filter;
        },
        getMatchSet: function(){
          return this.filter.current_query;
        },
        getFilterState: function(){
          var match_set = this.getMatchSet();
          return this.getSimpleSelectState(match_set)
        }
      });

      // A dv range element can be used for a slider in which you set the low and high and the query
      // corresponds to everything in between.
      PourOver.UI.SimpleDVRangeElement = PourOver.UI.Element.extend({
        initialize: function(opts){
          if(!opts.filter){throw "A simple dv range element must have a filter specified"}
          this.filter = opts.filter;
        },
        getMatchSet: function(){
          return this.filter.current_query;
        },
        getFilterState: function(){
          var match_set = this.getMatchSet();
          return this.getSimpleRangeState(match_set)
        }
      });

    return PourOver;
})();


define("lib/pourover", function(){});

/*!
 * Pusher JavaScript Library v2.2.0
 * //pusherapp.com/
 *
 * Copyright 2013, Pusher
 * Released under the MIT licence.
 */

(function(lib){
    if(typeof define === 'function' && define.amd){
        define('lib/pusher.min',[],lib);
    } else {
        window.Pusher = lib();
    }
}(function(){
    (function(){function b(a,d){(null===a||void 0===a)&&b.warn("Warning","You must pass your app key when you instantiate Pusher.");d=d||{};var c=this;this.key=a;this.config=b.Util.extend(b.getGlobalConfig(),d.cluster?b.getClusterConfig(d.cluster):{},d);this.channels=new b.Channels;this.global_emitter=new b.EventsDispatcher;this.sessionID=Math.floor(1E9*Math.random());this.timeline=new b.Timeline(this.key,this.sessionID,{cluster:this.config.cluster,features:b.Util.getClientFeatures(),params:this.config.timelineParams||
    {},limit:50,level:b.Timeline.INFO,version:b.VERSION});this.config.disableStats||(this.timelineSender=new b.TimelineSender(this.timeline,{host:this.config.statsHost,path:"/timeline/v2/jsonp"}));this.connection=new b.ConnectionManager(this.key,b.Util.extend({getStrategy:function(a){a=b.Util.extend({},c.config,a);return b.StrategyBuilder.build(b.getDefaultStrategy(a),a)},timeline:this.timeline,activityTimeout:this.config.activity_timeout,pongTimeout:this.config.pong_timeout,unavailableTimeout:this.config.unavailable_timeout},
    this.config,{encrypted:this.isEncrypted()}));this.connection.bind("connected",function(){c.subscribeAll();c.timelineSender&&c.timelineSender.send(c.connection.isEncrypted())});this.connection.bind("message",function(a){var d=0===a.event.indexOf("pusher_internal:");if(a.channel){var b=c.channel(a.channel);b&&b.handleEvent(a.event,a.data)}d||c.global_emitter.emit(a.event,a.data)});this.connection.bind("disconnected",function(){c.channels.disconnect()});this.connection.bind("error",function(a){b.warn("Error",
    a)});b.instances.push(this);this.timeline.info({instances:b.instances.length});b.isReady&&c.connect()}var c=b.prototype;b.instances=[];b.isReady=!1;b.debug=function(){b.log&&b.log(b.Util.stringify.apply(this,arguments))};b.warn=function(){var a=b.Util.stringify.apply(this,arguments);window.console&&(window.console.warn?window.console.warn(a):window.console.log&&window.console.log(a));b.log&&b.log(a)};b.ready=function(){b.isReady=!0;for(var a=0,d=b.instances.length;a<d;a++)b.instances[a].connect()};
    c.channel=function(a){return this.channels.find(a)};c.allChannels=function(){return this.channels.all()};c.connect=function(){this.connection.connect();if(this.timelineSender&&!this.timelineSenderTimer){var a=this.connection.isEncrypted(),d=this.timelineSender;this.timelineSenderTimer=new b.PeriodicTimer(6E4,function(){d.send(a)})}};c.disconnect=function(){this.connection.disconnect();this.timelineSenderTimer&&(this.timelineSenderTimer.ensureAborted(),this.timelineSenderTimer=null)};c.bind=function(a,
    d){this.global_emitter.bind(a,d);return this};c.bind_all=function(a){this.global_emitter.bind_all(a);return this};c.subscribeAll=function(){for(var a in this.channels.channels)this.channels.channels.hasOwnProperty(a)&&this.subscribe(a)};c.subscribe=function(a){a=this.channels.add(a,this);"connected"===this.connection.state&&a.subscribe();return a};c.unsubscribe=function(a){a=this.channels.remove(a);"connected"===this.connection.state&&a.unsubscribe()};c.send_event=function(a,d,b){return this.connection.send_event(a,
    d,b)};c.isEncrypted=function(){return"https:"===b.Util.getDocument().location.protocol?!0:Boolean(this.config.encrypted)};b.HTTP={};this.Pusher=b}).call(this);
    (function(){function b(a){window.clearTimeout(a)}function c(a){window.clearInterval(a)}function a(a,d,b,c){var k=this;this.clear=d;this.timer=a(function(){null!==k.timer&&(k.timer=c(k.timer))},b)}var d=a.prototype;d.isRunning=function(){return null!==this.timer};d.ensureAborted=function(){this.timer&&(this.clear(this.timer),this.timer=null)};Pusher.Timer=function(d,c){return new a(setTimeout,b,d,function(a){c();return null})};Pusher.PeriodicTimer=function(d,b){return new a(setInterval,c,d,function(a){b();
    return a})}}).call(this);
    (function(){Pusher.Util={now:function(){return Date.now?Date.now():(new Date).valueOf()},defer:function(b){return new Pusher.Timer(0,b)},extend:function(b){for(var c=1;c<arguments.length;c++){var a=arguments[c],d;for(d in a)b[d]=a[d]&&a[d].constructor&&a[d].constructor===Object?Pusher.Util.extend(b[d]||{},a[d]):a[d]}return b},stringify:function(){for(var b=["Pusher"],c=0;c<arguments.length;c++)"string"===typeof arguments[c]?b.push(arguments[c]):void 0===window.JSON?b.push(arguments[c].toString()):b.push(JSON.stringify(arguments[c]));
    return b.join(" : ")},arrayIndexOf:function(b,c){var a=Array.prototype.indexOf;if(null===b)return-1;if(a&&b.indexOf===a)return b.indexOf(c);for(var a=0,d=b.length;a<d;a++)if(b[a]===c)return a;return-1},objectApply:function(b,c){for(var a in b)Object.prototype.hasOwnProperty.call(b,a)&&c(b[a],a,b)},keys:function(b){var c=[];Pusher.Util.objectApply(b,function(a,d){c.push(d)});return c},values:function(b){var c=[];Pusher.Util.objectApply(b,function(a){c.push(a)});return c},apply:function(b,c,a){for(var d=
    0;d<b.length;d++)c.call(a||window,b[d],d,b)},map:function(b,c){for(var a=[],d=0;d<b.length;d++)a.push(c(b[d],d,b,a));return a},mapObject:function(b,c){var a={};Pusher.Util.objectApply(b,function(d,b){a[b]=c(d)});return a},filter:function(b,c){c=c||function(a){return!!a};for(var a=[],d=0;d<b.length;d++)c(b[d],d,b,a)&&a.push(b[d]);return a},filterObject:function(b,c){var a={};Pusher.Util.objectApply(b,function(d,h){if(c&&c(d,h,b,a)||Boolean(d))a[h]=d});return a},flatten:function(b){var c=[];Pusher.Util.objectApply(b,
    function(a,d){c.push([d,a])});return c},any:function(b,c){for(var a=0;a<b.length;a++)if(c(b[a],a,b))return!0;return!1},all:function(b,c){for(var a=0;a<b.length;a++)if(!c(b[a],a,b))return!1;return!0},method:function(b){var c=Array.prototype.slice.call(arguments,1);return function(a){return a[b].apply(a,c.concat(arguments))}},getWindow:function(){return window},getDocument:function(){return document},getNavigator:function(){return navigator},getLocalStorage:function(){try{return window.localStorage}catch(b){}},
    getClientFeatures:function(){return Pusher.Util.keys(Pusher.Util.filterObject({ws:Pusher.WSTransport,flash:Pusher.FlashTransport},function(b){return b.isSupported({})}))},addWindowListener:function(b,c){var a=Pusher.Util.getWindow();void 0!==a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},removeWindowListener:function(b,c){var a=Pusher.Util.getWindow();void 0!==a.addEventListener?a.removeEventListener(b,c,!1):a.detachEvent("on"+b,c)},isXHRSupported:function(){var b=window.XMLHttpRequest;
    return Boolean(b)&&void 0!==(new b).withCredentials},isXDRSupported:function(b){b=b?"https:":"http:";var c=Pusher.Util.getDocument().location.protocol;return Boolean(window.XDomainRequest)&&c===b}}}).call(this);
    (function(){Pusher.VERSION="2.2.0";Pusher.PROTOCOL=7;Pusher.host="ws.pusherapp.com";Pusher.ws_port=80;Pusher.wss_port=443;Pusher.sockjs_host="sockjs.pusher.com";Pusher.sockjs_http_port=80;Pusher.sockjs_https_port=443;Pusher.sockjs_path="/pusher";Pusher.stats_host="stats.pusher.com";Pusher.channel_auth_endpoint="/pusher/auth";Pusher.channel_auth_transport="ajax";Pusher.activity_timeout=12E4;Pusher.pong_timeout=3E4;Pusher.unavailable_timeout=1E4;Pusher.cdn_http="//js.pusher.com/";Pusher.cdn_https=
    "https://d3dy5gmtp8yhk7.cloudfront.net/";Pusher.dependency_suffix=".min";Pusher.getDefaultStrategy=function(b){return[[":def","ws_options",{hostUnencrypted:b.wsHost+":"+b.wsPort,hostEncrypted:b.wsHost+":"+b.wssPort}],[":def","wss_options",[":extend",":ws_options",{encrypted:!0}]],[":def","sockjs_options",{hostUnencrypted:b.httpHost+":"+b.httpPort,hostEncrypted:b.httpHost+":"+b.httpsPort}],[":def","timeouts",{loop:!0,timeout:15E3,timeoutLimit:6E4}],[":def","ws_manager",[":transport_manager",{lives:2,
    minPingDelay:1E4,maxPingDelay:b.activity_timeout}]],[":def","streaming_manager",[":transport_manager",{lives:2,minPingDelay:1E4,maxPingDelay:b.activity_timeout}]],[":def_transport","ws","ws",3,":ws_options",":ws_manager"],[":def_transport","wss","ws",3,":wss_options",":ws_manager"],[":def_transport","flash","flash",2,":ws_options",":ws_manager"],[":def_transport","sockjs","sockjs",1,":sockjs_options"],[":def_transport","xhr_streaming","xhr_streaming",1,":sockjs_options",":streaming_manager"],[":def_transport",
    "xdr_streaming","xdr_streaming",1,":sockjs_options",":streaming_manager"],[":def_transport","xhr_polling","xhr_polling",1,":sockjs_options"],[":def_transport","xdr_polling","xdr_polling",1,":sockjs_options"],[":def","ws_loop",[":sequential",":timeouts",":ws"]],[":def","wss_loop",[":sequential",":timeouts",":wss"]],[":def","flash_loop",[":sequential",":timeouts",":flash"]],[":def","sockjs_loop",[":sequential",":timeouts",":sockjs"]],[":def","streaming_loop",[":sequential",":timeouts",[":if",[":is_supported",
    ":xhr_streaming"],":xhr_streaming",":xdr_streaming"]]],[":def","polling_loop",[":sequential",":timeouts",[":if",[":is_supported",":xhr_polling"],":xhr_polling",":xdr_polling"]]],[":def","http_loop",[":if",[":is_supported",":streaming_loop"],[":best_connected_ever",":streaming_loop",[":delayed",4E3,[":polling_loop"]]],[":polling_loop"]]],[":def","http_fallback_loop",[":if",[":is_supported",":http_loop"],[":http_loop"],[":sockjs_loop"]]],[":def","strategy",[":cached",18E5,[":first_connected",[":if",
    [":is_supported",":ws"],b.encrypted?[":best_connected_ever",":ws_loop",[":delayed",2E3,[":http_fallback_loop"]]]:[":best_connected_ever",":ws_loop",[":delayed",2E3,[":wss_loop"]],[":delayed",5E3,[":http_fallback_loop"]]],[":if",[":is_supported",":flash"],[":best_connected_ever",":flash_loop",[":delayed",2E3,[":http_fallback_loop"]]],[":http_fallback_loop"]]]]]]]}}).call(this);
    (function(){Pusher.getGlobalConfig=function(){return{wsHost:Pusher.host,wsPort:Pusher.ws_port,wssPort:Pusher.wss_port,httpHost:Pusher.sockjs_host,httpPort:Pusher.sockjs_http_port,httpsPort:Pusher.sockjs_https_port,httpPath:Pusher.sockjs_path,statsHost:Pusher.stats_host,authEndpoint:Pusher.channel_auth_endpoint,authTransport:Pusher.channel_auth_transport,activity_timeout:Pusher.activity_timeout,pong_timeout:Pusher.pong_timeout,unavailable_timeout:Pusher.unavailable_timeout}};Pusher.getClusterConfig=
    function(b){return{wsHost:"ws-"+b+".pusher.com",httpHost:"sockjs-"+b+".pusher.com"}}}).call(this);(function(){function b(b){var a=function(a){Error.call(this,a);this.name=b};Pusher.Util.extend(a.prototype,Error.prototype);return a}Pusher.Errors={BadEventName:b("BadEventName"),RequestTimedOut:b("RequestTimedOut"),TransportPriorityTooLow:b("TransportPriorityTooLow"),TransportClosed:b("TransportClosed"),UnsupportedTransport:b("UnsupportedTransport"),UnsupportedStrategy:b("UnsupportedStrategy")}}).call(this);
    (function(){function b(a){this.callbacks=new c;this.global_callbacks=[];this.failThrough=a}function c(){this._callbacks={}}var a=b.prototype;a.bind=function(a,b,c){this.callbacks.add(a,b,c);return this};a.bind_all=function(a){this.global_callbacks.push(a);return this};a.unbind=function(a,b,c){this.callbacks.remove(a,b,c);return this};a.unbind_all=function(a,b){this.callbacks.remove(a,b);return this};a.emit=function(a,b){var c;for(c=0;c<this.global_callbacks.length;c++)this.global_callbacks[c](a,b);
    var e=this.callbacks.get(a);if(e&&0<e.length)for(c=0;c<e.length;c++)e[c].fn.call(e[c].context||window,b);else this.failThrough&&this.failThrough(a,b);return this};c.prototype.get=function(a){return this._callbacks["_"+a]};c.prototype.add=function(a,b,c){a="_"+a;this._callbacks[a]=this._callbacks[a]||[];this._callbacks[a].push({fn:b,context:c})};c.prototype.remove=function(a,b,c){!a&&!b&&!c?this._callbacks={}:(a=a?["_"+a]:Pusher.Util.keys(this._callbacks),b||c?Pusher.Util.apply(a,function(a){this._callbacks[a]=
    Pusher.Util.filter(this._callbacks[a]||[],function(a){return b&&b!==a.fn||c&&c!==a.context});0===this._callbacks[a].length&&delete this._callbacks[a]},this):Pusher.Util.apply(a,function(a){delete this._callbacks[a]},this))};Pusher.EventsDispatcher=b}).call(this);
    (function(){function b(a,d){this.lastId=0;this.prefix=a;this.name=d}var c=b.prototype;c.create=function(a){this.lastId++;var d=this.lastId,b=this.prefix+d,c=this.name+"["+d+"]",e=!1,g=function(){e||(a.apply(null,arguments),e=!0)};this[d]=g;return{number:d,id:b,name:c,callback:g}};c.remove=function(a){delete this[a.number]};Pusher.ScriptReceiverFactory=b;Pusher.ScriptReceivers=new b("_pusher_script_","Pusher.ScriptReceivers")}).call(this);
    (function(){function b(a){this.src=a}var c=b.prototype;c.send=function(a){var d=this,b="Error loading "+d.src;d.script=document.createElement("script");d.script.id=a.id;d.script.src=d.src;d.script.type="text/javascript";d.script.charset="UTF-8";d.script.addEventListener?(d.script.onerror=function(){a.callback(b)},d.script.onload=function(){a.callback(null)}):d.script.onreadystatechange=function(){("loaded"===d.script.readyState||"complete"===d.script.readyState)&&a.callback(null)};void 0===d.script.async&&
    document.attachEvent&&/opera/i.test(navigator.userAgent)?(d.errorScript=document.createElement("script"),d.errorScript.id=a.id+"_error",d.errorScript.text=a.name+"('"+b+"');",d.script.async=d.errorScript.async=!1):d.script.async=!0;var c=document.getElementsByTagName("head")[0];c.insertBefore(d.script,c.firstChild);d.errorScript&&c.insertBefore(d.errorScript,d.script.nextSibling)};c.cleanup=function(){this.script&&(this.script.onload=this.script.onerror=null,this.script.onreadystatechange=null);this.script&&
    this.script.parentNode&&this.script.parentNode.removeChild(this.script);this.errorScript&&this.errorScript.parentNode&&this.errorScript.parentNode.removeChild(this.errorScript);this.errorScript=this.script=null};Pusher.ScriptRequest=b}).call(this);
    (function(){function b(a){this.options=a;this.receivers=a.receivers||Pusher.ScriptReceivers;this.loading={}}var c=b.prototype;c.load=function(a,d){var b=this;if(b.loading[a]&&0<b.loading[a].length)b.loading[a].push(d);else{b.loading[a]=[d];var c=new Pusher.ScriptRequest(b.getPath(a)),e=b.receivers.create(function(d){b.receivers.remove(e);if(b.loading[a]){var k=b.loading[a];delete b.loading[a];for(var l=function(a){a||c.cleanup()},m=0;m<k.length;m++)k[m](d,l)}});c.send(e)}};c.getRoot=function(a){var d=
    Pusher.Util.getDocument().location.protocol;return(a&&a.encrypted||"https:"===d?this.options.cdn_https:this.options.cdn_http).replace(/\/*$/,"")+"/"+this.options.version};c.getPath=function(a,d){return this.getRoot(d)+"/"+a+this.options.suffix+".js"};Pusher.DependencyLoader=b}).call(this);
    (function(){function b(){Pusher.ready()}function c(a){document.body?a():setTimeout(function(){c(a)},0)}function a(){c(b)}Pusher.DependenciesReceivers=new Pusher.ScriptReceiverFactory("_pusher_dependencies","Pusher.DependenciesReceivers");Pusher.Dependencies=new Pusher.DependencyLoader({cdn_http:Pusher.cdn_http,cdn_https:Pusher.cdn_https,version:Pusher.VERSION,suffix:Pusher.dependency_suffix,receivers:Pusher.DependenciesReceivers});window.JSON?a():Pusher.Dependencies.load("json2",a)})();
    (function(){for(var b=String.fromCharCode,c=0;64>c;c++)"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(c);var a=function(a){var d=a.charCodeAt(0);return 128>d?a:2048>d?b(192|d>>>6)+b(128|d&63):b(224|d>>>12&15)+b(128|d>>>6&63)+b(128|d&63)},d=function(a){var d=[0,2,1][a.length%3];a=a.charCodeAt(0)<<16|(1<a.length?a.charCodeAt(1):0)<<8|(2<a.length?a.charCodeAt(2):0);return["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>18),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>
    12&63),2<=d?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>6&63),1<=d?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a&63)].join("")},h=window.btoa||function(a){return a.replace(/[\s\S]{1,3}/g,d)};Pusher.Base64={encode:function(d){return h(d.replace(/[^\x00-\x7F]/g,a))}}}).call(this);
    (function(){function b(a,b){this.url=a;this.data=b}function c(a){return Pusher.Util.mapObject(a,function(a){"object"===typeof a&&(a=JSON.stringify(a));return encodeURIComponent(Pusher.Base64.encode(a.toString()))})}var a=b.prototype;a.send=function(a){if(!this.request){var b=Pusher.Util.filterObject(this.data,function(a){return void 0!==a}),b=Pusher.Util.map(Pusher.Util.flatten(c(b)),Pusher.Util.method("join","=")).join("&");this.request=new Pusher.ScriptRequest(this.url+"/"+a.number+"?"+b);this.request.send(a)}};
    a.cleanup=function(){this.request&&this.request.cleanup()};Pusher.JSONPRequest=b}).call(this);
    (function(){function b(a,b,c){this.key=a;this.session=b;this.events=[];this.options=c||{};this.uniqueID=this.sent=0}var c=b.prototype;b.ERROR=3;b.INFO=6;b.DEBUG=7;c.log=function(a,b){a<=this.options.level&&(this.events.push(Pusher.Util.extend({},b,{timestamp:Pusher.Util.now()})),this.options.limit&&this.events.length>this.options.limit&&this.events.shift())};c.error=function(a){this.log(b.ERROR,a)};c.info=function(a){this.log(b.INFO,a)};c.debug=function(a){this.log(b.DEBUG,a)};c.isEmpty=function(){return 0===
    this.events.length};c.send=function(a,b){var c=this,f=Pusher.Util.extend({session:c.session,bundle:c.sent+1,key:c.key,lib:"js",version:c.options.version,cluster:c.options.cluster,features:c.options.features,timeline:c.events},c.options.params);c.events=[];a(f,function(a,g){a||c.sent++;b&&b(a,g)});return!0};c.generateUniqueID=function(){this.uniqueID++;return this.uniqueID};Pusher.Timeline=b}).call(this);
    (function(){function b(b,a){this.timeline=b;this.options=a||{}}b.prototype.send=function(b,a){var d=this;d.timeline.isEmpty()||d.timeline.send(function(a,f){var e=new Pusher.JSONPRequest("http"+(b?"s":"")+"://"+(d.host||d.options.host)+d.options.path,a),g=Pusher.ScriptReceivers.create(function(a,b){Pusher.ScriptReceivers.remove(g);e.cleanup();b&&b.host&&(d.host=b.host);f&&f(a,b)});e.send(g)},a)};Pusher.TimelineSender=b}).call(this);
    (function(){function b(a){this.strategies=a}function c(a,b,c){var h=Pusher.Util.map(a,function(a,d,h,f){return a.connect(b,c(d,f))});return{abort:function(){Pusher.Util.apply(h,d)},forceMinPriority:function(a){Pusher.Util.apply(h,function(b){b.forceMinPriority(a)})}}}function a(a){return Pusher.Util.all(a,function(a){return Boolean(a.error)})}function d(a){!a.error&&!a.aborted&&(a.abort(),a.aborted=!0)}var h=b.prototype;h.isSupported=function(){return Pusher.Util.any(this.strategies,Pusher.Util.method("isSupported"))};
    h.connect=function(b,d){return c(this.strategies,b,function(b,c){return function(h,f){(c[b].error=h)?a(c)&&d(!0):(Pusher.Util.apply(c,function(a){a.forceMinPriority(f.transport.priority)}),d(null,f))}})};Pusher.BestConnectedEverStrategy=b}).call(this);
    (function(){function b(a,b,d){this.strategy=a;this.transports=b;this.ttl=d.ttl||18E5;this.encrypted=d.encrypted;this.timeline=d.timeline}function c(a){return"pusherTransport"+(a?"Encrypted":"Unencrypted")}function a(a){var b=Pusher.Util.getLocalStorage();if(b)try{var h=b[c(a)];if(h)return JSON.parse(h)}catch(k){d(a)}return null}function d(a){var b=Pusher.Util.getLocalStorage();if(b)try{delete b[c(a)]}catch(d){}}var h=b.prototype;h.isSupported=function(){return this.strategy.isSupported()};h.connect=
    function(b,h){var g=this.encrypted,k=a(g),l=[this.strategy];if(k&&k.timestamp+this.ttl>=Pusher.Util.now()){var m=this.transports[k.transport];m&&(this.timeline.info({cached:!0,transport:k.transport,latency:k.latency}),l.push(new Pusher.SequentialStrategy([m],{timeout:2*k.latency+1E3,failFast:!0})))}var p=Pusher.Util.now(),n=l.pop().connect(b,function s(a,k){if(a)d(g),0<l.length?(p=Pusher.Util.now(),n=l.pop().connect(b,s)):h(a);else{var m=k.transport.name,t=Pusher.Util.now()-p,r=Pusher.Util.getLocalStorage();
    if(r)try{r[c(g)]=JSON.stringify({timestamp:Pusher.Util.now(),transport:m,latency:t})}catch(u){}h(null,k)}});return{abort:function(){n.abort()},forceMinPriority:function(a){b=a;n&&n.forceMinPriority(a)}}};Pusher.CachedStrategy=b}).call(this);
    (function(){function b(a,b){this.strategy=a;this.options={delay:b.delay}}var c=b.prototype;c.isSupported=function(){return this.strategy.isSupported()};c.connect=function(a,b){var c=this.strategy,f,e=new Pusher.Timer(this.options.delay,function(){f=c.connect(a,b)});return{abort:function(){e.ensureAborted();f&&f.abort()},forceMinPriority:function(b){a=b;f&&f.forceMinPriority(b)}}};Pusher.DelayedStrategy=b}).call(this);
    (function(){function b(a){this.strategy=a}var c=b.prototype;c.isSupported=function(){return this.strategy.isSupported()};c.connect=function(a,b){var c=this.strategy.connect(a,function(a,e){e&&c.abort();b(a,e)});return c};Pusher.FirstConnectedStrategy=b}).call(this);
    (function(){function b(a,b,c){this.test=a;this.trueBranch=b;this.falseBranch=c}var c=b.prototype;c.isSupported=function(){return(this.test()?this.trueBranch:this.falseBranch).isSupported()};c.connect=function(a,b){return(this.test()?this.trueBranch:this.falseBranch).connect(a,b)};Pusher.IfStrategy=b}).call(this);
    (function(){function b(a,b){this.strategies=a;this.loop=Boolean(b.loop);this.failFast=Boolean(b.failFast);this.timeout=b.timeout;this.timeoutLimit=b.timeoutLimit}var c=b.prototype;c.isSupported=function(){return Pusher.Util.any(this.strategies,Pusher.Util.method("isSupported"))};c.connect=function(a,b){var c=this,f=this.strategies,e=0,g=this.timeout,k=null,l=function(m,p){p?b(null,p):(e+=1,c.loop&&(e%=f.length),e<f.length?(g&&(g*=2,c.timeoutLimit&&(g=Math.min(g,c.timeoutLimit))),k=c.tryStrategy(f[e],
    a,{timeout:g,failFast:c.failFast},l)):b(!0))},k=this.tryStrategy(f[e],a,{timeout:g,failFast:this.failFast},l);return{abort:function(){k.abort()},forceMinPriority:function(b){a=b;k&&k.forceMinPriority(b)}}};c.tryStrategy=function(a,b,c,f){var e=null,g=null;0<c.timeout&&(e=new Pusher.Timer(c.timeout,function(){g.abort();f(!0)}));g=a.connect(b,function(a,b){if(!a||!e||!e.isRunning()||c.failFast)e&&e.ensureAborted(),f(a,b)});return{abort:function(){e&&e.ensureAborted();g.abort()},forceMinPriority:function(a){g.forceMinPriority(a)}}};
    Pusher.SequentialStrategy=b}).call(this);
    (function(){function b(a,b,c,e){this.name=a;this.priority=b;this.transport=c;this.options=e||{}}function c(a,b){Pusher.Util.defer(function(){b(a)});return{abort:function(){},forceMinPriority:function(){}}}var a=b.prototype;a.isSupported=function(){return this.transport.isSupported({encrypted:this.options.encrypted})};a.connect=function(a,b){if(this.isSupported()){if(this.priority<a)return c(new Pusher.Errors.TransportPriorityTooLow,b)}else return c(new Pusher.Errors.UnsupportedStrategy,b);var f=this,
    e=!1,g=this.transport.createConnection(this.name,this.priority,this.options.key,this.options),k=null,l=function(){g.unbind("initialized",l);g.connect()},m=function(){k=new Pusher.Handshake(g,function(a){e=!0;q();b(null,a)})},p=function(a){q();b(a)},n=function(){q();b(new Pusher.Errors.TransportClosed(g))},q=function(){g.unbind("initialized",l);g.unbind("open",m);g.unbind("error",p);g.unbind("closed",n)};g.bind("initialized",l);g.bind("open",m);g.bind("error",p);g.bind("closed",n);g.initialize();return{abort:function(){e||
    (q(),k?k.close():g.close())},forceMinPriority:function(a){e||f.priority<a&&(k?k.close():g.close())}}};Pusher.TransportStrategy=b}).call(this);
    (function(){function b(a,b,c){return a+(b.encrypted?"s":"")+"://"+(b.encrypted?b.hostEncrypted:b.hostUnencrypted)+c}function c(a,b){return"/app/"+a+("?protocol="+Pusher.PROTOCOL+"&client=js&version="+Pusher.VERSION+(b?"&"+b:""))}Pusher.URLSchemes={ws:{getInitial:function(a,d){return b("ws",d,c(a,"flash=false"))}},flash:{getInitial:function(a,d){return b("ws",d,c(a,"flash=true"))}},sockjs:{getInitial:function(a,c){return b("http",c,c.httpPath||"/pusher","")},getPath:function(a,b){return c(a)}},http:{getInitial:function(a,
    d){var h=(d.httpPath||"/pusher")+c(a);return b("http",d,h)}}}}).call(this);
    (function(){function b(a,b,c,f,e){Pusher.EventsDispatcher.call(this);this.hooks=a;this.name=b;this.priority=c;this.key=f;this.options=e;this.state="new";this.timeline=e.timeline;this.activityTimeout=e.activityTimeout;this.id=this.timeline.generateUniqueID()}var c=b.prototype;Pusher.Util.extend(c,Pusher.EventsDispatcher.prototype);c.handlesActivityChecks=function(){return Boolean(this.hooks.handlesActivityChecks)};c.supportsPing=function(){return Boolean(this.hooks.supportsPing)};c.initialize=function(){var a=
    this;a.timeline.info(a.buildTimelineMessage({transport:a.name+(a.options.encrypted?"s":"")}));a.hooks.beforeInitialize&&a.hooks.beforeInitialize();if(a.hooks.isInitialized())a.changeState("initialized");else if(a.hooks.file)a.changeState("initializing"),Pusher.Dependencies.load(a.hooks.file,function(b,c){if(a.hooks.isInitialized())a.changeState("initialized"),c(!0);else{if(b)a.onError(b);a.onClose();c(!1)}});else a.onClose()};c.connect=function(){var a=this;if(a.socket||"initialized"!==a.state)return!1;
    var b=a.hooks.urls.getInitial(a.key,a.options);try{a.socket=a.hooks.getSocket(b,a.options)}catch(c){return Pusher.Util.defer(function(){a.onError(c);a.changeState("closed")}),!1}a.bindListeners();Pusher.debug("Connecting",{transport:a.name,url:b});a.changeState("connecting");return!0};c.close=function(){return this.socket?(this.socket.close(),!0):!1};c.send=function(a){var b=this;return"open"===b.state?(Pusher.Util.defer(function(){b.socket&&b.socket.send(a)}),!0):!1};c.ping=function(){"open"===this.state&&
    this.supportsPing()&&this.socket.ping()};c.onOpen=function(){this.hooks.beforeOpen&&this.hooks.beforeOpen(this.socket,this.hooks.urls.getPath(this.key,this.options));this.changeState("open");this.socket.onopen=void 0};c.onError=function(a){this.emit("error",{type:"WebSocketError",error:a});this.timeline.error(this.buildTimelineMessage({error:a.toString()}))};c.onClose=function(a){a?this.changeState("closed",{code:a.code,reason:a.reason,wasClean:a.wasClean}):this.changeState("closed");this.unbindListeners();
    this.socket=void 0};c.onMessage=function(a){this.emit("message",a)};c.onActivity=function(){this.emit("activity")};c.bindListeners=function(){var a=this;a.socket.onopen=function(){a.onOpen()};a.socket.onerror=function(b){a.onError(b)};a.socket.onclose=function(b){a.onClose(b)};a.socket.onmessage=function(b){a.onMessage(b)};a.supportsPing()&&(a.socket.onactivity=function(){a.onActivity()})};c.unbindListeners=function(){this.socket&&(this.socket.onopen=void 0,this.socket.onerror=void 0,this.socket.onclose=
    void 0,this.socket.onmessage=void 0,this.supportsPing()&&(this.socket.onactivity=void 0))};c.changeState=function(a,b){this.state=a;this.timeline.info(this.buildTimelineMessage({state:a,params:b}));this.emit(a,b)};c.buildTimelineMessage=function(a){return Pusher.Util.extend({cid:this.id},a)};Pusher.TransportConnection=b}).call(this);
    (function(){function b(a){this.hooks=a}var c=b.prototype;c.isSupported=function(a){return this.hooks.isSupported(a)};c.createConnection=function(a,b,c,f){return new Pusher.TransportConnection(this.hooks,a,b,c,f)};Pusher.Transport=b}).call(this);
    (function(){Pusher.WSTransport=new Pusher.Transport({urls:Pusher.URLSchemes.ws,handlesActivityChecks:!1,supportsPing:!1,isInitialized:function(){return Boolean(window.WebSocket||window.MozWebSocket)},isSupported:function(){return Boolean(window.WebSocket||window.MozWebSocket)},getSocket:function(a){return new (window.WebSocket||window.MozWebSocket)(a)}});Pusher.FlashTransport=new Pusher.Transport({file:"flashfallback",urls:Pusher.URLSchemes.flash,handlesActivityChecks:!1,supportsPing:!1,isSupported:function(){try{return Boolean(new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(a){try{var b=
    Pusher.Util.getNavigator();return Boolean(b&&b.mimeTypes&&void 0!==b.mimeTypes["application/x-shockwave-flash"])}catch(c){return!1}}},beforeInitialize:function(){void 0===window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR&&(window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR=!0);window.WEB_SOCKET_SWF_LOCATION=Pusher.Dependencies.getRoot()+"/WebSocketMain.swf"},isInitialized:function(){return void 0!==window.FlashWebSocket},getSocket:function(a){return new FlashWebSocket(a)}});Pusher.SockJSTransport=
    new Pusher.Transport({file:"sockjs",urls:Pusher.URLSchemes.sockjs,handlesActivityChecks:!0,supportsPing:!1,isSupported:function(){return!0},isInitialized:function(){return void 0!==window.SockJS},getSocket:function(a,b){return new SockJS(a,null,{js_path:Pusher.Dependencies.getPath("sockjs",{encrypted:b.encrypted}),ignore_null_origin:b.ignoreNullOrigin})},beforeOpen:function(a,b){a.send(JSON.stringify({path:b}))}});var b={urls:Pusher.URLSchemes.http,handlesActivityChecks:!1,supportsPing:!0,isInitialized:function(){return Boolean(Pusher.HTTP.Socket)}},
    c=Pusher.Util.extend({getSocket:function(a){return Pusher.HTTP.getStreamingSocket(a)}},b),b=Pusher.Util.extend({getSocket:function(a){return Pusher.HTTP.getPollingSocket(a)}},b),a={file:"xhr",isSupported:Pusher.Util.isXHRSupported},d={file:"xdr",isSupported:function(a){return Pusher.Util.isXDRSupported(a.encrypted)}};Pusher.XHRStreamingTransport=new Pusher.Transport(Pusher.Util.extend({},c,a));Pusher.XDRStreamingTransport=new Pusher.Transport(Pusher.Util.extend({},c,d));Pusher.XHRPollingTransport=
    new Pusher.Transport(Pusher.Util.extend({},b,a));Pusher.XDRPollingTransport=new Pusher.Transport(Pusher.Util.extend({},b,d))}).call(this);
    (function(){function b(a,b,c){this.manager=a;this.transport=b;this.minPingDelay=c.minPingDelay;this.maxPingDelay=c.maxPingDelay;this.pingDelay=void 0}var c=b.prototype;c.createConnection=function(a,b,c,f){var e=this;f=Pusher.Util.extend({},f,{activityTimeout:e.pingDelay});var g=e.transport.createConnection(a,b,c,f),k=null,l=function(){g.unbind("open",l);g.bind("closed",m);k=Pusher.Util.now()},m=function(a){g.unbind("closed",m);1002===a.code||1003===a.code?e.manager.reportDeath():!a.wasClean&&k&&(a=
    Pusher.Util.now()-k,a<2*e.maxPingDelay&&(e.manager.reportDeath(),e.pingDelay=Math.max(a/2,e.minPingDelay)))};g.bind("open",l);return g};c.isSupported=function(a){return this.manager.isAlive()&&this.transport.isSupported(a)};Pusher.AssistantToTheTransportManager=b}).call(this);
    (function(){function b(a){this.options=a||{};this.livesLeft=this.options.lives||Infinity}var c=b.prototype;c.getAssistant=function(a){return new Pusher.AssistantToTheTransportManager(this,a,{minPingDelay:this.options.minPingDelay,maxPingDelay:this.options.maxPingDelay})};c.isAlive=function(){return 0<this.livesLeft};c.reportDeath=function(){this.livesLeft-=1};Pusher.TransportManager=b}).call(this);
    (function(){function b(a){return function(b){return[a.apply(this,arguments),b]}}function c(a,b){if(0===a.length)return[[],b];var h=d(a[0],b),f=c(a.slice(1),h[1]);return[[h[0]].concat(f[0]),f[1]]}function a(a,b){if("string"===typeof a[0]&&":"===a[0].charAt(0)){var h=b[a[0].slice(1)];if(1<a.length){if("function"!==typeof h)throw"Calling non-function "+a[0];var f=[Pusher.Util.extend({},b)].concat(Pusher.Util.map(a.slice(1),function(a){return d(a,Pusher.Util.extend({},b))[0]}));return h.apply(this,f)}return[h,
    b]}return c(a,b)}function d(b,c){if("string"===typeof b){var d;if("string"===typeof b&&":"===b.charAt(0)){d=c[b.slice(1)];if(void 0===d)throw"Undefined symbol "+b;d=[d,c]}else d=[b,c];return d}return"object"===typeof b&&b instanceof Array&&0<b.length?a(b,c):[b,c]}var h={ws:Pusher.WSTransport,flash:Pusher.FlashTransport,sockjs:Pusher.SockJSTransport,xhr_streaming:Pusher.XHRStreamingTransport,xdr_streaming:Pusher.XDRStreamingTransport,xhr_polling:Pusher.XHRPollingTransport,xdr_polling:Pusher.XDRPollingTransport},
    f={isSupported:function(){return!1},connect:function(a,b){var c=Pusher.Util.defer(function(){b(new Pusher.Errors.UnsupportedStrategy)});return{abort:function(){c.ensureAborted()},forceMinPriority:function(){}}}},e={extend:function(a,b,c){return[Pusher.Util.extend({},b,c),a]},def:function(a,b,c){if(void 0!==a[b])throw"Redefining symbol "+b;a[b]=c;return[void 0,a]},def_transport:function(a,b,c,d,e,n){var q=h[c];if(!q)throw new Pusher.Errors.UnsupportedTransport(c);c=(!a.enabledTransports||-1!==Pusher.Util.arrayIndexOf(a.enabledTransports,
    b))&&(!a.disabledTransports||-1===Pusher.Util.arrayIndexOf(a.disabledTransports,b))&&("flash"!==b||!0!==a.disableFlash)?new Pusher.TransportStrategy(b,d,n?n.getAssistant(q):q,Pusher.Util.extend({key:a.key,encrypted:a.encrypted,timeline:a.timeline,ignoreNullOrigin:a.ignoreNullOrigin},e)):f;d=a.def(a,b,c)[1];d.transports=a.transports||{};d.transports[b]=c;return[void 0,d]},transport_manager:b(function(a,b){return new Pusher.TransportManager(b)}),sequential:b(function(a,b){var c=Array.prototype.slice.call(arguments,
    2);return new Pusher.SequentialStrategy(c,b)}),cached:b(function(a,b,c){return new Pusher.CachedStrategy(c,a.transports,{ttl:b,timeline:a.timeline,encrypted:a.encrypted})}),first_connected:b(function(a,b){return new Pusher.FirstConnectedStrategy(b)}),best_connected_ever:b(function(){var a=Array.prototype.slice.call(arguments,1);return new Pusher.BestConnectedEverStrategy(a)}),delayed:b(function(a,b,c){return new Pusher.DelayedStrategy(c,{delay:b})}),"if":b(function(a,b,c,d){return new Pusher.IfStrategy(b,
    c,d)}),is_supported:b(function(a,b){return function(){return b.isSupported()}})};Pusher.StrategyBuilder={build:function(a,b){var c=Pusher.Util.extend({},e,b);return d(a,c)[1].strategy}}}).call(this);
    (function(){Pusher.Protocol={decodeMessage:function(b){try{var c=JSON.parse(b.data);if("string"===typeof c.data)try{c.data=JSON.parse(c.data)}catch(a){if(!(a instanceof SyntaxError))throw a;}return c}catch(d){throw{type:"MessageParseError",error:d,data:b.data};}},encodeMessage:function(b){return JSON.stringify(b)},processHandshake:function(b){b=this.decodeMessage(b);if("pusher:connection_established"===b.event){if(!b.data.activity_timeout)throw"No activity timeout specified in handshake";return{action:"connected",
    id:b.data.socket_id,activityTimeout:1E3*b.data.activity_timeout}}if("pusher:error"===b.event)return{action:this.getCloseAction(b.data),error:this.getCloseError(b.data)};throw"Invalid handshake";},getCloseAction:function(b){return 4E3>b.code?1002<=b.code&&1004>=b.code?"backoff":null:4E3===b.code?"ssl_only":4100>b.code?"refused":4200>b.code?"backoff":4300>b.code?"retry":"refused"},getCloseError:function(b){return 1E3!==b.code&&1001!==b.code?{type:"PusherError",data:{code:b.code,message:b.reason||b.message}}:
    null}}}).call(this);
    (function(){function b(a,b){Pusher.EventsDispatcher.call(this);this.id=a;this.transport=b;this.activityTimeout=b.activityTimeout;this.bindListeners()}var c=b.prototype;Pusher.Util.extend(c,Pusher.EventsDispatcher.prototype);c.handlesActivityChecks=function(){return this.transport.handlesActivityChecks()};c.send=function(a){return this.transport.send(a)};c.send_event=function(a,b,c){a={event:a,data:b};c&&(a.channel=c);Pusher.debug("Event sent",a);return this.send(Pusher.Protocol.encodeMessage(a))};c.ping=
    function(){this.transport.supportsPing()?this.transport.ping():this.send_event("pusher:ping",{})};c.close=function(){this.transport.close()};c.bindListeners=function(){var a=this,b={message:function(b){var c;try{c=Pusher.Protocol.decodeMessage(b)}catch(d){a.emit("error",{type:"MessageParseError",error:d,data:b.data})}if(void 0!==c){Pusher.debug("Event recd",c);switch(c.event){case "pusher:error":a.emit("error",{type:"PusherError",data:c.data});break;case "pusher:ping":a.emit("ping");break;case "pusher:pong":a.emit("pong")}a.emit("message",
    c)}},activity:function(){a.emit("activity")},error:function(b){a.emit("error",{type:"WebSocketError",error:b})},closed:function(b){c();b&&b.code&&a.handleCloseEvent(b);a.transport=null;a.emit("closed")}},c=function(){Pusher.Util.objectApply(b,function(b,c){a.transport.unbind(c,b)})};Pusher.Util.objectApply(b,function(b,c){a.transport.bind(c,b)})};c.handleCloseEvent=function(a){var b=Pusher.Protocol.getCloseAction(a);(a=Pusher.Protocol.getCloseError(a))&&this.emit("error",a);b&&this.emit(b)};Pusher.Connection=
    b}).call(this);
    (function(){function b(a,b){this.transport=a;this.callback=b;this.bindListeners()}var c=b.prototype;c.close=function(){this.unbindListeners();this.transport.close()};c.bindListeners=function(){var a=this;a.onMessage=function(b){a.unbindListeners();try{var c=Pusher.Protocol.processHandshake(b);"connected"===c.action?a.finish("connected",{connection:new Pusher.Connection(c.id,a.transport),activityTimeout:c.activityTimeout}):(a.finish(c.action,{error:c.error}),a.transport.close())}catch(f){a.finish("error",{error:f}),
    a.transport.close()}};a.onClosed=function(b){a.unbindListeners();var c=Pusher.Protocol.getCloseAction(b)||"backoff";b=Pusher.Protocol.getCloseError(b);a.finish(c,{error:b})};a.transport.bind("message",a.onMessage);a.transport.bind("closed",a.onClosed)};c.unbindListeners=function(){this.transport.unbind("message",this.onMessage);this.transport.unbind("closed",this.onClosed)};c.finish=function(a,b){this.callback(Pusher.Util.extend({transport:this.transport,action:a},b))};Pusher.Handshake=b}).call(this);
    (function(){function b(a,b){Pusher.EventsDispatcher.call(this);this.key=a;this.options=b||{};this.state="initialized";this.connection=null;this.encrypted=!!b.encrypted;this.timeline=this.options.timeline;this.connectionCallbacks=this.buildConnectionCallbacks();this.errorCallbacks=this.buildErrorCallbacks();this.handshakeCallbacks=this.buildHandshakeCallbacks(this.errorCallbacks);var c=this;Pusher.Network.bind("online",function(){c.timeline.info({netinfo:"online"});("connecting"===c.state||"unavailable"===
    c.state)&&c.retryIn(0)});Pusher.Network.bind("offline",function(){c.timeline.info({netinfo:"offline"});"connected"===c.state&&c.sendActivityCheck()});this.updateStrategy()}var c=b.prototype;Pusher.Util.extend(c,Pusher.EventsDispatcher.prototype);c.connect=function(){!this.connection&&!this.runner&&(this.strategy.isSupported()?(this.updateState("connecting"),this.startConnecting(),this.setUnavailableTimer()):this.updateState("failed"))};c.send=function(a){return this.connection?this.connection.send(a):
    !1};c.send_event=function(a,b,c){return this.connection?this.connection.send_event(a,b,c):!1};c.disconnect=function(){this.disconnectInternally();this.updateState("disconnected")};c.isEncrypted=function(){return this.encrypted};c.startConnecting=function(){var a=this,b=function(c,f){c?a.runner=a.strategy.connect(0,b):"error"===f.action?(a.emit("error",{type:"HandshakeError",error:f.error}),a.timeline.error({handshakeError:f.error})):(a.abortConnecting(),a.handshakeCallbacks[f.action](f))};a.runner=
    a.strategy.connect(0,b)};c.abortConnecting=function(){this.runner&&(this.runner.abort(),this.runner=null)};c.disconnectInternally=function(){this.abortConnecting();this.clearRetryTimer();this.clearUnavailableTimer();this.stopActivityCheck();this.connection&&this.abandonConnection().close()};c.updateStrategy=function(){this.strategy=this.options.getStrategy({key:this.key,timeline:this.timeline,encrypted:this.encrypted})};c.retryIn=function(a){var b=this;b.timeline.info({action:"retry",delay:a});0<
    a&&b.emit("connecting_in",Math.round(a/1E3));b.retryTimer=new Pusher.Timer(a||0,function(){b.disconnectInternally();b.connect()})};c.clearRetryTimer=function(){this.retryTimer&&(this.retryTimer.ensureAborted(),this.retryTimer=null)};c.setUnavailableTimer=function(){var a=this;a.unavailableTimer=new Pusher.Timer(a.options.unavailableTimeout,function(){a.updateState("unavailable")})};c.clearUnavailableTimer=function(){this.unavailableTimer&&this.unavailableTimer.ensureAborted()};c.sendActivityCheck=
    function(){var a=this;a.stopActivityCheck();a.connection.ping();a.activityTimer=new Pusher.Timer(a.options.pongTimeout,function(){a.timeline.error({pong_timed_out:a.options.pongTimeout});a.retryIn(0)})};c.resetActivityCheck=function(){var a=this;a.stopActivityCheck();a.connection.handlesActivityChecks()||(a.activityTimer=new Pusher.Timer(a.activityTimeout,function(){a.sendActivityCheck()}))};c.stopActivityCheck=function(){this.activityTimer&&this.activityTimer.ensureAborted()};c.buildConnectionCallbacks=
    function(){var a=this;return{message:function(b){a.resetActivityCheck();a.emit("message",b)},ping:function(){a.send_event("pusher:pong",{})},activity:function(){a.resetActivityCheck()},error:function(b){a.emit("error",{type:"WebSocketError",error:b})},closed:function(){a.abandonConnection();a.shouldRetry()&&a.retryIn(1E3)}}};c.buildHandshakeCallbacks=function(a){var b=this;return Pusher.Util.extend({},a,{connected:function(a){b.activityTimeout=Math.min(b.options.activityTimeout,a.activityTimeout,
    a.connection.activityTimeout||Infinity);b.clearUnavailableTimer();b.setConnection(a.connection);b.socket_id=b.connection.id;b.updateState("connected",{socket_id:b.socket_id})}})};c.buildErrorCallbacks=function(){function a(a){return function(c){c.error&&b.emit("error",{type:"WebSocketError",error:c.error});a(c)}}var b=this;return{ssl_only:a(function(){b.encrypted=!0;b.updateStrategy();b.retryIn(0)}),refused:a(function(){b.disconnect()}),backoff:a(function(){b.retryIn(1E3)}),retry:a(function(){b.retryIn(0)})}};
    c.setConnection=function(a){this.connection=a;for(var b in this.connectionCallbacks)this.connection.bind(b,this.connectionCallbacks[b]);this.resetActivityCheck()};c.abandonConnection=function(){if(this.connection){for(var a in this.connectionCallbacks)this.connection.unbind(a,this.connectionCallbacks[a]);a=this.connection;this.connection=null;return a}};c.updateState=function(a,b){var c=this.state;this.state=a;c!==a&&(Pusher.debug("State changed",c+" -> "+a),this.timeline.info({state:a,params:b}),
    this.emit("state_change",{previous:c,current:a}),this.emit(a,b))};c.shouldRetry=function(){return"connecting"===this.state||"connected"===this.state};Pusher.ConnectionManager=b}).call(this);
    (function(){function b(){Pusher.EventsDispatcher.call(this);var b=this;void 0!==window.addEventListener&&(window.addEventListener("online",function(){b.emit("online")},!1),window.addEventListener("offline",function(){b.emit("offline")},!1))}Pusher.Util.extend(b.prototype,Pusher.EventsDispatcher.prototype);b.prototype.isOnline=function(){return void 0===window.navigator.onLine?!0:window.navigator.onLine};Pusher.NetInfo=b;Pusher.Network=new b}).call(this);
    (function(){function b(){this.reset()}var c=b.prototype;c.get=function(a){return Object.prototype.hasOwnProperty.call(this.members,a)?{id:a,info:this.members[a]}:null};c.each=function(a){var b=this;Pusher.Util.objectApply(b.members,function(c,f){a(b.get(f))})};c.setMyID=function(a){this.myID=a};c.onSubscription=function(a){this.members=a.presence.hash;this.count=a.presence.count;this.me=this.get(this.myID)};c.addMember=function(a){null===this.get(a.user_id)&&this.count++;this.members[a.user_id]=a.user_info;
    return this.get(a.user_id)};c.removeMember=function(a){var b=this.get(a.user_id);b&&(delete this.members[a.user_id],this.count--);return b};c.reset=function(){this.members={};this.count=0;this.me=this.myID=null};Pusher.Members=b}).call(this);
    (function(){function b(a,b){Pusher.EventsDispatcher.call(this,function(b,c){Pusher.debug("No callbacks on "+a+" for "+b)});this.name=a;this.pusher=b;this.subscribed=!1}var c=b.prototype;Pusher.Util.extend(c,Pusher.EventsDispatcher.prototype);c.authorize=function(a,b){return b(!1,{})};c.trigger=function(a,b){if(0!==a.indexOf("client-"))throw new Pusher.Errors.BadEventName("Event '"+a+"' does not start with 'client-'");return this.pusher.send_event(a,b,this.name)};c.disconnect=function(){this.subscribed=
    !1};c.handleEvent=function(a,b){0===a.indexOf("pusher_internal:")?"pusher_internal:subscription_succeeded"===a&&(this.subscribed=!0,this.emit("pusher:subscription_succeeded",b)):this.emit(a,b)};c.subscribe=function(){var a=this;a.authorize(a.pusher.connection.socket_id,function(b,c){b?a.handleEvent("pusher:subscription_error",c):a.pusher.send_event("pusher:subscribe",{auth:c.auth,channel_data:c.channel_data,channel:a.name})})};c.unsubscribe=function(){this.pusher.send_event("pusher:unsubscribe",{channel:this.name})};
    Pusher.Channel=b}).call(this);(function(){function b(a,b){Pusher.Channel.call(this,a,b)}var c=b.prototype;Pusher.Util.extend(c,Pusher.Channel.prototype);c.authorize=function(a,b){return(new Pusher.Channel.Authorizer(this,this.pusher.config)).authorize(a,b)};Pusher.PrivateChannel=b}).call(this);
    (function(){function b(a,b){Pusher.PrivateChannel.call(this,a,b);this.members=new Pusher.Members}var c=b.prototype;Pusher.Util.extend(c,Pusher.PrivateChannel.prototype);c.authorize=function(a,b){var c=this;Pusher.PrivateChannel.prototype.authorize.call(c,a,function(a,e){if(!a){if(void 0===e.channel_data){Pusher.warn("Invalid auth response for channel '"+c.name+"', expected 'channel_data' field");b("Invalid auth response");return}var g=JSON.parse(e.channel_data);c.members.setMyID(g.user_id)}b(a,e)})};
    c.handleEvent=function(a,b){switch(a){case "pusher_internal:subscription_succeeded":this.members.onSubscription(b);this.subscribed=!0;this.emit("pusher:subscription_succeeded",this.members);break;case "pusher_internal:member_added":var c=this.members.addMember(b);this.emit("pusher:member_added",c);break;case "pusher_internal:member_removed":(c=this.members.removeMember(b))&&this.emit("pusher:member_removed",c);break;default:Pusher.PrivateChannel.prototype.handleEvent.call(this,a,b)}};c.disconnect=
    function(){this.members.reset();Pusher.PrivateChannel.prototype.disconnect.call(this)};Pusher.PresenceChannel=b}).call(this);
    (function(){function b(){this.channels={}}var c=b.prototype;c.add=function(a,b){if(!this.channels[a]){var c=this.channels,f;f=0===a.indexOf("private-")?new Pusher.PrivateChannel(a,b):0===a.indexOf("presence-")?new Pusher.PresenceChannel(a,b):new Pusher.Channel(a,b);c[a]=f}return this.channels[a]};c.all=function(a){return Pusher.Util.values(this.channels)};c.find=function(a){return this.channels[a]};c.remove=function(a){var b=this.channels[a];delete this.channels[a];return b};c.disconnect=function(){Pusher.Util.objectApply(this.channels,
    function(a){a.disconnect()})};Pusher.Channels=b}).call(this);
    (function(){Pusher.Channel.Authorizer=function(b,a){this.channel=b;this.type=a.authTransport;this.options=a;this.authOptions=(a||{}).auth||{}};Pusher.Channel.Authorizer.prototype={composeQuery:function(b){b="&socket_id="+encodeURIComponent(b)+"&channel_name="+encodeURIComponent(this.channel.name);for(var a in this.authOptions.params)b+="&"+encodeURIComponent(a)+"="+encodeURIComponent(this.authOptions.params[a]);return b},authorize:function(b,a){return Pusher.authorizers[this.type].call(this,b,a)}};
    var b=1;Pusher.auth_callbacks={};Pusher.authorizers={ajax:function(b,a){var d;d=Pusher.XHR?new Pusher.XHR:window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.open("POST",this.options.authEndpoint,!0);d.setRequestHeader("Content-Type","application/x-www-form-urlencoded");for(var h in this.authOptions.headers)d.setRequestHeader(h,this.authOptions.headers[h]);d.onreadystatechange=function(){if(4===d.readyState)if(200===d.status){var b,c=!1;try{b=JSON.parse(d.responseText),
    c=!0}catch(g){a(!0,"JSON returned from webapp was invalid, yet status code was 200. Data was: "+d.responseText)}c&&a(!1,b)}else Pusher.warn("Couldn't get auth info from your webapp",d.status),a(!0,d.status)};d.send(this.composeQuery(b));return d},jsonp:function(c,a){void 0!==this.authOptions.headers&&Pusher.warn("Warn","To send headers with the auth request, you must use AJAX, rather than JSONP.");var d=b.toString();b++;var h=Pusher.Util.getDocument(),f=h.createElement("script");Pusher.auth_callbacks[d]=
    function(b){a(!1,b)};f.src=this.options.authEndpoint+"?callback="+encodeURIComponent("Pusher.auth_callbacks['"+d+"']")+this.composeQuery(c);d=h.getElementsByTagName("head")[0]||h.documentElement;d.insertBefore(f,d.firstChild)}}}).call(this);
    return Pusher;
}));
IC = {}

// Copied from Backbone//{{{
function md5cycle(x, k) {
var a = x[0], b = x[1], c = x[2], d = x[3];

a = ff(a, b, c, d, k[0], 7, -680876936);
d = ff(d, a, b, c, k[1], 12, -389564586);
c = ff(c, d, a, b, k[2], 17,  606105819);
b = ff(b, c, d, a, k[3], 22, -1044525330);
a = ff(a, b, c, d, k[4], 7, -176418897);
d = ff(d, a, b, c, k[5], 12,  1200080426);
c = ff(c, d, a, b, k[6], 17, -1473231341);
b = ff(b, c, d, a, k[7], 22, -45705983);
a = ff(a, b, c, d, k[8], 7,  1770035416);
d = ff(d, a, b, c, k[9], 12, -1958414417);
c = ff(c, d, a, b, k[10], 17, -42063);
b = ff(b, c, d, a, k[11], 22, -1990404162);
a = ff(a, b, c, d, k[12], 7,  1804603682);
d = ff(d, a, b, c, k[13], 12, -40341101);
c = ff(c, d, a, b, k[14], 17, -1502002290);
b = ff(b, c, d, a, k[15], 22,  1236535329);

a = gg(a, b, c, d, k[1], 5, -165796510);
d = gg(d, a, b, c, k[6], 9, -1069501632);
c = gg(c, d, a, b, k[11], 14,  643717713);
b = gg(b, c, d, a, k[0], 20, -373897302);
a = gg(a, b, c, d, k[5], 5, -701558691);
d = gg(d, a, b, c, k[10], 9,  38016083);
c = gg(c, d, a, b, k[15], 14, -660478335);
b = gg(b, c, d, a, k[4], 20, -405537848);
a = gg(a, b, c, d, k[9], 5,  568446438);
d = gg(d, a, b, c, k[14], 9, -1019803690);
c = gg(c, d, a, b, k[3], 14, -187363961);
b = gg(b, c, d, a, k[8], 20,  1163531501);
a = gg(a, b, c, d, k[13], 5, -1444681467);
d = gg(d, a, b, c, k[2], 9, -51403784);
c = gg(c, d, a, b, k[7], 14,  1735328473);
b = gg(b, c, d, a, k[12], 20, -1926607734);

a = hh(a, b, c, d, k[5], 4, -378558);
d = hh(d, a, b, c, k[8], 11, -2022574463);
c = hh(c, d, a, b, k[11], 16,  1839030562);
b = hh(b, c, d, a, k[14], 23, -35309556);
a = hh(a, b, c, d, k[1], 4, -1530992060);
d = hh(d, a, b, c, k[4], 11,  1272893353);
c = hh(c, d, a, b, k[7], 16, -155497632);
b = hh(b, c, d, a, k[10], 23, -1094730640);
a = hh(a, b, c, d, k[13], 4,  681279174);
d = hh(d, a, b, c, k[0], 11, -358537222);
c = hh(c, d, a, b, k[3], 16, -722521979);
b = hh(b, c, d, a, k[6], 23,  76029189);
a = hh(a, b, c, d, k[9], 4, -640364487);
d = hh(d, a, b, c, k[12], 11, -421815835);
c = hh(c, d, a, b, k[15], 16,  530742520);
b = hh(b, c, d, a, k[2], 23, -995338651);

a = ii(a, b, c, d, k[0], 6, -198630844);
d = ii(d, a, b, c, k[7], 10,  1126891415);
c = ii(c, d, a, b, k[14], 15, -1416354905);
b = ii(b, c, d, a, k[5], 21, -57434055);
a = ii(a, b, c, d, k[12], 6,  1700485571);
d = ii(d, a, b, c, k[3], 10, -1894986606);
c = ii(c, d, a, b, k[10], 15, -1051523);
b = ii(b, c, d, a, k[1], 21, -2054922799);
a = ii(a, b, c, d, k[8], 6,  1873313359);
d = ii(d, a, b, c, k[15], 10, -30611744);
c = ii(c, d, a, b, k[6], 15, -1560198380);
b = ii(b, c, d, a, k[13], 21,  1309151649);
a = ii(a, b, c, d, k[4], 6, -145523070);
d = ii(d, a, b, c, k[11], 10, -1120210379);
c = ii(c, d, a, b, k[2], 15,  718787259);
b = ii(b, c, d, a, k[9], 21, -343485551);

x[0] = add32(a, x[0]);
x[1] = add32(b, x[1]);
x[2] = add32(c, x[2]);
x[3] = add32(d, x[3]);

}

function cmn(q, a, b, x, s, t) {
a = add32(add32(a, q), add32(x, t));
return add32((a << s) | (a >>> (32 - s)), b);
}

function ff(a, b, c, d, x, s, t) {
return cmn((b & c) | ((~b) & d), a, b, x, s, t);
}

function gg(a, b, c, d, x, s, t) {
return cmn((b & d) | (c & (~d)), a, b, x, s, t);
}

function hh(a, b, c, d, x, s, t) {
return cmn(b ^ c ^ d, a, b, x, s, t);
}

function ii(a, b, c, d, x, s, t) {
return cmn(c ^ (b | (~d)), a, b, x, s, t);
}

function md51(s) {
txt = '';
var n = s.length,
state = [1732584193, -271733879, -1732584194, 271733878], i;
for (i=64; i<=s.length; i+=64) {
md5cycle(state, md5blk(s.substring(i-64, i)));
}
s = s.substring(i-64);
var tail = [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0];
for (i=0; i<s.length; i++)
tail[i>>2] |= s.charCodeAt(i) << ((i%4) << 3);
tail[i>>2] |= 0x80 << ((i%4) << 3);
if (i > 55) {
md5cycle(state, tail);
for (i=0; i<16; i++) tail[i] = 0;
}
tail[14] = n*8;
md5cycle(state, tail);
return state;
}

/* there needs to be support for Unicode here,
 * unless we pretend that we can redefine the MD-5
 * algorithm for multi-byte characters (perhaps
 * by adding every four 16-bit characters and
 * shortening the sum to 32 bits). Otherwise
 * I suggest performing MD-5 as if every character
 * was two bytes--e.g., 0040 0025 = @%--but then
 * how will an ordinary MD-5 sum be matched?
 * There is no way to standardize text to something
 * like UTF-8 before transformation; speed cost is
 * utterly prohibitive. The JavaScript standard
 * itself needs to look at this: it should start
 * providing access to strings as preformed UTF-8
 * 8-bit unsigned value arrays.
 */
function md5blk(s) { /* I figured global was faster.   */
var md5blks = [], i; /* Andy King said do it this way. */
for (i=0; i<64; i+=4) {
md5blks[i>>2] = s.charCodeAt(i)
+ (s.charCodeAt(i+1) << 8)
+ (s.charCodeAt(i+2) << 16)
+ (s.charCodeAt(i+3) << 24);
}
return md5blks;
}

var hex_chr = '0123456789abcdef'.split('');

function rhex(n)
{
var s='', j=0;
for(; j<4; j++)
s += hex_chr[(n >> (j * 8 + 4)) & 0x0F]
+ hex_chr[(n >> (j * 8)) & 0x0F];
return s;
}

function hex(x) {
for (var i=0; i<x.length; i++)
x[i] = rhex(x[i]);
return x.join('');
}

function md5(s) {
return hex(md51(s));
}

/* this function is much faster,
so if possible we use it. Some IEs
are the only ones I know of that
need the idiotic second function,
generated by an if clause.  */

function add32(a, b) {
return (a + b) & 0xFFFFFFFF;
}

if (md5('hello') != '5d41402abc4b2a76b9719d911017c592') {
function add32(x, y) {
var lsw = (x & 0xFFFF) + (y & 0xFFFF),
msw = (x >> 16) + (y >> 16) + (lsw >> 16);
return (msw << 16) | (lsw & 0xFFFF);
}
}
var array = [];
var push = array.push;
var slice = array.slice;
var splice = array.splice;
var Events = IC.Events = {

// Bind an event to a `callback` function. Passing `"all"` will bind
// the callback to all events fired.
on: function(name, callback, context) {
  if (!eventsApi(this, 'on', name, [callback, context]) || !callback) return this;
  this._events || (this._events = {});
  var events = this._events[name] || (this._events[name] = []);
  events.push({callback: callback, context: context, ctx: context || this});
  return this;
},

// Bind an event to only be triggered a single time. After the first time
// the callback is invoked, it will be removed.
once: function(name, callback, context) {
  if (!eventsApi(this, 'once', name, [callback, context]) || !callback) return this;
  var self = this;
  var once = _.once(function() {
    self.off(name, once);
    callback.apply(this, arguments);
  });
  once._callback = callback;
  return this.on(name, once, context);
},

// Remove one or many callbacks. If `context` is null, removes all
// callbacks with that function. If `callback` is null, removes all
// callbacks for the event. If `name` is null, removes all bound
// callbacks for all events.
off: function(name, callback, context) {
  var retain, ev, events, names, i, l, j, k;
  if (!this._events || !eventsApi(this, 'off', name, [callback, context])) return this;
  if (!name && !callback && !context) {
    this._events = void 0;
    return this;
  }
  names = name ? [name] : _.keys(this._events);
  for (i = 0, l = names.length; i < l; i++) {
    name = names[i];
    if (events = this._events[name]) {
      this._events[name] = retain = [];
      if (callback || context) {
        for (j = 0, k = events.length; j < k; j++) {
          ev = events[j];
          if ((callback && callback !== ev.callback && callback !== ev.callback._callback) ||
              (context && context !== ev.context)) {
            retain.push(ev);
          }
        }
      }
      if (!retain.length) delete this._events[name];
    }
  }

  return this;
},

// Trigger one or many events, firing all bound callbacks. Callbacks are
// passed the same arguments as `trigger` is, apart from the event name
// (unless you're listening on `"all"`, which will cause your callback to
// receive the true name of the event as the first argument).
trigger: function(name) {
  if (!this._events) return this;
  var args = slice.call(arguments, 1);
  if (!eventsApi(this, 'trigger', name, args)) return this;
  var events = this._events[name];
  var allEvents = this._events.all;
  if (events) triggerEvents(events, args);
  if (allEvents) triggerEvents(allEvents, arguments);
  return this;
},

// Tell this object to stop listening to either specific events ... or
// to every object it's currently listening to.
stopListening: function(obj, name, callback) {
  var listeningTo = this._listeningTo;
  if (!listeningTo) return this;
  var remove = !name && !callback;
  if (!callback && typeof name === 'object') callback = this;
  if (obj) (listeningTo = {})[obj._listenId] = obj;
  for (var id in listeningTo) {
    obj = listeningTo[id];
    obj.off(name, callback, this);
    if (remove || _.isEmpty(obj._events)) delete this._listeningTo[id];
  }
  return this;
}

};

// Regular expression used to split event strings.
var eventSplitter = /\s+/;

// Implement fancy features of the Events API such as multiple event
// names `"change blur"` and jQuery-style event maps `{change: action}`
// in terms of the existing API.
var eventsApi = function(obj, action, name, rest) {
if (!name) return true;

// Handle event maps.
if (typeof name === 'object') {
  for (var key in name) {
    obj[action].apply(obj, [key, name[key]].concat(rest));
  }
  return false;
}

// Handle space separated event names.
if (eventSplitter.test(name)) {
  var names = name.split(eventSplitter);
  for (var i = 0, l = names.length; i < l; i++) {
    obj[action].apply(obj, [names[i]].concat(rest));
  }
  return false;
}

return true;
};

var triggerEvents = function(events, args) {
var ev, i = -1, l = events.length, a1 = args[0], a2 = args[1], a3 = args[2];
switch (args.length) {
  case 0: while (++i < l) (ev = events[i]).callback.call(ev.ctx); return;
  case 1: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1); return;
  case 2: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1, a2); return;
  case 3: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1, a2, a3); return;
  default: while (++i < l) (ev = events[i]).callback.apply(ev.ctx, args); return;
}
};

var listenMethods = {listenTo: 'on', listenToOnce: 'once'};

// Inversion-of-control versions of `on` and `once`. Tell *this* object to
// listen to an event in another object ... keeping track of what it's
// listening to.
_.each(listenMethods, function(implementation, method) {
Events[method] = function(obj, name, callback) {
  var listeningTo = this._listeningTo || (this._listeningTo = {});
  var id = obj._listenId || (obj._listenId = _.uniqueId('l'));
  listeningTo[id] = obj;
  if (!callback && typeof name === 'object') callback = this;
  obj[implementation](name, callback, this);
  return this;
};
});

// Aliases for backwards compatibility.
Events.bind   = Events.on;
Events.unbind = Events.off;//}}}
IC.Broker = function(load_url,dyn_load_url){
    this.subscriptions = {};
    this.consumers = [];
    this.load_url = load_url;
    this.dyn_load_url = dyn_load_url;
    window._IC_BROKER = this;
}

_.extend(IC.Broker.prototype,IC.Events,{
    live: true,
    polling_on: false,
    poll_time: 15000,
    poll_backoff_c: 0,
    poll_time_override: false,
    getLoadPack: function(first_run){
        if(typeof(first_run) === "undefined"){
            first_run = false;
        }
        var first_url = this.load_url + this.md5encodeSubscriptionSet() + "_full.jsonp";
        if(this.load_url){
            $.ajax(first_url,
                {
                    dataType: "jsonp",
                    jsonp: false,
                    cache: true,
                    jsonpCallback: "icCallback",
                    timeout: 3000
                }
            ).done(_.bind(function(msg){
                console.info("Static polling succeeded");
                this.last_message_marker = msg.current_message_marker;
                this.loadPack(msg);
                this.load_promise.resolve(msg);
                if(! this.poll_time_override && this.poll_backoff_c > 0){
                    console.warn("Resetting poll time")
                    this.poll_backoff_c = 0;
                    this.stopPolling();
                    this.startPolling();
                }
            },this)).fail(_.bind(function(msg){
                if(first_run){
                    console.warn("Static polling failed. Falling back to dynamic");
                    this.getLoadPackDyn();
                } else {
                    this.load_promise.reject();
                }
            },this))
            this.load_promise = $.Deferred();
        } else {
            this.load_promise = $.Deferred();
            this.load_promise.resolve();
        }
    },
    getLoadPackDyn: function(){
        var full_url = this.dyn_load_url +"?q=" + this.encodeSubscriptionSet();
        if(this.dyn_load_url){
            return $.ajax(full_url,
                {
                    dataType: "jsonp",
                    jsonp: false,
                    jsonpCallback: "icCallback",
                    timeout: 5000
                }
            ).done(_.bind(function(msg){
                this.last_message_marker = msg.current_message_marker;
                this.loadPack(msg);
                this.load_promise.resolve(msg);
            },this));
        } else {
            return $.Deffered().resolve();
        }
    },
    finalize: function(){
        this.getLoadPack(! this.loaded_once)
        this.load_promise.done(_.bind(function(msg){
            this.loaded_once = true;
            this.pack_sha = msg.sha;
            _(this.consumers).each(function(c){
                c.trigger("first-load");
            });
            if(! this.live){
                return;
            } else if(this.polling_on){
                this.startPolling();
            } else {
                this.startWebsocket();
            }
        },this));
    },
    resetBroker: function(){
        console.warn("Resetting Broker");
        if(this.polling_on){
            clearInterval(this.poll);
        } else {
            this.stopWebsocket();
        }
        setTimeout(_.bind(function(){
            this.finalize();
        },this),5000)
    },
    startPolling: function(){
        var random_time = Math.round(Math.random() * 1000),
            poll_time = this.poll_time + this.poll_backoff_c + random_time;
        this.polling_on = true;
        if(this.poll){
            clearInterval(this.poll);
        }
        this.poll = setInterval(_.bind(function(){
             console.info("Polling for new data on a",poll_time,"ms interval");
             this.getLoadPack()
             this.load_promise.fail(_.bind(function(){
                this.stopPolling();
                console.warn("Polling failed, extending poll interval");
                this.poll_backoff_c = this.poll_backoff_c ? this.poll_backoff_c * 2 : 2000;
                this.startPolling();
             },this));
        },this),poll_time);
    },
    stopPolling: function(){
        this.polling_on = false;
        if(this.poll){
            clearInterval(this.poll);
        }
    },
    environment: "staging",
    startWebsocket: function(){
         var pusher;
         if(this.environment === "production"){
            pusher = new Pusher("a4794403fbe72ed0b016");
         } else {
            pusher = new Pusher("acc76abbc0158fa7511c");
         }
         var channel = pusher.subscribe(this.pack_sha);
        this.pusher = pusher;
        this.channel = channel;
        channel.bind('message', _.bind(function(data) {
          console.info("Message received:",data);
          this.deliverMessage(data);
        },this));
    },
    stopWebsocket: function(){
        this.channel.unbind('message');
        this.pusher.disconnect();
    },
    registerConsumer: function(consumer){
        _(consumer.subscriptions).each(_.bind(function(v,k){
            if(!this.subscriptions[k]){
                this.subscriptions[k] = {};
            }

            _(v).each(_.bind(function(stream){

                if(! this.subscriptions[k][stream]){
                    this.subscriptions[k][stream] = [];
                }

                var current_stream_set = this.subscriptions[k][stream];

                if(! _.find(current_stream_set,function(c){return c.name === consumer.name})){
                    current_stream_set.push(consumer);
                }

            },this));

        },this));
        this.consumers.push(consumer);
    },
    generateSubscriptionSet: function(){
        var sorted_messages = _(this.subscriptions).map(function(messages,stream){
                                    var message_names = _(messages).keys();
                                    if(_.include(message_names, "_ic_all")){
                                        return [stream,["_ic_all"]]
                                    } else {
                                        return [stream,message_names.sort()]
                                    }
                               });
        sorted_messages.sort(function(a,b){return a[0] < b[0] ? -1 : a[0] === b[0] ? 0 : 1});
        return sorted_messages;
    },
    encodeSubscriptionSet: function(){
        var subscription_set = this.generateSubscriptionSet();
        return encodeURIComponent(JSON.stringify(subscription_set));
    },
    md5encodeSubscriptionSet: function(){
        var plaintext = JSON.stringify(this.generateSubscriptionSet());
        console.debug("subscription sets",plaintext)
        return md5(plaintext);
    },
    deliverMessage: function(msg){
        var stream = msg["stream_name"],
            message_type = msg["message_type"],
            merge_strategy = msg["merge_strategy"],
            stream_subscribers = this.subscriptions[stream],
            saturation_promise = $.Deferred(),
            message_subscribers;

        if(! stream_subscribers){return}


        if(merge_strategy === "pointer"){
            $.ajax(msg.pointer_url,
                {
                    dataType: "jsonp",
                    jsonp: false,
                    cache: true,
                    jsonpCallback: msg.pointer_callback,
                    timeout: 3000
                }
            ).done(_.bind(function(m){
                saturation_promise.resolve(m);
            },this));
        } else {
            saturation_promise.resolve(msg);
        }

        saturation_promise.done(_.bind(function(full_msg){
            merge_strategy = full_msg["merge_strategy"];
            if(full_msg.last_message_marker && full_msg.last_message_marker !== this.last_message_marker){
               console.warn("Message Markers Don't Align",full_msg.last_message_marker,this.last_message_marker);
               this.resetBroker();
            } else {
              if(full_msg.message_marker){
                this.last_message_marker = full_msg.message_marker;
              }
              message_subscribers = _.union(stream_subscribers[message_type],stream_subscribers["_ic_all"]);
              message_subscribers = _.compact(message_subscribers);
              _(message_subscribers).each(function(s){
                  s.trigger(stream, full_msg);
                  s.trigger(stream+":" +message_type, full_msg);
                  if(merge_strategy){
                      s.trigger(stream + ":" +message_type + ":" + merge_strategy, full_msg);
                  }
              });
            }
        },this));
    },
    loadPack: function(msg){
        _(msg.message_types).each(_.bind(function(m){
            console.debug("LOAD",m)
            this.deliverMessage(m);
        },this));
    }
})

// Create a consumer with a list of subscriptions, pairs of (stream_name, message_name) OR special (stream_name)
Consumer = IC.Consumer = function(subscriptions,name){
    if(typeof(name) === "undefined"){
        name = "consumer_" + String(Math.random()).slice(2);
    }
    this.name = name;

    this.setupSubs.call(this,subscriptions);
    this.initialize.apply(this, arguments);
}

_.extend(Consumer.prototype,IC.Events,{
    initialize: function(){},
    setupSubs: function(subs){
        this.subscriptions = {};
        if(typeof(subs) === "string"){
            // Consumer is subscribing to all messages from a particular stream
            this.subscriptions[subs] = ["_ic_all"];
        } else if (_.isObject(subs) && ! _.isArray(subs)){
            // Consumer is subscribing to a list of subscriptions
            _.each(subs,_.bind(function(v,k){
                if(typeof(v) == "string"){
                    // Subscription is to a single message in a stream
                    this.subscriptions[k] = [v]
                } else if (_.isArray(v) && v.length === 0){
                    // Subscription is to all messages in a stream
                    this.subscriptions[k] = ["_ic_all"]
                } else if (_.isArray(v) && v.length > 0){
                    // Subscription is to all messages in a stream
                    this.subscriptions[k] = v
                } else {
                    throw "Invalid subscription: " + JSON.stringify(s);
                }
             },this));
        } else if (typeof(subs) === "undefined") {
            // Consumer is not subscribing to any streams or messages
        } else {
            throw "Invalid subscription: " + JSON.stringify(subs);
        }
    },
    register: function(broker){
        broker.registerConsumer(this);
        this.trigger("post-register");
    },
    render: function(){}
})

IC.extend = function(protoProps, staticProps) {//{{{
  var parent = this;
  var child;

  // The constructor function for the new subclass is either defined by you
  // (the "constructor" property in your `extend` definition), or defaulted
  // by us to simply call the parent's constructor.
  if (protoProps && _.has(protoProps, 'constructor')) {
    child = protoProps.constructor;
  } else {
    child = function() {
      return parent.apply(this, arguments);
    };
  }

  // Add static properties to the constructor function, if supplied.
  _.extend(child, parent, staticProps);

  // Set the prototype chain to inherit from `parent`, without calling
  // `parent`'s constructor function.
  var Surrogate = function() {
      this.constructor = child;
    };
  Surrogate.prototype = parent.prototype;
  child.prototype = new Surrogate;

  // Add prototype properties (instance properties) to the subclass,
  // if supplied.
  if (protoProps) _.extend(child.prototype, protoProps);

  // Set a convenience property in case the parent's prototype is needed
  // later.
  child.__super__ = parent.prototype;

  return child;
};

IC.Consumer.extend = IC.extend//}}}

IC.SingletonConsumer = IC.Consumer.extend({
    initialize: function(subscriptions){
        this.value = 0;
        this.stream_name = _(subscriptions).keys()[0];
        this.message_type = subscriptions[this.stream_name];
    },
    bindActions : function(){
        this.on(this.stream_name + ":" + this.message_type + ":" + "update",_.bind(function(msg){
            this.last_value = this.value ? _.clone(this.value) : {};
            this.value = msg.data;
            this.render();
        },this))
        this.on(this.stream_name + ":" + this.message_type + ":" + "load",_.bind(function(msg){
            if(msg.data){
                this.last_value = this.value ? _.clone(this.value) : {};
                this.value = msg.data[0];
                this.render();
            }
        },this))
    },
    hasChanged: function(attr){
        if (! this.last_value || _.isEmpty(this.last_value)) { return false; }
        var levels = attr.split("."),
            value = this.value,
            last_value = this.last_value,
            m,index;
        _(levels).each(function(l){
            if(m = l.match(/(.+?)\[(.+?)\]/)){
                index = m[2];
                value = value[m[1]][index];
                last_value = last_value[m[1]][index];
            } else {
                value = value[l];
                last_value = last_value[l];
            }
        });
        return value !== last_value;
    }
})

IC.makeSingletonConsumer = function(stream,message_type){
    var subscriptions = {}, value;
    subscriptions[stream] = message_type;
    value = new IC.SingletonConsumer(subscriptions);
    value.bindActions();
    return value;
}

IC.CollectionConsumer = IC.Consumer.extend({
    initialize: function(subscriptions){
        var filter;
        this.collection = new PourOver.Collection();
        this.view = new PourOver.View("default_ic_view",this.collection);
        filter = PourOver.makeExactFilter("hidden",[true,false,undefined])
        this.collection.addFilters(filter);
        this.collection.filters.hidden.query([false,undefined]);
        this.stream_name = _(subscriptions).keys()[0];
        this.message_type = subscriptions[this.stream_name];
    },
    bindActions : function(){
        this.on(this.stream_name + ":" + this.message_type + ":" + "update",_.bind(function(msg){
            var guid = msg.data.guid,
                items = this.collection.getBy("guid",guid),item;
            if(items && items.length > 0){
                item = items[0]
                this.collection.updateAttributes(item.cid,msg.data);
            } else {
                this.collection.addItems(msg.data);
            }
        },this));
        this.on(this.stream_name + ":" + this.message_type + ":" + "load",_.bind(function(msg){
            this.collection.batchLoadItems(msg.data);
        },this));
    }
})

IC.makeCollectionConsumer = function(stream,message_type){
    var subscriptions = {}, collection;
    subscriptions[stream] = message_type;
    collection = new IC.CollectionConsumer(subscriptions);
    collection.bindActions();
    return collection;
};
define("lib/ic", function(){});

/*!
 * jQuery-ajaxTransport-XDomainRequest - v1.0.1 - 2013-10-17
 * https://github.com/MoonScript/jQuery-ajaxTransport-XDomainRequest
 * Copyright (c) 2013 Jason Moon (@JSONMOON)
 * Licensed MIT (/blob/master/LICENSE.txt)
 */
 define('lib/jquery-xdomain',["jquery/nyt"], function(jQuery) {
(function($){if(!$.support.cors&&$.ajaxTransport&&window.XDomainRequest){var n=/^https?:\/\//i;var o=/^get|post$/i;var p=new RegExp('^'+location.protocol,'i');var q=/text\/html/i;var r=/\/json/i;var s=/\/xml/i;$.ajaxTransport('* text html xml json',function(i,j,k){if(i.crossDomain&&i.async&&o.test(i.type)&&n.test(i.url)&&p.test(i.url)){var l=null;var m=(j.dataType||'').toLowerCase();return{send:function(f,g){l=new XDomainRequest();if(/^\d+$/.test(j.timeout)){l.timeout=j.timeout}l.ontimeout=function(){g(500,'timeout')};l.onload=function(){var a='Content-Length: '+l.responseText.length+'\r\nContent-Type: '+l.contentType;var b={code:200,message:'success'};var c={text:l.responseText};try{if(m==='html'||q.test(l.contentType)){c.html=l.responseText}else if(m==='json'||(m!=='text'&&r.test(l.contentType))){try{c.json=$.parseJSON(l.responseText)}catch(e){b.code=500;b.message='parseerror'}}else if(m==='xml'||(m!=='text'&&s.test(l.contentType))){var d=new ActiveXObject('Microsoft.XMLDOM');d.async=false;try{d.loadXML(l.responseText)}catch(e){d=undefined}if(!d||!d.documentElement||d.getElementsByTagName('parsererror').length){b.code=500;b.message='parseerror';throw'Invalid XML: '+l.responseText;}c.xml=d}}catch(parseMessage){throw parseMessage;}finally{g(b.code,b.message,c,a)}};l.onprogress=function(){};l.onerror=function(){g(500,'error',{text:l.responseText})};var h='';if(j.data){h=($.type(j.data)==='string')?j.data:$.param(j.data)}l.open(i.type,i.url);l.send(h)},abort:function(){if(l){l.abort()}}}}})}})(jQuery);
});
require(['foundation/main'], function() {

require([
  'jquery/nyt',
  'underscore/nyt'
], function($, _) {

  // TEMPLATES ASSUME A GLOBAL  UNDERSCORE...
  window._ = _;
  window.$ = $;

  require([
    'build/templates',
    'lib/pourover',
    'lib/pusher.min',
    'lib/ic',
    'lib/jquery-xdomain'
    ], function(templates, PourOver, Pusher) {


    var loadedAnalytics = false,
        initializedSockets = false,
        isIE8 = $("html").hasClass('lt-ie9'),
        broker = new IC.Broker(data.race.ic_url, data.race.ic_state_url),
        election_date_str = 'election_' + data.race.election_date;

    if (data.race.environment) broker.environment = data.race.environment;

    Pusher.log = function(message) {
      if (window.console && window.console.log) {
        window.console.info(message);
      }
    };


    function initializeSockets() {

      if (initializedSockets || !data.race.enable_websockets) return;

      // Races consumer is collection of results
      var races_consumer = IC.makeCollectionConsumer(election_date_str, data.race.state_abbr);
      // console.log(races_consumer);
      races_consumer.view.on('update collection-change', function(){
        races_consumer.view.render();
      });

      races_consumer.view.render = _.debounce(function(){
        var updates = races_consumer.view.getCurrentItems();
        // console.log("Websockets : Updates : ", updates);
        mergeUpdates(updates);
      },50);

      var time_consumer = IC.makeSingletonConsumer(election_date_str, "loader");

      // Singleton consumers are simple so we call render automatically everytime they are updated
      time_consumer.render = function(){
        // console.log("Websockets : Time Consumer : ", time_consumer);
        if (time_consumer.value) $(".eln-timestamp").text(time_consumer.value.time_display);
      };

      var visibility_consumer = IC.makeCollectionConsumer(election_date_str, "visibility");
        visibility_consumer.view.on('update collection-change', function(){
        visibility_consumer.view.render();
      });
      // Singleton consumers are simple so we call render automatically everytime they are updated
      visibility_consumer.view.render = function(){
        var items = visibility_consumer.view.getCurrentItems();
        var state = _.findWhere(items, { guid: data.race.state_abbr });
        if (data.results) {
          data.results = state.report_results;
          data.results = state.loading;
        }
      };

      races_consumer.register(broker);
      time_consumer.register(broker);
      visibility_consumer.register(broker);
      broker.finalize();
      initializedSockets = true;
    }

    update();

    function update() {
      $.getJSON($("#eln-primary-page").attr("data-url"), render);
    }

    // Combine websockets with existing data
    function mergeUpdates(updates) {
      if (!data.result_groups) return false;
      // console.log("Updates", updates)
      _.each(data.result_groups, function(group) {
        _.each(group.races, function(race) {
          var primaries = _.pick(race, "DEM", "REP", "OTH");
          _.each(primaries, function(primary) {
            var update = _.findWhere(updates, { guid: primary.id });
            if (!update) return;
            if (update.called == "W") {
              primary.called = true;
            } else if (update.called == "R") {
              primary.runoff_declared = true;
            }
            _.each(update.results, function(result) {
              var ap_candidate_id = result[0],
                  vote_count_display = numberWithCommas(result[1]+''),
                  pct_display = result[2],
                  outcome = result[3];
              var candidate = _.findWhere(primary.results, { ap_candidate_id: ap_candidate_id + '_' + data.race.election_date });
              if (!candidate) return;
              candidate.vote_count = result[1];
              candidate.vote_count_display = vote_count_display;
              candidate.vote_pct_display = pct_display;
              if (outcome == "W") {
                candidate.nyt_winner = true;
              } else if (outcome == "R") {
                candidate.advanced_to_runoff = true;
              }
              if (update.report != "uncontested") {
                primary.precincts_reporting_display = update.report;
              }
            }); // end update.results

            primary.results = _.sortBy(primary.results, function(result) {
              return -result.vote_count;
            });
            // console.log(primary.results);
          }); // end primaries
        }); // end races
      }); // end result_groups
      render();
    }

    function load() {
      $.getJSON($("#eln-primary-page").attr("data-url"), render);
    }

    function render(results) {

      if (results) data.results = results;

      if (!data.result_groups) {

        // Transform API data into the structure we want
        data.result_groups = _.chain(data.results.races)
                                .flatten()
                                .map(function(races) {

                                  var keys = _.keys(races),
                                      key = keys[0],
                                      id = races[key].id.replace('-' + key.toLowerCase(), '').replace('-open', ''),
                                      settings = data.race_settings[id] || {},
                                      sample_race = races.DEM || races.REP || races.OTH,
                                      branch = data.branches[sample_race.branch] || {};

                                  races.info = { simple_id: id };
                                  races.category = settings.category || branch.category || races[key].branch;
                                  races.index = settings.index || branch.index || 99;
                                  if (races.category == 'what-to-watch') {
                                    races.index += 100;
                                  } else if (races.category == 'statewide-races') {
                                    races.index += 200;
                                  } else if (races.category == 'initiative') {
                                    races.index += 300;
                                  } else {
                                    races.index += 400;
                                  }
                                  races.settings = {};
                                  _.extend(races.settings, data.race_settings[id]);

                                  if (!races.settings.title) {
                                    if (sample_race.branch == 'house'  && (races.category == 'featured-races' || races.category == 'what-to-watch') ) {
                                      races.settings.title = data.dictionary[sample_race.branch] + ' ' + sample_race.race_title;
                                    } else if (sample_race.branch == 'house' || sample_race.branch == 'house-special') {
                                      races.settings.title = sample_race.race_title;
                                    } else {
                                      races.settings.title = data.dictionary[sample_race.branch] || sample_race.race_title;
                                    }
                                  }
                                  if (sample_race.branch == 'initiative' || sample_race.branch == 'supreme-court') {
                                    races.settings.parties = "OTH";
                                  }
                                  if (races.settings.colors) {
                                    _.each(races.settings.colors, function(colors, party_name) {
                                      _.each(races[party_name].results, function(candidate) {
                                        var color = colors[candidate.last_name.toLowerCase()];
                                        if (color) {
                                          candidate._swatch_color = color;
                                        }
                                      });
                                    });
                                  }
                                  _.each(races, function(race) {
                                    race.report_votes = data.results.report_votes;
                                  });
                                  return races;
                                })
                                .sortBy("index")
                                .groupBy("category")
                                .map(function(races) {
                                  var category = races[0].category;
                                  return {
                                    races: races,
                                    category: category,
                                    title: data.dictionary[category] || category,
                                    whatToWatch: category == 'what-to-watch',
                                    show_bars: data.results.state_id == "CA"
                                  };
                                })
                                .indexBy("category")
                                .value();

        // RENDER TIMESTAMP
        var css = data.results.report_votes && data.results.loading ? 'eln-votes-live' : '' ;
        var timestamp = data.results.report_votes ? data.results.updated_at_display : data.results.poll_details;
        $(".eln-timestamp").html(timestamp).addClass(css);

      }

      // console.log("Rendering : Result Groups : ", data.result_groups);

      // RENDER TEMPLATE
      var html = templates['jst/page_content']({ data: data, templates: templates, options: {} });
      $("#eln-primary-page").html(html);


      $(".eln-expander").on("click", function() {
        $(this).parents(".eln-race-container").toggleClass("eln-expanded");
      })

      loadAnalytics();

    }


    function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function loadAnalytics() {

      if (loadedAnalytics) {
        return;
      }

      loadedAnalytics = true;

      initializeMaps();

      initializeSockets();

      $("footer").removeClass("eln-hide");

      var canonical = document.querySelector("link[rel='canonical']").href,
          pageview = ['_trackPageview'];

      if (canonical) {
        var a = document.createElement("a");
        a.href = canonical;
        if (a.pathname != document.location.pathname) pageview.push(a.pathname);
      }

      _gaq.push(pageview);

      require(['//www.google-analytics.com/ga.js']);
    }

    function initializeMaps() {

      if (isIE8) return;

      require([
          NYTG_ASSETS + 'state_map.js'
        ], function() {

          require(['' + 'js/state_map'], function(state_map) {

            $('.eln-state-map').each(function() {

              var element = $(this);

              $.getJSON(element.attr('data-map-data-url'), function(results) {

                var width = element.attr('data-map-width'),
                    height = element.attr('data-map-height'),
                    topojsonFile = element.attr('data-topojson-file'),
                    colors = element.attr('data-map-colors') ? JSON.parse(element.attr('data-map-colors')) : false,
                    ratio = height / width;

                if (element.width() < width) {
                  width = element.width();
                  height = width * ratio;
                }

                var opts = {
                  width: width,
                  height: height,
                  maxRows: 4,
                  candColorIndex: colors
                };

                if (topojsonFile) {
                  opts.topojsonFile = topojsonFile;
                }

                var wrapper = element
                  .css({
                    width: opts.width + "px",
                    height: opts.height + "px"
                  })
                  .addClass("g-map");

                var map = state_map.create(element.get(0), element.attr('data-map-state'), opts);
                map.update(results);

                // var moveme = element.attr('data-moveme') == 'yes';
                if ($("#va-house-7-results svg").length && $("#va-house-7-outline svg").length) {
                  $("#va-house-7-results svg").attr("class", "va-house-7-results-svg")
                  $("#va-house-7-outline svg").appendTo("#va-house-7-results").attr('class', 'va-house-7-outline-svg')
                  $("#va-house-7-outline").remove();
                  $(".va-house-7-results-svg")[0].parentNode.appendChild($(".va-house-7-results-svg")[0])
                }

               }); // end d3.json()

            }); // end maps

          })


      }); // end state_map.js require

    }

  }); // end require


}); // end jquery/underscore

});
define("js/page", function(){});

	</script>



</div>


        <footer class="story-footer eln-hide">

                <div class="story-info interactive-credit">
            <p></p>
        </div>

                <div class="story-info interactive-source">
            <p>Source: Election results and U.S. House candidate names from The Associated Press</p>
        </div>

                <div class="story-notes interactive-notes">
            <p> </p>
        </div>

            </footer>

    </article>                <div class="search-overlay"></div>
        </main><!-- close main -->

        <footer id="page-footer" class="page-footer" role="contentinfo">
    <nav>
         <ul>
             <li>
                <a href="//www.nytco.com" itemprop="copyrightNotice">
                    &copy; <span itemprop="copyrightYear">2014</span><span itemprop="copyrightHolder provider sourceOrganization" itemscope itemtype="//schema.org/Organization" itemid="//www.nytimes.com"><span itemprop="name"> The New York Times Company</span><meta itemprop="tickerSymbol" content="NYSE NYT"/></span>
                </a>
            </li>
            <li><a href="//www.nytimes.com/ref/membercenter/help/infoservdirectory.html">Contact Us</a></li>
            <li><a href="//www.nytco.com/careers">Work With Us</a></li>
            <li><a href="//www.nytimes.whsites.net/mediakit">Advertise</a></li>
            <li><a href="//www.nytimes.com/content/help/rights/privacy/policy/privacy-policy.html#pp">Your Ad Choices</a></li>
            <li><a href="//www.nytimes.com/privacy">Privacy</a></li>
            <li><a href="//www.nytimes.com/ref/membercenter/help/agree.html" itemprop="usageTerms">Terms of Service</a></li>
            <li class="last-item"><a href="//www.nytimes.com/content/help/rights/sale/terms-of-sale.html">Terms of Sale</a></li>
         </ul>
    </nav>
    <nav class="last-nav">
        <ul>
            <li><a href="//spiderbites.nytimes.com">Site Map</a></li>
            <li><a href="//www.nytimes.com/membercenter/sitehelp.html">Help</a></li>
            <li><a href="https://myaccount.nytimes.com/membercenter/feedback.html">Site Feedback</a></li>
            <li class="last-item"><a href="//www.nytimes.com/subscriptions/Multiproduct/lp5558.html?campaignId=37WXW">Subscriptions</a></li>
        </ul>
    </nav>
</footer>    </div><!-- close shell -->
<script>
require(['foundation/main'], function () {
    require(['interactive/main']);
    require(['jquery/nyt', 'foundation/views/page-manager'], function ($, pageManager) {
        $(document).ready(function () {
            require(['https://static01.nyt.com/bi/js/tagx/tagx.js'], function () {
                pageManager.trackingFireEventQueue();
            });
        });
    });
});
</script>

<link rel="stylesheet" href="https://static01.nyt.com/newsgraphics/2014/elections/5952c9a6ff417f4bac9b523052009ff2933e8ee3/typeface.css">

</body>
</html>

